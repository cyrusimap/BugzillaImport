<?xml version="1.0" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.cyrusimap.org/bugzilla.dtd">

<bugzilla version="3.2.5.1-2"
          urlbase="https://bugzilla.cyrusimap.org/"
          maintainer="Dave McMurtrie &lt;dave64@andrew.cmu.edu&gt;"
>

    <bug>
          <bug_id>3838</bug_id>
          
          <creation_ts>2014-01-23 06:35 EDT</creation_ts>
          <short_desc>cvt_cyrusdb segfaults</short_desc>
          <delta_ts>2014-02-13 03:17:22 EDT</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>1</classification_id>
          <classification>Unclassified</classification>
          <product>Cyrus IMAP</product>
          <component>lib</component>
          <version>2.4.17</version>
          <rep_platform>PC</rep_platform>
          <op_sys>Linux</op_sys>
          <bug_status>NEW</bug_status>
          
          
          
          
          
          <priority>P3</priority>
          <bug_severity>bug</bug_severity>
          <target_milestone>2.4-next</target_milestone>
          
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Deniss Gaplevsky">slim@inbox.lv</reporter>
          <assigned_to name="Bron Gondwana">brong@fastmail.fm</assigned_to>
          <cc>dilyan.palauzov@aegee.org</cc>
          <qa_contact name="The Cyrus Bugzilla List">cyrus-bugzilla@lists.andrew.cmu.edu</qa_contact>

      

      

      
          <long_desc isprivate="0">
            <who name="Deniss Gaplevsky">slim@inbox.lv</who>
            <bug_when>2014-01-23 06:35:39 EDT</bug_when>
            <thetext>cvt_cyrusdb segfaults in cyrusdb_quotalegacy.c:818 - pointer not checked before writing.

Core was generated by `./cvt_cyrusdb /var/imap/quotas.flat flat /var/imap/quota quotalegacy&apos;.
Program terminated with signal 11, Segmentation fault.
#0  0x000000000044d406 in mystore (db=0x771ca0, key=0x372739da000 &lt;Address 0x372739da000 out of bounds&gt;, keylen=19, 
    data=0x372739da014 &lt;Address 0x372739da014 out of bounds&gt;, datalen=8, tid=0x0, overwrite=1) at cyrusdb_quotalegacy.c:818
818             *p = &apos;\n&apos;;

in code:

	buf = xmalloc(datalen+1);
	memcpy(buf, data, datalen);
	/* convert separating SP to \n */
	p = memchr(buf, &apos; &apos;, datalen);
	*p = &apos;\n&apos;;
	/* add a terminating \n */
	buf[datalen] = &apos;\n&apos;;

already fixed in 2.5, need to be backported to 2.4</thetext>
          </long_desc>
          <long_desc isprivate="0">
            <who name="Dilyan Palauzov">dilyan.palauzov@aegee.org</who>
            <bug_when>2014-02-12 18:09:18 EDT</bug_when>
            <thetext>Can you provide an input file, that leads to the segfault?</thetext>
          </long_desc>
          <long_desc isprivate="0">
            <who name="Dilyan Palauzov">dilyan.palauzov@aegee.org</who>
            <bug_when>2014-02-12 18:18:12 EDT</bug_when>
            <thetext>On my system the line &quot;*p = &apos;\n&apos;;&quot; is 808, in your backtrace it is 818.

Does this patch solve the problem for you?

diff --git a/lib/cyrusdb_quotalegacy.c b/lib/cyrusdb_quotalegacy.c
index f94b1fd..87c4e89 100644
--- a/lib/cyrusdb_quotalegacy.c
+++ b/lib/cyrusdb_quotalegacy.c
@@ -805,7 +805,7 @@ static int mystore(struct db *db,
        memcpy(buf, data, datalen);
        /* convert separating SP to \n */
        p = memchr(buf, &apos; &apos;, datalen);
-       *p = &apos;\n&apos;;
+       if (p) *p = &apos;\n&apos;;
        /* add a terminating \n */
        buf[datalen] = &apos;\n&apos;;</thetext>
          </long_desc>
          <long_desc isprivate="0">
            <who name="Deniss Gaplevsky">slim@inbox.lv</who>
            <bug_when>2014-02-13 03:17:22 EDT</bug_when>
            <thetext>the patch fixes the segfault.

but corrupted data still pushed to new backend.
I got corrupted records in quotas.flat - there was no delimiter space as required between account and quota&apos;s value for some rows.</thetext>
          </long_desc>
      
      

    </bug>

</bugzilla>