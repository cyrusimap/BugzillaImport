<?xml version="1.0" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.cyrusimap.org/bugzilla.dtd">

<bugzilla version="3.2.5.1-2"
          urlbase="https://bugzilla.cyrusimap.org/"
          maintainer="Dave McMurtrie &lt;dave64@andrew.cmu.edu&gt;"
>

    <bug>
          <bug_id>2255</bug_id>
          
          <creation_ts>2003-10-13 15:57 EDT</creation_ts>
          <short_desc>Add mutexes around calls to MIT Kerberos</short_desc>
          <delta_ts>2010-10-25 18:46:33 EDT</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>1</classification_id>
          <classification>Unclassified</classification>
          <product>Cyrus SASL</product>
          <component>gssapi</component>
          <version>2.1.x</version>
          <rep_platform>Other</rep_platform>
          <op_sys>other</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>FIXED</resolution>
          
          
          
          
          <priority>P2</priority>
          <bug_severity>bug</bug_severity>
          <target_milestone>Future</target_milestone>
          
          
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Simon Wilkinson">simon@sxw.org.uk</reporter>
          <assigned_to name="Rob Siemborski">rjs3@andrew.cmu.edu</assigned_to>
          
          <qa_contact name="The Cyrus Bugzilla List">cyrus-bugzilla@lists.andrew.cmu.edu</qa_contact>

      

      

      
          <long_desc isprivate="0">
            <who name="Simon Wilkinson">simon@sxw.org.uk</who>
            <bug_when>2003-10-13 15:57:13 EDT</bug_when>
            <thetext>The MIT Kerberos library isn&apos;t thread safe. By adding mutexes around all calls
into the GSS-API, its possible to allow MIT Kerberos to be used safely from
multi-threaded applications.</thetext>
          </long_desc>
          <long_desc isprivate="0">
            <who name="Simon Wilkinson">simon@sxw.org.uk</who>
            <bug_when>2003-10-13 16:03:10 EDT</bug_when>
            <thetext>Created an attachment (id=232)
Patch to add mutexes around all calls into GSSAPI

This patch adds a mutex around every call into the GSSAPI.

It&apos;s necessary to protect every call, due to the fact that MIT&apos;s memory
management
code is not thread safe, so even gss_release_buffer() has to be protected.
</thetext>
          </long_desc>
          <long_desc isprivate="0">
            <who name="Rob Siemborski">rjs3@andrew.cmu.edu</who>
            <bug_when>2003-10-13 16:05:30 EDT</bug_when>
            <thetext>Derrick claims that this is correct (wondering where we got the idea that GSS
libraries were required to be thread safe from)

FWIW, heimdal is thread safe.</thetext>
          </long_desc>
          <long_desc isprivate="0">
            <who name="Alexey Melnikov">Alexey.Melnikov@isode.com</who>
            <bug_when>2003-10-20 06:48:57 EDT</bug_when>
            <thetext>FYI: CyberSafe is thread safe as well.

Mutex protection should only be enabled for not thread safe versions of Kerberos.
</thetext>
          </long_desc>
          <long_desc isprivate="0">
            <who name="Quanah Gibson-Mount">quanah@stanford.edu</who>
            <bug_when>2003-10-21 18:04:39 EDT</bug_when>
            <thetext>I have an additional concern with this patch set.  It would be extremely 
helpful to make it so this patch set can be flagged off.  I&apos;m currently in 
contact with the MIT Kerberos 5 developers, and the goal is to make MIT Kerb5 
thread safe.  I won&apos;t be able to test that in newer versions of cyrus-sasl 
unless I can ensure that this patchset is disabled.

Regards,
Quanah Gibson-Mount
Stanford University</thetext>
          </long_desc>
          <long_desc isprivate="0">
            <who name="Rob Siemborski">rjs3@andrew.cmu.edu</who>
            <bug_when>2004-07-14 15:55:02 EDT</bug_when>
            <thetext>I agree.

Actually, we&apos;re currently locally seeing an issue where it appears that heimdal
may not be thread safe, so it&apos;d be nice to have it flagged ON as well.

So, the way this would work is that there is an enable/disable gssapi mutex
configure option that gets some reasonable default based off the GSSAPI type.</thetext>
          </long_desc>
          <long_desc isprivate="0">
            <who name="Rob Siemborski">rjs3@andrew.cmu.edu</who>
            <bug_when>2004-07-15 13:17:39 EDT</bug_when>
            <thetext>Created an attachment (id=295)
cleaned up patch for current SASL

new gssapi.c patch -- also needs fixes to configure.in before it is fully
functional (to set GSS_USE_MUTEXES)</thetext>
          </long_desc>
          <long_desc isprivate="0">
            <who name="Simon Wilkinson">simon@sxw.org.uk</who>
            <bug_when>2004-07-15 13:26:52 EDT</bug_when>
            <thetext>There&apos;s a bug in my original patch, which has been carried over into the revised
one. 

gss_mutex shouldn&apos;t be freed in common_mech_dispose. The current behaviour only
provides the mutex for the first call into the library, then throws it away. Ooops.</thetext>
          </long_desc>
          <long_desc isprivate="0">
            <who name="Rob Siemborski">rjs3@andrew.cmu.edu</who>
            <bug_when>2004-07-15 13:30:31 EDT</bug_when>
            <thetext>yes, you&apos;re right, it should be in a mech_free call.

i&apos;ll have a fixed patch up shortly.</thetext>
          </long_desc>
          <long_desc isprivate="0">
            <who name="Rob Siemborski">rjs3@andrew.cmu.edu</who>
            <bug_when>2004-07-15 13:32:28 EDT</bug_when>
            <thetext>Created an attachment (id=296)
corrected cleaned up patch, with configure.in changes

patch updated to correct above bug, also now include configure.in changes.</thetext>
          </long_desc>
          <long_desc isprivate="0">
            <who name="Rob Siemborski">rjs3@andrew.cmu.edu</who>
            <bug_when>2004-07-15 16:33:28 EDT</bug_when>
            <thetext>code is committed.</thetext>
          </long_desc>
          <long_desc isprivate="0">
            <who name="Quanah Gibson-Mount">quanah@stanford.edu</who>
            <bug_when>2004-08-02 14:54:55 EDT</bug_when>
            <thetext>This patch is not really necessary, as the new MIT kerberos release in CVS has 
fixed its thread calls.  I suggest this patch be made available, but *always* 
left disabled by default.</thetext>
          </long_desc>
      
          <attachment
              isobsolete="1"
              ispatch="1"
              isprivate="0"
          >
            <attachid>232</attachid>
            <date>2003-10-13 16:03 EDT</date>
            <desc>Patch to add mutexes around all calls into GSSAPI</desc>
            <filename>cyrus-sasl-2.1.15-gssapimutex.patch</filename>
            <type>text/plain</type>
            <size>20842</size>
            <attacher>simon@sxw.org.uk</attacher>
            
              <data encoding="base64">LS0tIHBsdWdpbnMvZ3NzYXBpLmMJMjAwMy0wNy0wMiAxNDoxMzo0Mi4wMDAwMDAwMDAgKzAxMDAK
KysrIHBsdWdpbnMvZ3NzYXBpLmMubXV0ZXgJMjAwMy0wNy0xNyAxMzo1Njo1My4wMDAwMDAwMDAg
KzAxMDAKQEAgLTEwNiw2ICsxMDYsMTggQEAKICAqIEltcG9ydGFudCBjb250cmlidXRpb25zIGZy
b20gU2FtIEhhcnRtYW4gPGhhcnRtYW5zQGZ1bmRzeHByZXNzLmNvbT4uCiAgKi8KIAorI2RlZmlu
ZSBHU1NfTE9DS19NVVRFWCh1dGlscykgIFwKKyAgICBpZigoKHNhc2xfdXRpbHNfdCAqKSh1dGls
cykpLT5tdXRleF9sb2NrKGdzc19tdXRleCkgIT0gMCkgeyBcCisgICAgICAgcmV0dXJuIFNBU0xf
RkFJTDsgXAorICAgIH0KKworI2RlZmluZSBHU1NfVU5MT0NLX01VVEVYKHV0aWxzKSBcCisgICAg
aWYoKChzYXNsX3V0aWxzX3QgKikodXRpbHMpKS0+bXV0ZXhfdW5sb2NrKGdzc19tdXRleCkgIT0g
MCkgeyBcCisgICAgICAgIHJldHVybiBTQVNMX0ZBSUw7IFwKKyAgICB9CisKK3N0YXRpYyB2b2lk
ICpnc3NfbXV0ZXggPSBOVUxMOworCiB0eXBlZGVmIHN0cnVjdCBjb250ZXh0IHsKICAgICBpbnQg
c3RhdGU7CiAgICAgCkBAIC0xNDcsNyArMTU5LDcgQEAKICAgICBTQVNMX0dTU0FQSV9TVEFURV9B
VVRIRU5USUNBVEVEID0gNAogfTsKIAotc3RhdGljIHZvaWQKK3N0YXRpYyBpbnQKIHNhc2xfZ3Nz
X3NldGVycm9yKGNvbnN0IHNhc2xfdXRpbHNfdCAqdXRpbHMsIE9NX3VpbnQzMiBtYWosIE9NX3Vp
bnQzMiBtaW4pCiB7CiAgICAgT01fdWludDMyIG1hal9zdGF0LCBtaW5fc3RhdDsKQEAgLTE1OCwy
NSArMTcwLDI3IEBACiAgICAgc2l6ZV90IGxlbiwgY3VybGVuID0gMDsKICAgICBjb25zdCBjaGFy
IHByZWZpeFtdID0gIkdTU0FQSSBFcnJvcjogIjsKICAgICAKLSAgICBpZighdXRpbHMpIHJldHVy
bjsKKyAgICBpZighdXRpbHMpIHJldHVybiBTQVNMX09LOwogICAgIAogICAgIGxlbiA9IHNpemVv
ZihwcmVmaXgpOwogICAgIHJldCA9IF9wbHVnX2J1Zl9hbGxvYyh1dGlscywgJm91dCwgJmN1cmxl
biwgMjU2KTsKLSAgICBpZihyZXQgIT0gU0FTTF9PSykgcmV0dXJuOworICAgIGlmKHJldCAhPSBT
QVNMX09LKSByZXR1cm4gU0FTTF9PSzsKICAgICAKICAgICBzdHJjcHkob3V0LCBwcmVmaXgpOwog
ICAgIAogICAgIG1zZ19jdHggPSAwOwogICAgIHdoaWxlICgxKSB7CisJR1NTX0xPQ0tfTVVURVgo
dXRpbHMpOwogCW1hal9zdGF0ID0gZ3NzX2Rpc3BsYXlfc3RhdHVzKCZtaW5fc3RhdCwgbWFqLAog
CQkJCSAgICAgIEdTU19DX0dTU19DT0RFLCBHU1NfQ19OVUxMX09JRCwKIAkJCQkgICAgICAmbXNn
X2N0eCwgJm1zZyk7CisJR1NTX1VOTE9DS19NVVRFWCh1dGlscyk7CiAJaWYoR1NTX0VSUk9SKG1h
al9zdGF0KSkgewogCSAgICB1dGlscy0+c2V0ZXJyb3IodXRpbHMtPmNvbm4sIDAsCiAJCQkgICAg
IkdTU0FQSSBGYWlsdXJlICIKIAkJCSAgICAiKGNvdWxkIG5vdCBnZXQgbWFqb3IgZXJyb3IgbWVz
c2FnZSkiKTsKIAkgICAgdXRpbHMtPmZyZWUob3V0KTsKLQkgICAgcmV0dXJuOworCSAgICByZXR1
cm4gU0FTTF9PSzsKIAl9CiAJCiAJbGVuICs9IGxlbiArIG1zZy5sZW5ndGg7CkBAIC0xODQsMTIg
KzE5OCwxNCBAQAogCQogCWlmKHJldCAhPSBTQVNMX09LKSB7CiAJICAgIHV0aWxzLT5mcmVlKG91
dCk7Ci0JICAgIHJldHVybjsKKwkgICAgcmV0dXJuIFNBU0xfT0s7CiAJfQogCQogCXN0cmNhdChv
dXQsIG1zZy52YWx1ZSk7CiAJCisJR1NTX0xPQ0tfTVVURVgodXRpbHMpOwogCWdzc19yZWxlYXNl
X2J1ZmZlcigmbWluX3N0YXQsICZtc2cpOworCUdTU19VTkxPQ0tfTVVURVgodXRpbHMpOwogCQog
CWlmICghbXNnX2N0eCkKIAkgICAgYnJlYWs7CkBAIC0yMDEsMjIgKzIxNywyNCBAQAogICAgIHJl
dCA9IF9wbHVnX2J1Zl9hbGxvYyh1dGlscywgJm91dCwgJmN1cmxlbiwgbGVuKTsKICAgICBpZihy
ZXQgIT0gU0FTTF9PSykgewogCXV0aWxzLT5mcmVlKG91dCk7Ci0JcmV0dXJuOworCXJldHVybiBT
QVNMX09LOwogICAgIH0KICAgICAKICAgICBzdHJjYXQob3V0LCAiICgiKTsKICAgICAKICAgICBt
c2dfY3R4ID0gMDsKICAgICB3aGlsZSAoMSkgeworCUdTU19MT0NLX01VVEVYKHV0aWxzKTsKIAlt
YWpfc3RhdCA9IGdzc19kaXNwbGF5X3N0YXR1cygmbWluX3N0YXQsIG1pbiwKIAkJCQkgICAgICBH
U1NfQ19NRUNIX0NPREUsIEdTU19DX05VTExfT0lELAogCQkJCSAgICAgICZtc2dfY3R4LCAmbXNn
KTsKKwlHU1NfVU5MT0NLX01VVEVYKHV0aWxzKTsKIAlpZihHU1NfRVJST1IobWFqX3N0YXQpKSB7
CiAJICAgIHV0aWxzLT5zZXRlcnJvcih1dGlscy0+Y29ubiwgMCwKIAkJCSAgICAiR1NTQVBJIEZh
aWx1cmUgIgogCQkJICAgICIoY291bGQgbm90IGdldCBtaW5vciBlcnJvciBtZXNzYWdlKSIpOwog
CSAgICB1dGlscy0+ZnJlZShvdXQpOwotCSAgICByZXR1cm47CisJICAgIHJldHVybiBTQVNMX09L
OwogCX0KIAkKIAlsZW4gKz0gbGVuICsgbXNnLmxlbmd0aDsKQEAgLTIyNCwxMiArMjQyLDE0IEBA
CiAJCiAJaWYocmV0ICE9IFNBU0xfT0spIHsKIAkgICAgdXRpbHMtPmZyZWUob3V0KTsKLQkgICAg
cmV0dXJuOworCSAgICByZXR1cm4gU0FTTF9PSzsKIAl9CiAJCiAJc3RyY2F0KG91dCwgbXNnLnZh
bHVlKTsKIAkKKwlHU1NfTE9DS19NVVRFWCh1dGlscyk7CiAJZ3NzX3JlbGVhc2VfYnVmZmVyKCZt
aW5fc3RhdCwgJm1zZyk7CisJR1NTX1VOTE9DS19NVVRFWCh1dGlscyk7CiAJCiAJaWYgKCFtc2df
Y3R4KQogCSAgICBicmVhazsKQEAgLTIzOSwxMyArMjU5LDE2IEBACiAgICAgcmV0ID0gX3BsdWdf
YnVmX2FsbG9jKHV0aWxzLCAmb3V0LCAmY3VybGVuLCBsZW4pOwogICAgIGlmKHJldCAhPSBTQVNM
X09LKSB7CiAJdXRpbHMtPmZyZWUob3V0KTsKLQlyZXR1cm47CisJcmV0dXJuIFNBU0xfT0s7CiAg
ICAgfQogICAgIAogICAgIHN0cmNhdChvdXQsICIpIik7CiAgICAgCiAgICAgdXRpbHMtPnNldGVy
cm9yKHV0aWxzLT5jb25uLCAwLCBvdXQpOwogICAgIHV0aWxzLT5mcmVlKG91dCk7CisKKyAgICBy
ZXR1cm4gU0FTTF9PSzsKKwogfQogCiBzdGF0aWMgaW50IApAQCAtMjgyLDYgKzMwNSw3IEBACiAg
ICAgb3V0cHV0X3Rva2VuLT52YWx1ZSA9IE5VTEw7CiAgICAgb3V0cHV0X3Rva2VuLT5sZW5ndGgg
PSAwOwogICAgIAorICAgIEdTU19MT0NLX01VVEVYKHRleHQtPnV0aWxzKTsKICAgICBtYWpfc3Rh
dCA9IGdzc193cmFwICgmbWluX3N0YXQsCiAJCQkgdGV4dC0+Z3NzX2N0eCwKIAkJCSBwcml2YWN5
LApAQCAtMjg5LDEyICszMTMsMTYgQEAKIAkJCSBpbnB1dF90b2tlbiwKIAkJCSBOVUxMLAogCQkJ
IG91dHB1dF90b2tlbik7CisgICAgR1NTX1VOTE9DS19NVVRFWCh0ZXh0LT51dGlscyk7CiAgICAg
CiAgICAgaWYgKEdTU19FUlJPUihtYWpfc3RhdCkpCiAJewogCSAgICBzYXNsX2dzc19zZXRlcnJv
cih0ZXh0LT51dGlscywgbWFqX3N0YXQsIG1pbl9zdGF0KTsKLQkgICAgaWYgKG91dHB1dF90b2tl
bi0+dmFsdWUpCisJICAgIGlmIChvdXRwdXRfdG9rZW4tPnZhbHVlKSB7CisJCUdTU19MT0NLX01V
VEVYKHRleHQtPnV0aWxzKTsKIAkJZ3NzX3JlbGVhc2VfYnVmZmVyKCZtaW5fc3RhdCwgb3V0cHV0
X3Rva2VuKTsKKwkJR1NTX1VOTE9DS19NVVRFWCh0ZXh0LT51dGlscyk7CisJICAgIH0KIAkgICAg
cmV0dXJuIFNBU0xfRkFJTDsKIAl9CiAgICAgCkBAIC0zMDUsNyArMzMzLDkgQEAKIAkJCSAgICAg
ICYodGV4dC0+ZW5jb2RlX2J1Zl9sZW4pLCBvdXRwdXRfdG9rZW4tPmxlbmd0aCArIDQpOwogCQog
CWlmIChyZXQgIT0gU0FTTF9PSykgeworCSAgICBHU1NfTE9DS19NVVRFWCh0ZXh0LT51dGlscyk7
CiAJICAgIGdzc19yZWxlYXNlX2J1ZmZlcigmbWluX3N0YXQsIG91dHB1dF90b2tlbik7CisJICAg
IEdTU19VTkxPQ0tfTVVURVgodGV4dC0+dXRpbHMpOwogCSAgICByZXR1cm4gcmV0OwogCX0KIAkK
QEAgLTMyMCw5ICszNTAsMTEgQEAKICAgICAKICAgICAqb3V0cHV0ID0gdGV4dC0+ZW5jb2RlX2J1
ZjsKICAgICAKLSAgICBpZiAob3V0cHV0X3Rva2VuLT52YWx1ZSkKKyAgICBpZiAob3V0cHV0X3Rv
a2VuLT52YWx1ZSkgeworCUdTU19MT0NLX01VVEVYKHRleHQtPnV0aWxzKTsKIAlnc3NfcmVsZWFz
ZV9idWZmZXIoJm1pbl9zdGF0LCBvdXRwdXRfdG9rZW4pOwotICAgIAorCUdTU19VTkxPQ0tfTVVU
RVgodGV4dC0+dXRpbHMpOworICAgIH0gCiAgICAgcmV0dXJuIFNBU0xfT0s7CiB9CiAKQEAgLTQx
OCwxOCArNDUwLDIzIEBACiAgICAgb3V0cHV0X3Rva2VuLT52YWx1ZSA9IE5VTEw7CiAgICAgb3V0
cHV0X3Rva2VuLT5sZW5ndGggPSAwOwogICAgIAorICAgIEdTU19MT0NLX01VVEVYKHRleHQtPnV0
aWxzKTsKICAgICBtYWpfc3RhdCA9IGdzc191bndyYXAgKCZtaW5fc3RhdCwKIAkJCSAgIHRleHQt
Pmdzc19jdHgsCiAJCQkgICBpbnB1dF90b2tlbiwKIAkJCSAgIG91dHB1dF90b2tlbiwKIAkJCSAg
IE5VTEwsCiAJCQkgICBOVUxMKTsKKyAgICBHU1NfVU5MT0NLX01VVEVYKHRleHQtPnV0aWxzKTsK
ICAgICAKICAgICBpZiAoR1NTX0VSUk9SKG1hal9zdGF0KSkKIAl7CiAJICAgIHNhc2xfZ3NzX3Nl
dGVycm9yKHRleHQtPnV0aWxzLG1hal9zdGF0LG1pbl9zdGF0KTsKLQkgICAgaWYgKG91dHB1dF90
b2tlbi0+dmFsdWUpCisJICAgIGlmIChvdXRwdXRfdG9rZW4tPnZhbHVlKSB7CisJCUdTU19MT0NL
X01VVEVYKHRleHQtPnV0aWxzKTsKIAkJZ3NzX3JlbGVhc2VfYnVmZmVyKCZtaW5fc3RhdCwgb3V0
cHV0X3Rva2VuKTsKKwkJR1NTX1VOTE9DS19NVVRFWCh0ZXh0LT51dGlscyk7CisJICAgIH0KIAkg
ICAgcmV0dXJuIFNBU0xfRkFJTDsKIAl9CiAgICAgCkBAIC00NDIsMTMgKzQ3OSwxNyBAQAogCQkJ
CSAgICAgJnRleHQtPmRlY29kZV9vbmNlX2J1Zl9sZW4sCiAJCQkJICAgICAqb3V0cHV0bGVuKTsK
IAkgICAgaWYocmVzdWx0ICE9IFNBU0xfT0spIHsKKwkJR1NTX0xPQ0tfTVVURVgodGV4dC0+dXRp
bHMpOwogCQlnc3NfcmVsZWFzZV9idWZmZXIoJm1pbl9zdGF0LCBvdXRwdXRfdG9rZW4pOworCQlH
U1NfVU5MT0NLX01VVEVYKHRleHQtPnV0aWxzKTsKIAkJcmV0dXJuIHJlc3VsdDsKIAkgICAgfQog
CSAgICAqb3V0cHV0ID0gdGV4dC0+ZGVjb2RlX29uY2VfYnVmOwogCSAgICBtZW1jcHkoKm91dHB1
dCwgb3V0cHV0X3Rva2VuLT52YWx1ZSwgKm91dHB1dGxlbik7CiAJfQorCUdTU19MT0NLX01VVEVY
KHRleHQtPnV0aWxzKTsKIAlnc3NfcmVsZWFzZV9idWZmZXIoJm1pbl9zdGF0LCBvdXRwdXRfdG9r
ZW4pOworCUdTU19VTkxPQ0tfTVVURVgodGV4dC0+dXRpbHMpOwogICAgIH0KICAgICAKICAgICAv
KiByZXNldCBmb3IgdGhlIG5leHQgcGFja2V0ICovCkBAIC00ODksMTIgKzUzMCwxNCBAQAogICAg
IHJldHVybiByZXQ7CiB9CiAKLXN0YXRpYyB2b2lkIHNhc2xfZ3NzX2ZyZWVfY29udGV4dF9jb250
ZW50cyhjb250ZXh0X3QgKnRleHQpCitzdGF0aWMgaW50IHNhc2xfZ3NzX2ZyZWVfY29udGV4dF9j
b250ZW50cyhjb250ZXh0X3QgKnRleHQpCiB7CiAgICAgT01fdWludDMyIG1hal9zdGF0LCBtaW5f
c3RhdDsKICAgICAKLSAgICBpZiAoIXRleHQpIHJldHVybjsKKyAgICBpZiAoIXRleHQpIHJldHVy
biBTQVNMX09LOwogICAgIAorICAgIEdTU19MT0NLX01VVEVYKHRleHQtPnV0aWxzKTsKKwogICAg
IGlmICh0ZXh0LT5nc3NfY3R4ICE9IEdTU19DX05PX0NPTlRFWFQpIHsKIAltYWpfc3RhdCA9IGdz
c19kZWxldGVfc2VjX2NvbnRleHQgKCZtaW5fc3RhdCwmdGV4dC0+Z3NzX2N0eCxHU1NfQ19OT19C
VUZGRVIpOwogCXRleHQtPmdzc19jdHggPSBHU1NfQ19OT19DT05URVhUOwpAQCAtNTE0LDYgKzU1
Nyw4IEBACiAJbWFqX3N0YXQgPSBnc3NfcmVsZWFzZV9jcmVkKCZtaW5fc3RhdCwgJnRleHQtPnNl
cnZlcl9jcmVkcyk7CiAJdGV4dC0+c2VydmVyX2NyZWRzID0gR1NTX0NfTk9fQ1JFREVOVElBTDsK
ICAgICB9CisKKyAgICBHU1NfVU5MT0NLX01VVEVYKHRleHQtPnV0aWxzKTsKICAgICAKICAgICBp
ZiAodGV4dC0+b3V0X2J1ZikgewogCXRleHQtPnV0aWxzLT5mcmVlKHRleHQtPm91dF9idWYpOwpA
QCAtNTUwLDEyICs1OTUsMTkgQEAKIAl0ZXh0LT51dGlscy0+ZnJlZSh0ZXh0LT5hdXRoaWQpOwog
CXRleHQtPmF1dGhpZCA9IE5VTEw7CiAgICAgfQorCisgICAgcmV0dXJuIFNBU0xfT0s7CisKIH0K
IAogc3RhdGljIHZvaWQgZ3NzYXBpX2NvbW1vbl9tZWNoX2Rpc3Bvc2Uodm9pZCAqY29ubl9jb250
ZXh0LAogCQkJCSAgICAgICBjb25zdCBzYXNsX3V0aWxzX3QgKnV0aWxzKQogewogICAgIHNhc2xf
Z3NzX2ZyZWVfY29udGV4dF9jb250ZW50cygoY29udGV4dF90ICopKGNvbm5fY29udGV4dCkpOwor
ICAgIGlmIChnc3NfbXV0ZXgpIHsKKyAgICAgIHV0aWxzLT5tdXRleF9mcmVlKGdzc19tdXRleCk7
CisgICAgICBnc3NfbXV0ZXg9TlVMTDsKKyAgICB9CiAgICAgdXRpbHMtPmZyZWUoY29ubl9jb250
ZXh0KTsKIH0KIApAQCAtNjI5LDEwICs2ODEsMTIgQEAKIAkgICAgfQogCSAgICBzcHJpbnRmKG5h
bWVfdG9rZW4udmFsdWUsIiVzQCVzIiwgcGFyYW1zLT5zZXJ2aWNlLCBwYXJhbXMtPnNlcnZlckZR
RE4pOwogCSAgICAKKwkgICAgR1NTX0xPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CiAJICAgIG1h
al9zdGF0ID0gZ3NzX2ltcG9ydF9uYW1lICgmbWluX3N0YXQsCiAJCQkJCSZuYW1lX3Rva2VuLAog
CQkJCQlHU1NfQ19OVF9IT1NUQkFTRURfU0VSVklDRSwKIAkJCQkJJnRleHQtPnNlcnZlcl9uYW1l
KTsKKwkgICAgR1NTX1VOTE9DS19NVVRFWChwYXJhbXMtPnV0aWxzKTsKIAkgICAgCiAJICAgIHBh
cmFtcy0+dXRpbHMtPmZyZWUobmFtZV90b2tlbi52YWx1ZSk7CiAJICAgIG5hbWVfdG9rZW4udmFs
dWUgPSBOVUxMOwpAQCAtNjQ0LDEwICs2OTgsMTMgQEAKIAkgICAgfQogCSAgICAKIAkgICAgaWYg
KCB0ZXh0LT5zZXJ2ZXJfY3JlZHMgIT0gR1NTX0NfTk9fQ1JFREVOVElBTCkgeworCSAgICAJR1NT
X0xPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CiAJCW1hal9zdGF0ID0gZ3NzX3JlbGVhc2VfY3Jl
ZCgmbWluX3N0YXQsICZ0ZXh0LT5zZXJ2ZXJfY3JlZHMpOworCSAgICAJR1NTX1VOTE9DS19NVVRF
WChwYXJhbXMtPnV0aWxzKTsKIAkJdGV4dC0+c2VydmVyX2NyZWRzID0gR1NTX0NfTk9fQ1JFREVO
VElBTDsKIAkgICAgfQogCSAgICAKKwkgICAgR1NTX0xPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7
CiAJICAgIG1hal9zdGF0ID0gZ3NzX2FjcXVpcmVfY3JlZCgmbWluX3N0YXQsIAogCQkJCQl0ZXh0
LT5zZXJ2ZXJfbmFtZSwKIAkJCQkJR1NTX0NfSU5ERUZJTklURSwgCkBAIC02NTYsNiArNzEzLDcg
QEAKIAkJCQkJJnRleHQtPnNlcnZlcl9jcmVkcywgCiAJCQkJCU5VTEwsIAogCQkJCQlOVUxMKTsK
KwkgICAgR1NTX1VOTE9DS19NVVRFWChwYXJhbXMtPnV0aWxzKTsKIAkgICAgCiAJICAgIGlmIChH
U1NfRVJST1IobWFqX3N0YXQpKSB7CiAJCXNhc2xfZ3NzX3NldGVycm9yKHRleHQtPnV0aWxzLCBt
YWpfc3RhdCwgbWluX3N0YXQpOwpAQCAtNjY5LDYgKzcyNyw3IEBACiAJICAgIHJlYWxfaW5wdXRf
dG9rZW4ubGVuZ3RoID0gY2xpZW50aW5sZW47CiAJfQogCQorCUdTU19MT0NLX01VVEVYKHBhcmFt
cy0+dXRpbHMpOwogCW1hal9zdGF0ID0KIAkgICAgZ3NzX2FjY2VwdF9zZWNfY29udGV4dCgmbWlu
X3N0YXQsCiAJCQkJICAgJih0ZXh0LT5nc3NfY3R4KSwKQEAgLTY4MSwxMCArNzQwLDEzIEBACiAJ
CQkJICAgTlVMTCwKIAkJCQkgICBOVUxMLAogCQkJCSAgIE5VTEwpOworCUdTU19VTkxPQ0tfTVVU
RVgocGFyYW1zLT51dGlscyk7CiAJCiAJaWYgKEdTU19FUlJPUihtYWpfc3RhdCkpIHsKIAkgICAg
aWYgKG91dHB1dF90b2tlbi0+dmFsdWUpIHsKKwkJR1NTX0xPQ0tfTVVURVgocGFyYW1zLT51dGls
cyk7CiAJCWdzc19yZWxlYXNlX2J1ZmZlcigmbWluX3N0YXQsIG91dHB1dF90b2tlbik7CisJCUdT
U19VTkxPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CiAJICAgIH0KIAkgICAgdGV4dC0+dXRpbHMt
PnNldGVycm9yKHRleHQtPnV0aWxzLT5jb25uLCBTQVNMX05PTE9HLCAiR1NTQVBJIEZhaWx1cmU6
IGdzc19hY2NlcHRfc2VjX2NvbnRleHQiKTsKIAkgICAgdGV4dC0+dXRpbHMtPmxvZyhOVUxMLCBT
QVNMX0xPR19ERUJVRywgIkdTU0FQSSBGYWlsdXJlOiBnc3NfYWNjZXB0X3NlY19jb250ZXh0Iik7
CkBAIC02OTksMTQgKzc2MSwxOCBAQAogCQlyZXQgPSBfcGx1Z19idWZfYWxsb2ModGV4dC0+dXRp
bHMsICYodGV4dC0+b3V0X2J1ZiksCiAJCQkJICAgICAgJih0ZXh0LT5vdXRfYnVmX2xlbiksICpz
ZXJ2ZXJvdXRsZW4pOwogCQlpZihyZXQgIT0gU0FTTF9PSykgeworCQkgICAgR1NTX0xPQ0tfTVVU
RVgocGFyYW1zLT51dGlscyk7CiAJCSAgICBnc3NfcmVsZWFzZV9idWZmZXIoJm1pbl9zdGF0LCBv
dXRwdXRfdG9rZW4pOworCQkgICAgR1NTX1VOTE9DS19NVVRFWChwYXJhbXMtPnV0aWxzKTsKIAkJ
ICAgIHJldHVybiByZXQ7CiAJCX0KIAkJbWVtY3B5KHRleHQtPm91dF9idWYsIG91dHB1dF90b2tl
bi0+dmFsdWUsICpzZXJ2ZXJvdXRsZW4pOwogCQkqc2VydmVyb3V0ID0gdGV4dC0+b3V0X2J1ZjsK
IAkgICAgfQogCSAgICAKKwkgICAgR1NTX0xPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CiAJICAg
IGdzc19yZWxlYXNlX2J1ZmZlcigmbWluX3N0YXQsIG91dHB1dF90b2tlbik7CisJICAgIEdTU19V
TkxPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CiAJfSBlbHNlIHsKIAkgICAgLyogTm8gb3V0cHV0
IHRva2VuLCBzZW5kIGFuIGVtcHR5IHN0cmluZyAqLwogCSAgICAqc2VydmVyb3V0ID0gR1NTQVBJ
X0JMQU5LX1NUUklORzsKQEAgLTczMiwxOSArNzk4LDI3IEBACiAJCiAJLyogV2UgaWdub3JlIHdo
YXRldmVyIHRoZSBjbGllbnQgc2VudCB1cyBhdCB0aGlzIHN0YWdlICovCiAJCisJR1NTX0xPQ0tf
TVVURVgocGFyYW1zLT51dGlscyk7CiAJbWFqX3N0YXQgPSBnc3NfZGlzcGxheV9uYW1lICgmbWlu
X3N0YXQsCiAJCQkJICAgICB0ZXh0LT5jbGllbnRfbmFtZSwKIAkJCQkgICAgICZuYW1lX3Rva2Vu
LAogCQkJCSAgICAgTlVMTCk7CisJR1NTX1VOTE9DS19NVVRFWChwYXJhbXMtPnV0aWxzKTsKIAkK
IAlpZiAoR1NTX0VSUk9SKG1hal9zdGF0KSkgewogCSAgICBpZiAobmFtZV93aXRob3V0X3JlYWxt
LnZhbHVlKQogCQlwYXJhbXMtPnV0aWxzLT5mcmVlKG5hbWVfd2l0aG91dF9yZWFsbS52YWx1ZSk7
CiAJICAgIAotCSAgICBpZiAobmFtZV90b2tlbi52YWx1ZSkKKwkgICAgaWYgKG5hbWVfdG9rZW4u
dmFsdWUpIHsKKwkJR1NTX0xPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CiAJCWdzc19yZWxlYXNl
X2J1ZmZlcigmbWluX3N0YXQsICZuYW1lX3Rva2VuKTsKLQkgICAgaWYgKHdpdGhvdXQpCisJCUdT
U19VTkxPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CisJICAgIH0KKwkgICAgaWYgKHdpdGhvdXQp
IHsKKwkJR1NTX0xPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CiAJCWdzc19yZWxlYXNlX25hbWUo
Jm1pbl9zdGF0LCAmd2l0aG91dCk7CisJCUdTU19VTkxPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7
CisJICAgIH0KIAkgICAgU0VURVJST1IodGV4dC0+dXRpbHMsICJHU1NBUEkgRmFpbHVyZSIpOwog
CSAgICBzYXNsX2dzc19mcmVlX2NvbnRleHRfY29udGVudHModGV4dCk7CiAJICAgIHJldHVybiBT
QVNMX0JBREFVVEg7CkBAIC03NzAsNiArODQ0LDcgQEAKIAkgICAgCiAJICAgIG5hbWVfd2l0aG91
dF9yZWFsbS5sZW5ndGggPSBzdHJsZW4oIChjaGFyICopIG5hbWVfd2l0aG91dF9yZWFsbS52YWx1
ZSApOwogCSAgICAKKwkgICAgR1NTX0xPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CiAJICAgIG1h
al9zdGF0ID0gZ3NzX2ltcG9ydF9uYW1lICgmbWluX3N0YXQsCiAJCQkJCSZuYW1lX3dpdGhvdXRf
cmVhbG0sCiAJICAgIC8qIFNvbGFyaXMgOC85IGdzc19pbXBvcnRfbmFtZSBkb2Vzbid0IGFjY2Vw
dCBHU1NfQ19OVUxMX09JRCBoZXJlLApAQCAtNzgwLDM1ICs4NTUsNTMgQEAKIAkJCQkJR1NTX0Nf
TlVMTF9PSUQsCiAjZW5kaWYKIAkJCQkJJndpdGhvdXQpOworCSAgICBHU1NfVU5MT0NLX01VVEVY
KHBhcmFtcy0+dXRpbHMpOwogCSAgICAKIAkgICAgaWYgKEdTU19FUlJPUihtYWpfc3RhdCkpIHsK
IAkJcGFyYW1zLT51dGlscy0+ZnJlZShuYW1lX3dpdGhvdXRfcmVhbG0udmFsdWUpOwotCQlpZiAo
bmFtZV90b2tlbi52YWx1ZSkKKwkJaWYgKG5hbWVfdG9rZW4udmFsdWUpIHsKKwkgICAgCSAgICBH
U1NfTE9DS19NVVRFWChwYXJhbXMtPnV0aWxzKTsKIAkJICAgIGdzc19yZWxlYXNlX2J1ZmZlcigm
bWluX3N0YXQsICZuYW1lX3Rva2VuKTsKLQkJaWYgKHdpdGhvdXQpCisJICAgIAkgICAgR1NTX1VO
TE9DS19NVVRFWChwYXJhbXMtPnV0aWxzKTsKKwkJfQorCQlpZiAod2l0aG91dCkgeworCSAgICAJ
ICAgIEdTU19MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMpOwogCQkgICAgZ3NzX3JlbGVhc2VfbmFt
ZSgmbWluX3N0YXQsICZ3aXRob3V0KTsKKwkgICAgCSAgICBHU1NfVU5MT0NLX01VVEVYKHBhcmFt
cy0+dXRpbHMpOworCQl9CiAJCVNFVEVSUk9SKHRleHQtPnV0aWxzLCAiR1NTQVBJIEZhaWx1cmUi
KTsKIAkJc2FzbF9nc3NfZnJlZV9jb250ZXh0X2NvbnRlbnRzKHRleHQpOwogCQlyZXR1cm4gU0FT
TF9CQURBVVRIOwogCSAgICB9CiAJICAgIAorCSAgICBHU1NfTE9DS19NVVRFWChwYXJhbXMtPnV0
aWxzKTsKIAkgICAgbWFqX3N0YXQgPSBnc3NfY29tcGFyZV9uYW1lKCZtaW5fc3RhdCwKIAkJCQkJ
dGV4dC0+Y2xpZW50X25hbWUsCiAJCQkJCXdpdGhvdXQsCiAJCQkJCSZlcXVhbCk7CisJICAgIEdT
U19VTkxPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CiAJICAgIAogCSAgICBpZiAoR1NTX0VSUk9S
KG1hal9zdGF0KSkgewogCQlwYXJhbXMtPnV0aWxzLT5mcmVlKG5hbWVfd2l0aG91dF9yZWFsbS52
YWx1ZSk7Ci0JCWlmIChuYW1lX3Rva2VuLnZhbHVlKQorCQlpZiAobmFtZV90b2tlbi52YWx1ZSkg
eworCSAgICAJICAgIEdTU19MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMpOwogCQkgICAgZ3NzX3Jl
bGVhc2VfYnVmZmVyKCZtaW5fc3RhdCwgJm5hbWVfdG9rZW4pOwotCQlpZiAod2l0aG91dCkKKwkg
ICAgCSAgICBHU1NfVU5MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMpOworCQl9CisJCWlmICh3aXRo
b3V0KSB7CisJICAgIAkgICAgR1NTX0xPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CiAJCSAgICBn
c3NfcmVsZWFzZV9uYW1lKCZtaW5fc3RhdCwgJndpdGhvdXQpOworCSAgICAJICAgIEdTU19VTkxP
Q0tfTVVURVgocGFyYW1zLT51dGlscyk7CisJCX0KIAkJU0VURVJST1IodGV4dC0+dXRpbHMsICJH
U1NBUEkgRmFpbHVyZSIpOwogCQlzYXNsX2dzc19mcmVlX2NvbnRleHRfY29udGVudHModGV4dCk7
CiAJCXJldHVybiBTQVNMX0JBREFVVEg7CiAJICAgIH0KIAkgICAgCisJICAgIEdTU19MT0NLX01V
VEVYKHBhcmFtcy0+dXRpbHMpOwogCSAgICBnc3NfcmVsZWFzZV9uYW1lKCZtaW5fc3RhdCwmd2l0
aG91dCk7CisJICAgIEdTU19VTkxPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CisKIAl9IGVsc2Ug
ewogCSAgICBlcXVhbCA9IDA7CiAJfQpAQCAtODI5LDExICs5MjIsMTQgQEAKIAkgICAgfQogCX0K
IAkKLQlpZiAobmFtZV90b2tlbi52YWx1ZSkKKwlpZiAobmFtZV90b2tlbi52YWx1ZSkgeworCSAg
ICBHU1NfTE9DS19NVVRFWChwYXJhbXMtPnV0aWxzKTsKIAkgICAgZ3NzX3JlbGVhc2VfYnVmZmVy
KCZtaW5fc3RhdCwgJm5hbWVfdG9rZW4pOwotCWlmIChuYW1lX3dpdGhvdXRfcmVhbG0udmFsdWUp
CisJICAgIEdTU19VTkxPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CisJfQorCWlmIChuYW1lX3dp
dGhvdXRfcmVhbG0udmFsdWUpIHsKIAkgICAgcGFyYW1zLT51dGlscy0+ZnJlZShuYW1lX3dpdGhv
dXRfcmVhbG0udmFsdWUpOwotCQorCX0JCiAJCiAJLyogd2UgaGF2ZSB0byBkZWNpZGUgd2hhdCBz
b3J0IG9mIGVuY3J5cHRpb24vaW50ZWdyaXR5L2V0Yy4sCiAJICAgd2Ugc3VwcG9ydCAqLwpAQCAt
ODgwLDYgKzk3Niw3IEBACiAJcmVhbF9pbnB1dF90b2tlbi52YWx1ZSA9ICh2b2lkICopc2FzbGRh
dGE7CiAJcmVhbF9pbnB1dF90b2tlbi5sZW5ndGggPSA0OwogCQorCUdTU19MT0NLX01VVEVYKHBh
cmFtcy0+dXRpbHMpOwogCW1hal9zdGF0ID0gZ3NzX3dyYXAoJm1pbl9zdGF0LAogCQkJICAgIHRl
eHQtPmdzc19jdHgsCiAJCQkgICAgMCwgLyogSnVzdCBpbnRlZ3JpdHkgY2hlY2tpbmcgaGVyZSAq
LwpAQCAtODg3LDExICs5ODQsMTUgQEAKIAkJCSAgICBpbnB1dF90b2tlbiwKIAkJCSAgICBOVUxM
LAogCQkJICAgIG91dHB1dF90b2tlbik7CisJR1NTX1VOTE9DS19NVVRFWChwYXJhbXMtPnV0aWxz
KTsKIAkKIAlpZiAoR1NTX0VSUk9SKG1hal9zdGF0KSkgewogCSAgICBzYXNsX2dzc19zZXRlcnJv
cih0ZXh0LT51dGlscywgbWFqX3N0YXQsIG1pbl9zdGF0KTsKLQkgICAgaWYgKG91dHB1dF90b2tl
bi0+dmFsdWUpCisJICAgIGlmIChvdXRwdXRfdG9rZW4tPnZhbHVlKSB7CisJCUdTU19MT0NLX01V
VEVYKHBhcmFtcy0+dXRpbHMpOwogCQlnc3NfcmVsZWFzZV9idWZmZXIoJm1pbl9zdGF0LCBvdXRw
dXRfdG9rZW4pOworCQlHU1NfVU5MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMpOworCSAgICB9CiAJ
ICAgIHNhc2xfZ3NzX2ZyZWVfY29udGV4dF9jb250ZW50cyh0ZXh0KTsKIAkgICAgcmV0dXJuIFNB
U0xfRkFJTDsKIAl9CkBAIC05MDQsMTQgKzEwMDUsMTggQEAKIAkJcmV0ID0gX3BsdWdfYnVmX2Fs
bG9jKHRleHQtPnV0aWxzLCAmKHRleHQtPm91dF9idWYpLAogCQkJCSAgICAgICYodGV4dC0+b3V0
X2J1Zl9sZW4pLCAqc2VydmVyb3V0bGVuKTsKIAkJaWYocmV0ICE9IFNBU0xfT0spIHsKKwkJICAg
IEdTU19MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMpOwogCQkgICAgZ3NzX3JlbGVhc2VfYnVmZmVy
KCZtaW5fc3RhdCwgb3V0cHV0X3Rva2VuKTsKKwkJICAgIEdTU19VTkxPQ0tfTVVURVgocGFyYW1z
LT51dGlscyk7CiAJCSAgICByZXR1cm4gcmV0OwogCQl9CiAJCW1lbWNweSh0ZXh0LT5vdXRfYnVm
LCBvdXRwdXRfdG9rZW4tPnZhbHVlLCAqc2VydmVyb3V0bGVuKTsKIAkJKnNlcnZlcm91dCA9IHRl
eHQtPm91dF9idWY7CiAJICAgIH0KIAkgICAgCisJICAgIEdTU19MT0NLX01VVEVYKHBhcmFtcy0+
dXRpbHMpOwogCSAgICBnc3NfcmVsZWFzZV9idWZmZXIoJm1pbl9zdGF0LCBvdXRwdXRfdG9rZW4p
OworCSAgICBHU1NfVU5MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMpOwogCX0KIAkKIAkvKiBXYWl0
IGZvciBzc2YgcmVxdWVzdCBhbmQgYXV0aGlkICovCkBAIC05MjYsMTIgKzEwMzEsMTQgQEAKIAly
ZWFsX2lucHV0X3Rva2VuLnZhbHVlID0gKHZvaWQgKiljbGllbnRpbjsKIAlyZWFsX2lucHV0X3Rv
a2VuLmxlbmd0aCA9IGNsaWVudGlubGVuOwogCQorCUdTU19MT0NLX01VVEVYKHBhcmFtcy0+dXRp
bHMpOwogCW1hal9zdGF0ID0gZ3NzX3Vud3JhcCgmbWluX3N0YXQsCiAJCQkgICAgICB0ZXh0LT5n
c3NfY3R4LAogCQkJICAgICAgaW5wdXRfdG9rZW4sCiAJCQkgICAgICBvdXRwdXRfdG9rZW4sCiAJ
CQkgICAgICBOVUxMLAogCQkJICAgICAgTlVMTCk7CisJR1NTX1VOTE9DS19NVVRFWChwYXJhbXMt
PnV0aWxzKTsKIAkKIAlpZiAoR1NTX0VSUk9SKG1hal9zdGF0KSkgewogCSAgICBzYXNsX2dzc19z
ZXRlcnJvcih0ZXh0LT51dGlscywgbWFqX3N0YXQsIG1pbl9zdGF0KTsKQEAgLTk2MCw4ICsxMDY3
LDExIEBACiAJCSAgICAgInByb3RvY29sIHZpb2xhdGlvbjogY2xpZW50IHJlcXVlc3RlZCBpbnZh
bGlkIGxheWVyIik7CiAJICAgIC8qIE1hcmsgdGhhdCB3ZSBhdHRlbXB0ZWQgbmVnb3RpYXRpb24g
Ki8KIAkgICAgb3BhcmFtcy0+bWVjaF9zc2YgPSAyOwotCSAgICBpZiAob3V0cHV0X3Rva2VuLT52
YWx1ZSkKKwkgICAgaWYgKG91dHB1dF90b2tlbi0+dmFsdWUpIHsKKwkJR1NTX0xPQ0tfTVVURVgo
cGFyYW1zLT51dGlscyk7CiAJCWdzc19yZWxlYXNlX2J1ZmZlcigmbWluX3N0YXQsIG91dHB1dF90
b2tlbik7CisJCUdTU19VTkxPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CisJICAgIH0KIAkgICAg
c2FzbF9nc3NfZnJlZV9jb250ZXh0X2NvbnRlbnRzKHRleHQpOwogCSAgICByZXR1cm4gU0FTTF9G
QUlMOwogCX0KQEAgLTEwMDQsNyArMTExNCw5IEBACiAJfSBlbHNlIHsKIAkgICAgU0VURVJST1Io
dGV4dC0+dXRpbHMsCiAJCSAgICAgInRva2VuIHRvbyBzaG9ydCIpOworCSAgICBHU1NfTE9DS19N
VVRFWChwYXJhbXMtPnV0aWxzKTsKIAkgICAgZ3NzX3JlbGVhc2VfYnVmZmVyKCZtaW5fc3RhdCwg
b3V0cHV0X3Rva2VuKTsKKwkgICAgR1NTX1VOTE9DS19NVVRFWChwYXJhbXMtPnV0aWxzKTsKIAkg
ICAgc2FzbF9nc3NfZnJlZV9jb250ZXh0X2NvbnRlbnRzKHRleHQpOwogCSAgICByZXR1cm4gU0FT
TF9GQUlMOwogCX0JCkBAIC0xMDIwLDcgKzExMzIsOSBAQAogCSAgICBvcGFyYW1zLT5tYXhvdXRi
dWYgLT0gNTA7CiAJfQogCQorCUdTU19MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMpOwogCWdzc19y
ZWxlYXNlX2J1ZmZlcigmbWluX3N0YXQsIG91dHB1dF90b2tlbik7CisJR1NTX1VOTE9DS19NVVRF
WChwYXJhbXMtPnV0aWxzKTsKIAkKIAl0ZXh0LT5zdGF0ZSA9IFNBU0xfR1NTQVBJX1NUQVRFX0FV
VEhFTlRJQ0FURUQ7CiAJCkBAIC0xMTEzLDYgKzEyMjcsMTMgQEAKICAgICAqb3V0X3ZlcnNpb24g
PSBTQVNMX1NFUlZFUl9QTFVHX1ZFUlNJT047CiAgICAgKnBsdWdsaXN0ID0gZ3NzYXBpX3NlcnZl
cl9wbHVnaW5zOwogICAgICpwbHVnY291bnQgPSAxOyAgCisKKyAgICBpZiAoIWdzc19tdXRleCkg
eworICAgICAgIGdzc19tdXRleCA9IHV0aWxzLT5tdXRleF9hbGxvYygpOworICAgICAgIGlmICgh
Z3NzX211dGV4KSB7CisgICAgICAgICAgIHJldHVybiBTQVNMX0ZBSUw7CisgICAgICAgfQorICAg
IH0KICAgICAKICAgICByZXR1cm4gU0FTTF9PSzsKIH0KQEAgLTEyMjAsMTAgKzEzNDEsMTIgQEAK
IAkgICAgCiAJICAgIHNwcmludGYobmFtZV90b2tlbi52YWx1ZSwiJXNAJXMiLCBwYXJhbXMtPnNl
cnZpY2UsIHBhcmFtcy0+c2VydmVyRlFETik7CiAJICAgIAorCSAgICBHU1NfTE9DS19NVVRFWChw
YXJhbXMtPnV0aWxzKTsKIAkgICAgbWFqX3N0YXQgPSBnc3NfaW1wb3J0X25hbWUgKCZtaW5fc3Rh
dCwKIAkJCQkJJm5hbWVfdG9rZW4sCiAJCQkJCUdTU19DX05UX0hPU1RCQVNFRF9TRVJWSUNFLAog
CQkJCQkmdGV4dC0+c2VydmVyX25hbWUpOworCSAgICBHU1NfVU5MT0NLX01VVEVYKHBhcmFtcy0+
dXRpbHMpOwogCSAgICAKIAkgICAgcGFyYW1zLT51dGlscy0+ZnJlZShuYW1lX3Rva2VuLnZhbHVl
KTsKIAkgICAgbmFtZV90b2tlbi52YWx1ZSA9IE5VTEw7CkBAIC0xMjQ3LDcgKzEzNzAsOSBAQAog
CSAgICAgKiBhbmQgbm8gaW5wdXQgZnJvbSB0aGUgc2VydmVyLiAgSG93ZXZlciwgdGhhbmtzIHRv
IEltYXAsCiAJICAgICAqIHdoaWNoIGRpc2NhcmRzIG91ciBmaXJzdCBvdXRwdXQsIHRoaXMgaGFw
cGVucyBhbGwgdGhlIHRpbWUuCiAJICAgICAqIFRocm93IGF3YXkgdGhlIGNvbnRleHQgYW5kIHRy
eSBhZ2Fpbi4gKi8KKwkgICAgR1NTX0xPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CiAJICAgIG1h
al9zdGF0ID0gZ3NzX2RlbGV0ZV9zZWNfY29udGV4dCAoJm1pbl9zdGF0LCZ0ZXh0LT5nc3NfY3R4
LEdTU19DX05PX0JVRkZFUik7CisJICAgIEdTU19VTkxPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7
CiAJICAgIHRleHQtPmdzc19jdHggPSBHU1NfQ19OT19DT05URVhUOwogCX0KIAkgICAgCkBAIC0x
MjYyLDYgKzEzODcsNyBAQAogCSAgICB9CiAJfQogCQorCUdTU19MT0NLX01VVEVYKHBhcmFtcy0+
dXRpbHMpOwogCW1hal9zdGF0ID0gZ3NzX2luaXRfc2VjX2NvbnRleHQoJm1pbl9zdGF0LAogCQkJ
CQlHU1NfQ19OT19DUkVERU5USUFMLAogCQkJCQkmdGV4dC0+Z3NzX2N0eCwKQEAgLTEyNzUsMTEg
KzE0MDEsMTUgQEAKIAkJCQkJb3V0cHV0X3Rva2VuLAogCQkJCQkmb3V0X3JlcV9mbGFncywKIAkJ
CQkJTlVMTCk7CisJR1NTX1VOTE9DS19NVVRFWChwYXJhbXMtPnV0aWxzKTsKIAkKIAlpZiAoR1NT
X0VSUk9SKG1hal9zdGF0KSkgewogCSAgICBzYXNsX2dzc19zZXRlcnJvcih0ZXh0LT51dGlscywg
bWFqX3N0YXQsIG1pbl9zdGF0KTsKLQkgICAgaWYgKG91dHB1dF90b2tlbi0+dmFsdWUpCisJICAg
IGlmIChvdXRwdXRfdG9rZW4tPnZhbHVlKSB7CisJCUdTU19MT0NLX01VVEVYKHBhcmFtcy0+dXRp
bHMpOwogCQlnc3NfcmVsZWFzZV9idWZmZXIoJm1pbl9zdGF0LCBvdXRwdXRfdG9rZW4pOworCQlH
U1NfVU5MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMpOworCSAgICB9CiAJICAgIHNhc2xfZ3NzX2Zy
ZWVfY29udGV4dF9jb250ZW50cyh0ZXh0KTsKIAkgICAgcmV0dXJuIFNBU0xfRkFJTDsKIAl9CkBA
IC0xMjkxLDE3ICsxNDIxLDIyIEBACiAJCXJldCA9IF9wbHVnX2J1Zl9hbGxvYyh0ZXh0LT51dGls
cywgJih0ZXh0LT5vdXRfYnVmKSwKIAkJCQkgICAgICAmKHRleHQtPm91dF9idWZfbGVuKSwgKmNs
aWVudG91dGxlbik7CiAJCWlmKHJldCAhPSBTQVNMX09LKSB7CisJCSAgICBHU1NfTE9DS19NVVRF
WChwYXJhbXMtPnV0aWxzKTsKIAkJICAgIGdzc19yZWxlYXNlX2J1ZmZlcigmbWluX3N0YXQsIG91
dHB1dF90b2tlbik7CisJCSAgICBHU1NfVU5MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMpOwogCQkg
ICAgcmV0dXJuIHJldDsKIAkJfQogCQltZW1jcHkodGV4dC0+b3V0X2J1Ziwgb3V0cHV0X3Rva2Vu
LT52YWx1ZSwgKmNsaWVudG91dGxlbik7CiAJCSpjbGllbnRvdXQgPSB0ZXh0LT5vdXRfYnVmOwog
CSAgICB9CiAJICAgIAorCSAgICBHU1NfTE9DS19NVVRFWChwYXJhbXMtPnV0aWxzKTsKIAkgICAg
Z3NzX3JlbGVhc2VfYnVmZmVyKCZtaW5fc3RhdCwgb3V0cHV0X3Rva2VuKTsKKwkgICAgR1NTX1VO
TE9DS19NVVRFWChwYXJhbXMtPnV0aWxzKTsKIAl9CiAJCiAJaWYgKG1hal9zdGF0ID09IEdTU19T
X0NPTVBMRVRFKSB7CisJICAgIEdTU19MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMpOwogCSAgICBt
YWpfc3RhdCA9IGdzc19pbnF1aXJlX2NvbnRleHQoJm1pbl9zdGF0LAogCQkJCQkgICB0ZXh0LT5n
c3NfY3R4LAogCQkJCQkgICAmdGV4dC0+Y2xpZW50X25hbWUsCkBAIC0xMzExLDYgKzE0NDYsNyBA
QAogCQkJCQkgICBOVUxMLCAgICAgICAvKiBmbGFncyAqLwogCQkJCQkgICBOVUxMLCAgICAgICAv
KiBsb2NhbCBpbml0ICovCiAJCQkJCSAgIE5VTEwpOyAgICAgIC8qIG9wZW4gKi8KKwkgICAgR1NT
X1VOTE9DS19NVVRFWChwYXJhbXMtPnV0aWxzKTsKIAkgICAgCiAJICAgIGlmIChHU1NfRVJST1Io
bWFqX3N0YXQpKSB7CiAJCXNhc2xfZ3NzX3NldGVycm9yKHRleHQtPnV0aWxzLCBtYWpfc3RhdCwg
bWluX3N0YXQpOwpAQCAtMTMxOSwxNCArMTQ1NSwxOSBAQAogCSAgICB9CiAJICAgIAogCSAgICBu
YW1lX3Rva2VuLmxlbmd0aCA9IDA7CisJICAgIEdTU19MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMp
OwogCSAgICBtYWpfc3RhdCA9IGdzc19kaXNwbGF5X25hbWUoJm1pbl9zdGF0LAogCQkJCQl0ZXh0
LT5jbGllbnRfbmFtZSwKIAkJCQkJJm5hbWVfdG9rZW4sCiAJCQkJCU5VTEwpOworCSAgICBHU1Nf
VU5MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMpOwogCSAgICAKIAkgICAgaWYgKEdTU19FUlJPUiht
YWpfc3RhdCkpIHsKLQkJaWYgKG5hbWVfdG9rZW4udmFsdWUpCisJCWlmIChuYW1lX3Rva2VuLnZh
bHVlKSB7CisJCSAgICBHU1NfTE9DS19NVVRFWChwYXJhbXMtPnV0aWxzKTsKIAkJICAgIGdzc19y
ZWxlYXNlX2J1ZmZlcigmbWluX3N0YXQsICZuYW1lX3Rva2VuKTsKKwkJICAgIEdTU19VTkxPQ0tf
TVVURVgocGFyYW1zLT51dGlscyk7CisJCX0KIAkJU0VURVJST1IodGV4dC0+dXRpbHMsICJHU1NB
UEkgRmFpbHVyZSIpOwogCQlzYXNsX2dzc19mcmVlX2NvbnRleHRfY29udGVudHModGV4dCk7CiAJ
CXJldHVybiBTQVNMX0ZBSUw7CkBAIC0xMzQ2LDcgKzE0ODcsOSBAQAogCQkJCQkgU0FTTF9DVV9B
VVRISUQgfCBTQVNMX0NVX0FVVEhaSUQsCiAJCQkJCSBvcGFyYW1zKTsKIAkgICAgfQorCSAgICBH
U1NfTE9DS19NVVRFWChwYXJhbXMtPnV0aWxzKTsKIAkgICAgZ3NzX3JlbGVhc2VfYnVmZmVyKCZt
aW5fc3RhdCwgJm5hbWVfdG9rZW4pOworCSAgICBHU1NfVU5MT0NLX01VVEVYKHBhcmFtcy0+dXRp
bHMpOwogCSAgICAKIAkgICAgaWYgKHJldCAhPSBTQVNMX09LKSByZXR1cm4gcmV0OwogCSAgICAK
QEAgLTEzNjUsMTggKzE1MDgsMjMgQEAKIAlyZWFsX2lucHV0X3Rva2VuLnZhbHVlID0gKHZvaWQg
Kikgc2VydmVyaW47CiAJcmVhbF9pbnB1dF90b2tlbi5sZW5ndGggPSBzZXJ2ZXJpbmxlbjsKIAkK
KwlHU1NfTE9DS19NVVRFWChwYXJhbXMtPnV0aWxzKTsKIAltYWpfc3RhdCA9IGdzc191bndyYXAo
Jm1pbl9zdGF0LAogCQkJICAgICAgdGV4dC0+Z3NzX2N0eCwKIAkJCSAgICAgIGlucHV0X3Rva2Vu
LAogCQkJICAgICAgb3V0cHV0X3Rva2VuLAogCQkJICAgICAgTlVMTCwKIAkJCSAgICAgIE5VTEwp
OworCUdTU19VTkxPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CiAJCiAJaWYgKEdTU19FUlJPUiht
YWpfc3RhdCkpIHsKIAkgICAgc2FzbF9nc3Nfc2V0ZXJyb3IodGV4dC0+dXRpbHMsIG1hal9zdGF0
LCBtaW5fc3RhdCk7CiAJICAgIHNhc2xfZ3NzX2ZyZWVfY29udGV4dF9jb250ZW50cyh0ZXh0KTsK
LQkgICAgaWYgKG91dHB1dF90b2tlbi0+dmFsdWUpCisJICAgIGlmIChvdXRwdXRfdG9rZW4tPnZh
bHVlKSB7CisJCUdTU19MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMpOwogCQlnc3NfcmVsZWFzZV9i
dWZmZXIoJm1pbl9zdGF0LCBvdXRwdXRfdG9rZW4pOworCQlHU1NfVU5MT0NLX01VVEVYKHBhcmFt
cy0+dXRpbHMpOworCSAgICB9CiAJICAgIHJldHVybiBTQVNMX0ZBSUw7CiAJfQogCQpAQCAtMTQz
OCw3ICsxNTg2LDkgQEAKIAkgICAgb3BhcmFtcy0+bWF4b3V0YnVmIC09IDUwOwogCX0KIAkKKwlH
U1NfTE9DS19NVVRFWChwYXJhbXMtPnV0aWxzKTsKIAlnc3NfcmVsZWFzZV9idWZmZXIoJm1pbl9z
dGF0LCBvdXRwdXRfdG9rZW4pOworCUdTU19VTkxPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CiAJ
CiAJLyogb3BhcmFtcy0+dXNlciBpcyBhbHdheXMgc2V0LCBkdWUgdG8gY2Fub25fdXNlciByZXF1
aXJlbWVudHMuCiAJICogTWFrZSBzdXJlIHRoZSBjbGllbnQgYWN0dWFsbHkgcmVxdWVzdGVkIGl0
IHRob3VnaCwgYnkgY2hlY2tpbmcKQEAgLTE0NzcsNiArMTYyNyw3IEBACiAgICAgICAgIH0KIAko
KHVuc2lnbmVkIGNoYXIgKilpbnB1dF90b2tlbi0+dmFsdWUpWzBdID0gbXljaG9pY2U7CiAJCisJ
R1NTX0xPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CiAJbWFqX3N0YXQgPSBnc3Nfd3JhcCAoJm1p
bl9zdGF0LAogCQkJICAgICB0ZXh0LT5nc3NfY3R4LAogCQkJICAgICAwLCAvKiBKdXN0IGludGVn
cml0eSBjaGVja2luZyBoZXJlICovCkBAIC0xNDg0LDE0ICsxNjM1LDE4IEBACiAJCQkgICAgIGlu
cHV0X3Rva2VuLAogCQkJICAgICBOVUxMLAogCQkJICAgICBvdXRwdXRfdG9rZW4pOworCUdTU19V
TkxPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CiAJCiAJcGFyYW1zLT51dGlscy0+ZnJlZShpbnB1
dF90b2tlbi0+dmFsdWUpOwogCWlucHV0X3Rva2VuLT52YWx1ZSA9IE5VTEw7CiAJCiAJaWYgKEdT
U19FUlJPUihtYWpfc3RhdCkpIHsKIAkgICAgc2FzbF9nc3Nfc2V0ZXJyb3IodGV4dC0+dXRpbHMs
IG1hal9zdGF0LCBtaW5fc3RhdCk7Ci0JICAgIGlmIChvdXRwdXRfdG9rZW4tPnZhbHVlKQorCSAg
ICBpZiAob3V0cHV0X3Rva2VuLT52YWx1ZSkgeworCQlHU1NfTE9DS19NVVRFWChwYXJhbXMtPnV0
aWxzKTsKIAkJZ3NzX3JlbGVhc2VfYnVmZmVyKCZtaW5fc3RhdCwgb3V0cHV0X3Rva2VuKTsKKwkJ
R1NTX1VOTE9DS19NVVRFWChwYXJhbXMtPnV0aWxzKTsKKwkgICAgfQogCSAgICBzYXNsX2dzc19m
cmVlX2NvbnRleHRfY29udGVudHModGV4dCk7CiAJICAgIHJldHVybiBTQVNMX0ZBSUw7CiAJfQpA
QCAtMTUwMywxNCArMTY1OCwxOSBAQAogCQlyZXQgPSBfcGx1Z19idWZfYWxsb2ModGV4dC0+dXRp
bHMsICYodGV4dC0+b3V0X2J1ZiksCiAJCQkJICAgICAgJih0ZXh0LT5vdXRfYnVmX2xlbiksICpj
bGllbnRvdXRsZW4pOwogCQlpZiAocmV0ICE9IFNBU0xfT0spIHsKKwkJICAgIEdTU19MT0NLX01V
VEVYKHBhcmFtcy0+dXRpbHMpOwogCQkgICAgZ3NzX3JlbGVhc2VfYnVmZmVyKCZtaW5fc3RhdCwg
b3V0cHV0X3Rva2VuKTsKKwkJICAgIEdTU19VTkxPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CiAJ
CSAgICByZXR1cm4gcmV0OwogCQl9CiAJCW1lbWNweSh0ZXh0LT5vdXRfYnVmLCBvdXRwdXRfdG9r
ZW4tPnZhbHVlLCAqY2xpZW50b3V0bGVuKTsKIAkJKmNsaWVudG91dCA9IHRleHQtPm91dF9idWY7
CiAJICAgIH0KIAkgICAgCisJICAgIEdTU19MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMpOwogCSAg
ICBnc3NfcmVsZWFzZV9idWZmZXIoJm1pbl9zdGF0LCBvdXRwdXRfdG9rZW4pOworCSAgICBHU1Nf
VU5MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMpOworCiAJfQogCQogCXRleHQtPnN0YXRlID0gU0FT
TF9HU1NBUElfU1RBVEVfQVVUSEVOVElDQVRFRDsKQEAgLTE1NzAsNiArMTczMCwxMyBAQAogICAg
ICpvdXRfdmVyc2lvbiA9IFNBU0xfQ0xJRU5UX1BMVUdfVkVSU0lPTjsKICAgICAqcGx1Z2xpc3Qg
PSBnc3NhcGlfY2xpZW50X3BsdWdpbnM7CiAgICAgKnBsdWdjb3VudCA9IDE7CisKKyAgICBpZigh
Z3NzX211dGV4KSB7CisgICAgICBnc3NfbXV0ZXggPSB1dGlscy0+bXV0ZXhfYWxsb2MoKTsKKyAg
ICAgIGlmKCFnc3NfbXV0ZXgpIHsKKyAgICAgICAgcmV0dXJuIFNBU0xfRkFJTDsKKyAgICAgIH0K
KyAgICB9CiAgICAgCiAgICAgcmV0dXJuIFNBU0xfT0s7CiB9Cg==
</data>        

          </attachment>
          <attachment
              isobsolete="1"
              ispatch="1"
              isprivate="0"
          >
            <attachid>295</attachid>
            <date>2004-07-15 13:17 EDT</date>
            <desc>cleaned up patch for current SASL</desc>
            <filename>mutex.patch</filename>
            <type>text/plain</type>
            <size>22616</size>
            <attacher>rjs3@andrew.cmu.edu</attacher>
            
              <data encoding="base64">SW5kZXg6IGdzc2FwaS5jCj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09
PT09PT09PT09PT09PT09PT09PT09PT09PT0KUkNTIGZpbGU6IC9hZnMvYW5kcmV3LmNtdS5lZHUv
c3lzdGVtL2N2cy9zcmMvc2FzbC9wbHVnaW5zL2dzc2FwaS5jLHYKcmV0cmlldmluZyByZXZpc2lv
biAxLjkwCmRpZmYgLXUgLXIxLjkwIGdzc2FwaS5jCi0tLSBnc3NhcGkuYwk2IEp1bCAyMDA0IDIx
OjU1OjQ3IC0wMDAwCTEuOTAKKysrIGdzc2FwaS5jCTE1IEp1bCAyMDA0IDE2OjI3OjEwIC0wMDAw
CkBAIC0xMjIsNiArMTIyLDIzIEBACiAgKiBDeWJlclNhZmUgKGh0dHA6Ly93d3cuY3liZXJzYWZl
LmNvbS8pIGFuZCBTRUFNLgogICovCiAKKyNpZmRlZiBHU1NfVVNFX01VVEVYRVMKKyNkZWZpbmUg
R1NTX0xPQ0tfTVVURVgodXRpbHMpICBcCisgICAgaWYoKChzYXNsX3V0aWxzX3QgKikodXRpbHMp
KS0+bXV0ZXhfbG9jayhnc3NfbXV0ZXgpICE9IDApIHsgXAorICAgICAgIHJldHVybiBTQVNMX0ZB
SUw7IFwKKyAgICB9CisKKyNkZWZpbmUgR1NTX1VOTE9DS19NVVRFWCh1dGlscykgXAorICAgIGlm
KCgoc2FzbF91dGlsc190ICopKHV0aWxzKSktPm11dGV4X3VubG9jayhnc3NfbXV0ZXgpICE9IDAp
IHsgXAorICAgICAgICByZXR1cm4gU0FTTF9GQUlMOyBcCisgICAgfQorCitzdGF0aWMgdm9pZCAq
Z3NzX211dGV4ID0gTlVMTDsKKyNlbHNlCisjZGVmaW5lIEdTU19MT0NLX01VVEVYKHV0aWxzKQor
I2RlZmluZSBHU1NfVU5MT0NLX01VVEVYKHV0aWxzKQorI2VuZGlmCisKIHR5cGVkZWYgc3RydWN0
IGNvbnRleHQgewogICAgIGludCBzdGF0ZTsKICAgICAKQEAgLTE2NCw5ICsxODEsOSBAQAogI2Rl
ZmluZSBzYXNsX2dzc19sb2coeCx5LHopIHNhc2xfZ3NzX3NldGVycm9yXyh4LHkseiwxKQogI2Rl
ZmluZSBzYXNsX2dzc19zZXRlcnJvcih4LHkseikgc2FzbF9nc3Nfc2V0ZXJyb3JfKHgseSx6LDAp
CiAKLXN0YXRpYyB2b2lkCitzdGF0aWMgaW50CiBzYXNsX2dzc19zZXRlcnJvcl8oY29uc3Qgc2Fz
bF91dGlsc190ICp1dGlscywgT01fdWludDMyIG1haiwgT01fdWludDMyIG1pbiwKLQlpbnQgbG9n
b25seSkKKwkJICAgaW50IGxvZ29ubHkpCiB7CiAgICAgT01fdWludDMyIG1hal9zdGF0LCBtaW5f
c3RhdDsKICAgICBnc3NfYnVmZmVyX2Rlc2MgbXNnOwpAQCAtMTc2LDE5ICsxOTMsMjAgQEAKICAg
ICBzaXplX3QgbGVuLCBjdXJsZW4gPSAwOwogICAgIGNvbnN0IGNoYXIgcHJlZml4W10gPSAiR1NT
QVBJIEVycm9yOiAiOwogICAgIAotICAgIGlmKCF1dGlscykgcmV0dXJuOwotICAgIAogICAgIGxl
biA9IHNpemVvZihwcmVmaXgpOwogICAgIHJldCA9IF9wbHVnX2J1Zl9hbGxvYyh1dGlscywgJm91
dCwgJmN1cmxlbiwgMjU2KTsKLSAgICBpZihyZXQgIT0gU0FTTF9PSykgcmV0dXJuOworICAgIGlm
KHJldCAhPSBTQVNMX09LKSByZXR1cm4gU0FTTF9PSzsKICAgICAKICAgICBzdHJjcHkob3V0LCBw
cmVmaXgpOwogICAgIAogICAgIG1zZ19jdHggPSAwOwogICAgIHdoaWxlICgxKSB7CisJR1NTX0xP
Q0tfTVVURVgodXRpbHMpOwogCW1hal9zdGF0ID0gZ3NzX2Rpc3BsYXlfc3RhdHVzKCZtaW5fc3Rh
dCwgbWFqLAogCQkJCSAgICAgIEdTU19DX0dTU19DT0RFLCBHU1NfQ19OVUxMX09JRCwKIAkJCQkg
ICAgICAmbXNnX2N0eCwgJm1zZyk7CisJR1NTX1VOTE9DS19NVVRFWCh1dGlscyk7CisJCiAJaWYo
R1NTX0VSUk9SKG1hal9zdGF0KSkgewogCSAgICBpZiAobG9nb25seSkgewogCQl1dGlscy0+bG9n
KHV0aWxzLT5jb25uLCBTQVNMX0xPR19GQUlMLApAQCAtMTk5LDcgKzIxNyw3IEBACiAJCQkJIihj
b3VsZCBub3QgZ2V0IG1ham9yIGVycm9yIG1lc3NhZ2UpIik7CiAJICAgIH0KIAkgICAgdXRpbHMt
PmZyZWUob3V0KTsKLQkgICAgcmV0dXJuOworCSAgICByZXR1cm4gU0FTTF9PSzsKIAl9CiAJCiAJ
bGVuICs9IGxlbiArIG1zZy5sZW5ndGg7CkBAIC0yMDcsMTIgKzIyNSwxNCBAQAogCQogCWlmKHJl
dCAhPSBTQVNMX09LKSB7CiAJICAgIHV0aWxzLT5mcmVlKG91dCk7Ci0JICAgIHJldHVybjsKKwkg
ICAgcmV0dXJuIFNBU0xfT0s7CiAJfQogCQogCXN0cmNhdChvdXQsIG1zZy52YWx1ZSk7CiAJCisJ
R1NTX0xPQ0tfTVVURVgodXRpbHMpOwogCWdzc19yZWxlYXNlX2J1ZmZlcigmbWluX3N0YXQsICZt
c2cpOworCUdTU19VTkxPQ0tfTVVURVgodXRpbHMpOwogCQogCWlmICghbXNnX2N0eCkKIAkgICAg
YnJlYWs7CkBAIC0yMjQsMTYgKzI0NCwxOSBAQAogICAgIHJldCA9IF9wbHVnX2J1Zl9hbGxvYyh1
dGlscywgJm91dCwgJmN1cmxlbiwgbGVuKTsKICAgICBpZihyZXQgIT0gU0FTTF9PSykgewogCXV0
aWxzLT5mcmVlKG91dCk7Ci0JcmV0dXJuOworCXJldHVybiBTQVNMX05PTUVNOwogICAgIH0KICAg
ICAKICAgICBzdHJjYXQob3V0LCAiICgiKTsKICAgICAKICAgICBtc2dfY3R4ID0gMDsKICAgICB3
aGlsZSAoMSkgeworCUdTU19MT0NLX01VVEVYKHV0aWxzKTsKIAltYWpfc3RhdCA9IGdzc19kaXNw
bGF5X3N0YXR1cygmbWluX3N0YXQsIG1pbiwKIAkJCQkgICAgICBHU1NfQ19NRUNIX0NPREUsIEdT
U19DX05VTExfT0lELAogCQkJCSAgICAgICZtc2dfY3R4LCAmbXNnKTsKKwlHU1NfVU5MT0NLX01V
VEVYKHV0aWxzKTsKKwkKIAlpZihHU1NfRVJST1IobWFqX3N0YXQpKSB7CiAJICAgIGlmIChsb2dv
bmx5KSB7CiAJCXV0aWxzLT5sb2codXRpbHMtPmNvbm4sIFNBU0xfTE9HX0ZBSUwsCkBAIC0yNDQs
MjAgKzI2NywyMiBAQAogCQkJCSIoY291bGQgbm90IGdldCBtaW5vciBlcnJvciBtZXNzYWdlKSIp
OwogCSAgICB9CiAJICAgIHV0aWxzLT5mcmVlKG91dCk7Ci0JICAgIHJldHVybjsKKwkgICAgcmV0
dXJuIFNBU0xfT0s7CiAJfQogCQogCWxlbiArPSBsZW4gKyBtc2cubGVuZ3RoOworCiAJcmV0ID0g
X3BsdWdfYnVmX2FsbG9jKHV0aWxzLCAmb3V0LCAmY3VybGVuLCBsZW4pOwotCQogCWlmKHJldCAh
PSBTQVNMX09LKSB7CiAJICAgIHV0aWxzLT5mcmVlKG91dCk7Ci0JICAgIHJldHVybjsKKwkgICAg
cmV0dXJuIFNBU0xfTk9NRU07CiAJfQogCQogCXN0cmNhdChvdXQsIG1zZy52YWx1ZSk7CiAJCisJ
R1NTX0xPQ0tfTVVURVgodXRpbHMpOwogCWdzc19yZWxlYXNlX2J1ZmZlcigmbWluX3N0YXQsICZt
c2cpOworCUdTU19VTkxPQ0tfTVVURVgodXRpbHMpOwogCQogCWlmICghbXNnX2N0eCkKIAkgICAg
YnJlYWs7CkBAIC0yNjcsNyArMjkyLDcgQEAKICAgICByZXQgPSBfcGx1Z19idWZfYWxsb2ModXRp
bHMsICZvdXQsICZjdXJsZW4sIGxlbik7CiAgICAgaWYocmV0ICE9IFNBU0xfT0spIHsKIAl1dGls
cy0+ZnJlZShvdXQpOwotCXJldHVybjsKKwlyZXR1cm4gU0FTTF9OT01FTTsKICAgICB9CiAgICAg
CiAgICAgc3RyY2F0KG91dCwgIikiKTsKQEAgLTI3OCw2ICszMDMsOCBAQAogCXV0aWxzLT5zZXRl
cnJvcih1dGlscy0+Y29ubiwgMCwgb3V0KTsKICAgICB9CiAgICAgdXRpbHMtPmZyZWUob3V0KTsK
KworICAgIHJldHVybiBTQVNMX09LOwogfQogCiBzdGF0aWMgaW50IApAQCAtMzE0LDYgKzM0MSw3
IEBACiAgICAgb3V0cHV0X3Rva2VuLT52YWx1ZSA9IE5VTEw7CiAgICAgb3V0cHV0X3Rva2VuLT5s
ZW5ndGggPSAwOwogICAgIAorICAgIEdTU19MT0NLX01VVEVYKHRleHQtPnV0aWxzKTsKICAgICBt
YWpfc3RhdCA9IGdzc193cmFwICgmbWluX3N0YXQsCiAJCQkgdGV4dC0+Z3NzX2N0eCwKIAkJCSBw
cml2YWN5LApAQCAtMzIxLDEyICszNDksMTYgQEAKIAkJCSBpbnB1dF90b2tlbiwKIAkJCSBOVUxM
LAogCQkJIG91dHB1dF90b2tlbik7CisgICAgR1NTX1VOTE9DS19NVVRFWCh0ZXh0LT51dGlscyk7
CiAgICAgCiAgICAgaWYgKEdTU19FUlJPUihtYWpfc3RhdCkpCiAJewogCSAgICBzYXNsX2dzc19z
ZXRlcnJvcih0ZXh0LT51dGlscywgbWFqX3N0YXQsIG1pbl9zdGF0KTsKLQkgICAgaWYgKG91dHB1
dF90b2tlbi0+dmFsdWUpCisJICAgIGlmIChvdXRwdXRfdG9rZW4tPnZhbHVlKSB7CisJCUdTU19M
T0NLX01VVEVYKHRleHQtPnV0aWxzKTsKIAkJZ3NzX3JlbGVhc2VfYnVmZmVyKCZtaW5fc3RhdCwg
b3V0cHV0X3Rva2VuKTsKKwkJR1NTX1VOTE9DS19NVVRFWCh0ZXh0LT51dGlscyk7CisJICAgIH0K
IAkgICAgcmV0dXJuIFNBU0xfRkFJTDsKIAl9CiAgICAgCkBAIC0zMzcsNyArMzY5LDkgQEAKIAkJ
CSAgICAgICYodGV4dC0+ZW5jb2RlX2J1Zl9sZW4pLCBvdXRwdXRfdG9rZW4tPmxlbmd0aCArIDQp
OwogCQogCWlmIChyZXQgIT0gU0FTTF9PSykgeworCSAgICBHU1NfTE9DS19NVVRFWCh0ZXh0LT51
dGlscyk7CiAJICAgIGdzc19yZWxlYXNlX2J1ZmZlcigmbWluX3N0YXQsIG91dHB1dF90b2tlbik7
CisJICAgIEdTU19VTkxPQ0tfTVVURVgodGV4dC0+dXRpbHMpOwogCSAgICByZXR1cm4gcmV0Owog
CX0KIAkKQEAgLTM1Miw5ICszODYsMTEgQEAKICAgICAKICAgICAqb3V0cHV0ID0gdGV4dC0+ZW5j
b2RlX2J1ZjsKICAgICAKLSAgICBpZiAob3V0cHV0X3Rva2VuLT52YWx1ZSkKKyAgICBpZiAob3V0
cHV0X3Rva2VuLT52YWx1ZSkgeworCUdTU19MT0NLX01VVEVYKHRleHQtPnV0aWxzKTsKIAlnc3Nf
cmVsZWFzZV9idWZmZXIoJm1pbl9zdGF0LCBvdXRwdXRfdG9rZW4pOwotICAgIAorCUdTU19VTkxP
Q0tfTVVURVgodGV4dC0+dXRpbHMpOworICAgIH0gCiAgICAgcmV0dXJuIFNBU0xfT0s7CiB9CiAK
QEAgLTM5NSwxOCArNDMxLDIzIEBACiAgICAgb3V0cHV0X3Rva2VuLT52YWx1ZSA9IE5VTEw7CiAg
ICAgb3V0cHV0X3Rva2VuLT5sZW5ndGggPSAwOwogICAgIAorICAgIEdTU19MT0NLX01VVEVYKHRl
eHQtPnV0aWxzKTsKICAgICBtYWpfc3RhdCA9IGdzc191bndyYXAgKCZtaW5fc3RhdCwKIAkJCSAg
IHRleHQtPmdzc19jdHgsCiAJCQkgICBpbnB1dF90b2tlbiwKIAkJCSAgIG91dHB1dF90b2tlbiwK
IAkJCSAgIE5VTEwsCiAJCQkgICBOVUxMKTsKKyAgICBHU1NfVU5MT0NLX01VVEVYKHRleHQtPnV0
aWxzKTsKICAgICAKICAgICBpZiAoR1NTX0VSUk9SKG1hal9zdGF0KSkKIAl7CiAJICAgIHNhc2xf
Z3NzX3NldGVycm9yKHRleHQtPnV0aWxzLG1hal9zdGF0LG1pbl9zdGF0KTsKLQkgICAgaWYgKG91
dHB1dF90b2tlbi0+dmFsdWUpCisJICAgIGlmIChvdXRwdXRfdG9rZW4tPnZhbHVlKSB7CisJCUdT
U19MT0NLX01VVEVYKHRleHQtPnV0aWxzKTsKIAkJZ3NzX3JlbGVhc2VfYnVmZmVyKCZtaW5fc3Rh
dCwgb3V0cHV0X3Rva2VuKTsKKwkJR1NTX1VOTE9DS19NVVRFWCh0ZXh0LT51dGlscyk7CisJICAg
IH0KIAkgICAgcmV0dXJuIFNBU0xfRkFJTDsKIAl9CiAgICAgCkBAIC00MTksMTMgKzQ2MCwxNyBA
QAogCQkJCSAgICAgJnRleHQtPmRlY29kZV9vbmNlX2J1Zl9sZW4sCiAJCQkJICAgICAqb3V0cHV0
bGVuKTsKIAkgICAgaWYocmVzdWx0ICE9IFNBU0xfT0spIHsKKwkJR1NTX0xPQ0tfTVVURVgodGV4
dC0+dXRpbHMpOwogCQlnc3NfcmVsZWFzZV9idWZmZXIoJm1pbl9zdGF0LCBvdXRwdXRfdG9rZW4p
OworCQlHU1NfVU5MT0NLX01VVEVYKHRleHQtPnV0aWxzKTsKIAkJcmV0dXJuIHJlc3VsdDsKIAkg
ICAgfQogCSAgICAqb3V0cHV0ID0gdGV4dC0+ZGVjb2RlX29uY2VfYnVmOwogCSAgICBtZW1jcHko
Km91dHB1dCwgb3V0cHV0X3Rva2VuLT52YWx1ZSwgKm91dHB1dGxlbik7CiAJfQorCUdTU19MT0NL
X01VVEVYKHRleHQtPnV0aWxzKTsKIAlnc3NfcmVsZWFzZV9idWZmZXIoJm1pbl9zdGF0LCBvdXRw
dXRfdG9rZW4pOworCUdTU19VTkxPQ0tfTVVURVgodGV4dC0+dXRpbHMpOwogICAgIH0KICAgICAK
ICAgICByZXR1cm4gU0FTTF9PSzsKQEAgLTQ0Nyw3ICs0OTIsNyBAQAogICAgIHJldHVybiByZXQ7
CiB9CiAKLXN0YXRpYyBjb250ZXh0X3QgKmdzc19uZXdfY29udGV4dChjb25zdCBzYXNsX3V0aWxz
X3QgKnV0aWxzKQorc3RhdGljIGNvbnRleHRfdCAqc2FzbF9nc3NfbmV3X2NvbnRleHQoY29uc3Qg
c2FzbF91dGlsc190ICp1dGlscykKIHsKICAgICBjb250ZXh0X3QgKnJldDsKICAgICAKQEAgLTQ2
MCwxNCArNTA1LDE3IEBACiAgICAgcmV0dXJuIHJldDsKIH0KIAotc3RhdGljIHZvaWQgc2FzbF9n
c3NfZnJlZV9jb250ZXh0X2NvbnRlbnRzKGNvbnRleHRfdCAqdGV4dCkKK3N0YXRpYyBpbnQgc2Fz
bF9nc3NfZnJlZV9jb250ZXh0X2NvbnRlbnRzKGNvbnRleHRfdCAqdGV4dCkKIHsKICAgICBPTV91
aW50MzIgbWFqX3N0YXQsIG1pbl9zdGF0OwogICAgIAotICAgIGlmICghdGV4dCkgcmV0dXJuOwor
ICAgIGlmICghdGV4dCkgcmV0dXJuIFNBU0xfT0s7CiAgICAgCisgICAgR1NTX0xPQ0tfTVVURVgo
dGV4dC0+dXRpbHMpOworCiAgICAgaWYgKHRleHQtPmdzc19jdHggIT0gR1NTX0NfTk9fQ09OVEVY
VCkgewotCW1hal9zdGF0ID0gZ3NzX2RlbGV0ZV9zZWNfY29udGV4dCAoJm1pbl9zdGF0LCZ0ZXh0
LT5nc3NfY3R4LEdTU19DX05PX0JVRkZFUik7CisJbWFqX3N0YXQgPSBnc3NfZGVsZXRlX3NlY19j
b250ZXh0KCZtaW5fc3RhdCwmdGV4dC0+Z3NzX2N0eCwKKwkJCQkJICBHU1NfQ19OT19CVUZGRVIp
OwogCXRleHQtPmdzc19jdHggPSBHU1NfQ19OT19DT05URVhUOwogICAgIH0KICAgICAKQEAgLTQ5
MCw2ICs1MzgsOCBAQAogCW1hal9zdGF0ID0gZ3NzX3JlbGVhc2VfY3JlZCgmbWluX3N0YXQsICZ0
ZXh0LT5jbGllbnRfY3JlZHMpOwogCXRleHQtPmNsaWVudF9jcmVkcyA9IEdTU19DX05PX0NSRURF
TlRJQUw7CiAgICAgfQorCisgICAgR1NTX1VOTE9DS19NVVRFWCh0ZXh0LT51dGlscyk7CiAgICAg
CiAgICAgaWYgKHRleHQtPm91dF9idWYpIHsKIAl0ZXh0LT51dGlscy0+ZnJlZSh0ZXh0LT5vdXRf
YnVmKTsKQEAgLTUyMywxMiArNTczLDIxIEBACiAJdGV4dC0+dXRpbHMtPmZyZWUodGV4dC0+YXV0
aGlkKTsKIAl0ZXh0LT5hdXRoaWQgPSBOVUxMOwogICAgIH0KKworICAgIHJldHVybiBTQVNMX09L
OworCiB9CiAKIHN0YXRpYyB2b2lkIGdzc2FwaV9jb21tb25fbWVjaF9kaXNwb3NlKHZvaWQgKmNv
bm5fY29udGV4dCwKIAkJCQkgICAgICAgY29uc3Qgc2FzbF91dGlsc190ICp1dGlscykKIHsKICAg
ICBzYXNsX2dzc19mcmVlX2NvbnRleHRfY29udGVudHMoKGNvbnRleHRfdCAqKShjb25uX2NvbnRl
eHQpKTsKKyNpZmRlZiBHU1NfVVNFX01VVEVYRVMKKyAgICBpZiAoZ3NzX211dGV4KSB7CisgICAg
ICB1dGlscy0+bXV0ZXhfZnJlZShnc3NfbXV0ZXgpOworICAgICAgZ3NzX211dGV4PU5VTEw7Cisg
ICAgfQorI2VuZGlmCiAgICAgdXRpbHMtPmZyZWUoY29ubl9jb250ZXh0KTsKIH0KIApAQCAtNTQz
LDcgKzYwMiw3IEBACiB7CiAgICAgY29udGV4dF90ICp0ZXh0OwogICAgIAotICAgIHRleHQgPSBn
c3NfbmV3X2NvbnRleHQocGFyYW1zLT51dGlscyk7CisgICAgdGV4dCA9IHNhc2xfZ3NzX25ld19j
b250ZXh0KHBhcmFtcy0+dXRpbHMpOwogICAgIGlmICh0ZXh0ID09IE5VTEwpIHsKIAlNRU1FUlJP
UihwYXJhbXMtPnV0aWxzKTsKIAlyZXR1cm4gU0FTTF9OT01FTTsKQEAgLTYwNCwxMCArNjYzLDEy
IEBACiAJICAgIH0KIAkgICAgc3ByaW50ZihuYW1lX3Rva2VuLnZhbHVlLCIlc0AlcyIsIHBhcmFt
cy0+c2VydmljZSwgcGFyYW1zLT5zZXJ2ZXJGUUROKTsKIAkgICAgCisJICAgIEdTU19MT0NLX01V
VEVYKHBhcmFtcy0+dXRpbHMpOwogCSAgICBtYWpfc3RhdCA9IGdzc19pbXBvcnRfbmFtZSAoJm1p
bl9zdGF0LAogCQkJCQkmbmFtZV90b2tlbiwKIAkJCQkJR1NTX0NfTlRfSE9TVEJBU0VEX1NFUlZJ
Q0UsCiAJCQkJCSZ0ZXh0LT5zZXJ2ZXJfbmFtZSk7CisJICAgIEdTU19VTkxPQ0tfTVVURVgocGFy
YW1zLT51dGlscyk7CiAJICAgIAogCSAgICBwYXJhbXMtPnV0aWxzLT5mcmVlKG5hbWVfdG9rZW4u
dmFsdWUpOwogCSAgICBuYW1lX3Rva2VuLnZhbHVlID0gTlVMTDsKQEAgLTYxOSwxMCArNjgwLDEz
IEBACiAJICAgIH0KIAkgICAgCiAJICAgIGlmICggdGV4dC0+c2VydmVyX2NyZWRzICE9IEdTU19D
X05PX0NSRURFTlRJQUwpIHsKKwkgICAgCUdTU19MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMpOwog
CQltYWpfc3RhdCA9IGdzc19yZWxlYXNlX2NyZWQoJm1pbl9zdGF0LCAmdGV4dC0+c2VydmVyX2Ny
ZWRzKTsKKwkgICAgCUdTU19VTkxPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CiAJCXRleHQtPnNl
cnZlcl9jcmVkcyA9IEdTU19DX05PX0NSRURFTlRJQUw7CiAJICAgIH0KIAkgICAgCisJICAgIEdT
U19MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMpOwogCSAgICBtYWpfc3RhdCA9IGdzc19hY3F1aXJl
X2NyZWQoJm1pbl9zdGF0LCAKIAkJCQkJdGV4dC0+c2VydmVyX25hbWUsCiAJCQkJCUdTU19DX0lO
REVGSU5JVEUsIApAQCAtNjMxLDYgKzY5NSw3IEBACiAJCQkJCSZ0ZXh0LT5zZXJ2ZXJfY3JlZHMs
IAogCQkJCQlOVUxMLCAKIAkJCQkJTlVMTCk7CisJICAgIEdTU19VTkxPQ0tfTVVURVgocGFyYW1z
LT51dGlscyk7CiAJICAgIAogCSAgICBpZiAoR1NTX0VSUk9SKG1hal9zdGF0KSkgewogCQlzYXNs
X2dzc19zZXRlcnJvcih0ZXh0LT51dGlscywgbWFqX3N0YXQsIG1pbl9zdGF0KTsKQEAgLTY0NSw2
ICs3MTAsNyBAQAogCX0KIAkKIAkKKwlHU1NfTE9DS19NVVRFWChwYXJhbXMtPnV0aWxzKTsKIAlt
YWpfc3RhdCA9CiAJICAgIGdzc19hY2NlcHRfc2VjX2NvbnRleHQoJm1pbl9zdGF0LAogCQkJCSAg
ICYodGV4dC0+Z3NzX2N0eCksCkBAIC02NTcsMTIgKzcyMywxNSBAQAogCQkJCSAgICZvdXRfZmxh
Z3MsCiAJCQkJICAgTlVMTCwKIAkJCQkgICAmKHRleHQtPmNsaWVudF9jcmVkcykpOworCUdTU19V
TkxPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CiAJCiAJaWYgKEdTU19FUlJPUihtYWpfc3RhdCkp
IHsKIAkgICAgc2FzbF9nc3NfbG9nKHRleHQtPnV0aWxzLCBtYWpfc3RhdCwgbWluX3N0YXQpOwog
CSAgICB0ZXh0LT51dGlscy0+c2V0ZXJyb3IodGV4dC0+dXRpbHMtPmNvbm4sIFNBU0xfTk9MT0cs
ICJHU1NBUEkgRmFpbHVyZTogZ3NzX2FjY2VwdF9zZWNfY29udGV4dCIpOwogCSAgICBpZiAob3V0
cHV0X3Rva2VuLT52YWx1ZSkgeworCQlHU1NfTE9DS19NVVRFWChwYXJhbXMtPnV0aWxzKTsKIAkJ
Z3NzX3JlbGVhc2VfYnVmZmVyKCZtaW5fc3RhdCwgb3V0cHV0X3Rva2VuKTsKKwkJR1NTX1VOTE9D
S19NVVRFWChwYXJhbXMtPnV0aWxzKTsKIAkgICAgfQogCSAgICBzYXNsX2dzc19mcmVlX2NvbnRl
eHRfY29udGVudHModGV4dCk7CiAJICAgIHJldHVybiBTQVNMX0JBREFVVEg7CkBAIC02NzMsNyAr
NzQyLDggQEAKIAkgICAgKCEob3V0X2ZsYWdzICYgR1NTX0NfREVMRUdfRkxBRykgfHwKIAkgICAg
IHRleHQtPmNsaWVudF9jcmVkcyA9PSBHU1NfQ19OT19DUkVERU5USUFMKSApIAogCXsKLQkgICAg
dGV4dC0+dXRpbHMtPnNldGVycm9yKHRleHQtPnV0aWxzLT5jb25uLCBTQVNMX0xPR19XQVJOLCAi
R1NTQVBJIHdhcm5pbmc6IG5vIGNyZWRlbnRpYWxzIHdlcmUgcGFzc2VkIik7CisJICAgIHRleHQt
PnV0aWxzLT5zZXRlcnJvcih0ZXh0LT51dGlscy0+Y29ubiwgU0FTTF9MT0dfV0FSTiwKKwkJCQkg
ICJHU1NBUEkgd2FybmluZzogbm8gY3JlZGVudGlhbHMgd2VyZSBwYXNzZWQiKTsKIAkgICAgLyog
Y29udGludWUgd2l0aCBhdXRoZW50aWNhdGlvbiAqLwogCX0KIAkgICAgCkBAIC02ODQsMTQgKzc1
NCwxOCBAQAogCQlyZXQgPSBfcGx1Z19idWZfYWxsb2ModGV4dC0+dXRpbHMsICYodGV4dC0+b3V0
X2J1ZiksCiAJCQkJICAgICAgJih0ZXh0LT5vdXRfYnVmX2xlbiksICpzZXJ2ZXJvdXRsZW4pOwog
CQlpZihyZXQgIT0gU0FTTF9PSykgeworCQkgICAgR1NTX0xPQ0tfTVVURVgocGFyYW1zLT51dGls
cyk7CiAJCSAgICBnc3NfcmVsZWFzZV9idWZmZXIoJm1pbl9zdGF0LCBvdXRwdXRfdG9rZW4pOwor
CQkgICAgR1NTX1VOTE9DS19NVVRFWChwYXJhbXMtPnV0aWxzKTsKIAkJICAgIHJldHVybiByZXQ7
CiAJCX0KIAkJbWVtY3B5KHRleHQtPm91dF9idWYsIG91dHB1dF90b2tlbi0+dmFsdWUsICpzZXJ2
ZXJvdXRsZW4pOwogCQkqc2VydmVyb3V0ID0gdGV4dC0+b3V0X2J1ZjsKIAkgICAgfQogCSAgICAK
KwkgICAgR1NTX0xPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CiAJICAgIGdzc19yZWxlYXNlX2J1
ZmZlcigmbWluX3N0YXQsIG91dHB1dF90b2tlbik7CisJICAgIEdTU19VTkxPQ0tfTVVURVgocGFy
YW1zLT51dGlscyk7CiAJfSBlbHNlIHsKIAkgICAgLyogTm8gb3V0cHV0IHRva2VuLCBzZW5kIGFu
IGVtcHR5IHN0cmluZyAqLwogCSAgICAqc2VydmVyb3V0ID0gR1NTQVBJX0JMQU5LX1NUUklORzsK
QEAgLTcxNywxOSArNzkxLDI3IEBACiAJCiAJLyogV2UgaWdub3JlIHdoYXRldmVyIHRoZSBjbGll
bnQgc2VudCB1cyBhdCB0aGlzIHN0YWdlICovCiAJCisJR1NTX0xPQ0tfTVVURVgocGFyYW1zLT51
dGlscyk7CiAJbWFqX3N0YXQgPSBnc3NfZGlzcGxheV9uYW1lICgmbWluX3N0YXQsCiAJCQkJICAg
ICB0ZXh0LT5jbGllbnRfbmFtZSwKIAkJCQkgICAgICZuYW1lX3Rva2VuLAogCQkJCSAgICAgTlVM
TCk7CisJR1NTX1VOTE9DS19NVVRFWChwYXJhbXMtPnV0aWxzKTsKIAkKIAlpZiAoR1NTX0VSUk9S
KG1hal9zdGF0KSkgewogCSAgICBpZiAobmFtZV93aXRob3V0X3JlYWxtLnZhbHVlKQogCQlwYXJh
bXMtPnV0aWxzLT5mcmVlKG5hbWVfd2l0aG91dF9yZWFsbS52YWx1ZSk7CiAJICAgIAotCSAgICBp
ZiAobmFtZV90b2tlbi52YWx1ZSkKKwkgICAgaWYgKG5hbWVfdG9rZW4udmFsdWUpIHsKKwkJR1NT
X0xPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CiAJCWdzc19yZWxlYXNlX2J1ZmZlcigmbWluX3N0
YXQsICZuYW1lX3Rva2VuKTsKLQkgICAgaWYgKHdpdGhvdXQpCisJCUdTU19VTkxPQ0tfTVVURVgo
cGFyYW1zLT51dGlscyk7CisJICAgIH0KKwkgICAgaWYgKHdpdGhvdXQpIHsKKwkJR1NTX0xPQ0tf
TVVURVgocGFyYW1zLT51dGlscyk7CiAJCWdzc19yZWxlYXNlX25hbWUoJm1pbl9zdGF0LCAmd2l0
aG91dCk7CisJCUdTU19VTkxPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CisJICAgIH0KIAkgICAg
U0VURVJST1IodGV4dC0+dXRpbHMsICJHU1NBUEkgRmFpbHVyZSIpOwogCSAgICBzYXNsX2dzc19m
cmVlX2NvbnRleHRfY29udGVudHModGV4dCk7CiAJICAgIHJldHVybiBTQVNMX0JBREFVVEg7CkBA
IC03NTUsNiArODM3LDcgQEAKIAkgICAgCiAJICAgIG5hbWVfd2l0aG91dF9yZWFsbS5sZW5ndGgg
PSBzdHJsZW4oIChjaGFyICopIG5hbWVfd2l0aG91dF9yZWFsbS52YWx1ZSApOwogCSAgICAKKwkg
ICAgR1NTX0xPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CiAJICAgIG1hal9zdGF0ID0gZ3NzX2lt
cG9ydF9uYW1lICgmbWluX3N0YXQsCiAJCQkJCSZuYW1lX3dpdGhvdXRfcmVhbG0sCiAJICAgIC8q
IFNvbGFyaXMgOC85IGdzc19pbXBvcnRfbmFtZSBkb2Vzbid0IGFjY2VwdCBHU1NfQ19OVUxMX09J
RCBoZXJlLApAQCAtNzY1LDM1ICs4NDgsNTMgQEAKIAkJCQkJR1NTX0NfTlVMTF9PSUQsCiAjZW5k
aWYKIAkJCQkJJndpdGhvdXQpOworCSAgICBHU1NfVU5MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMp
OwogCSAgICAKIAkgICAgaWYgKEdTU19FUlJPUihtYWpfc3RhdCkpIHsKIAkJcGFyYW1zLT51dGls
cy0+ZnJlZShuYW1lX3dpdGhvdXRfcmVhbG0udmFsdWUpOwotCQlpZiAobmFtZV90b2tlbi52YWx1
ZSkKKwkJaWYgKG5hbWVfdG9rZW4udmFsdWUpIHsKKwkgICAgCSAgICBHU1NfTE9DS19NVVRFWChw
YXJhbXMtPnV0aWxzKTsKIAkJICAgIGdzc19yZWxlYXNlX2J1ZmZlcigmbWluX3N0YXQsICZuYW1l
X3Rva2VuKTsKLQkJaWYgKHdpdGhvdXQpCisJICAgIAkgICAgR1NTX1VOTE9DS19NVVRFWChwYXJh
bXMtPnV0aWxzKTsKKwkJfQorCQlpZiAod2l0aG91dCkgeworCSAgICAJICAgIEdTU19MT0NLX01V
VEVYKHBhcmFtcy0+dXRpbHMpOwogCQkgICAgZ3NzX3JlbGVhc2VfbmFtZSgmbWluX3N0YXQsICZ3
aXRob3V0KTsKKwkgICAgCSAgICBHU1NfVU5MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMpOworCQl9
CiAJCVNFVEVSUk9SKHRleHQtPnV0aWxzLCAiR1NTQVBJIEZhaWx1cmUiKTsKIAkJc2FzbF9nc3Nf
ZnJlZV9jb250ZXh0X2NvbnRlbnRzKHRleHQpOwogCQlyZXR1cm4gU0FTTF9CQURBVVRIOwogCSAg
ICB9CiAJICAgIAorCSAgICBHU1NfTE9DS19NVVRFWChwYXJhbXMtPnV0aWxzKTsKIAkgICAgbWFq
X3N0YXQgPSBnc3NfY29tcGFyZV9uYW1lKCZtaW5fc3RhdCwKIAkJCQkJdGV4dC0+Y2xpZW50X25h
bWUsCiAJCQkJCXdpdGhvdXQsCiAJCQkJCSZlcXVhbCk7CisJICAgIEdTU19VTkxPQ0tfTVVURVgo
cGFyYW1zLT51dGlscyk7CiAJICAgIAogCSAgICBpZiAoR1NTX0VSUk9SKG1hal9zdGF0KSkgewog
CQlwYXJhbXMtPnV0aWxzLT5mcmVlKG5hbWVfd2l0aG91dF9yZWFsbS52YWx1ZSk7Ci0JCWlmIChu
YW1lX3Rva2VuLnZhbHVlKQorCQlpZiAobmFtZV90b2tlbi52YWx1ZSkgeworCSAgICAJICAgIEdT
U19MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMpOwogCQkgICAgZ3NzX3JlbGVhc2VfYnVmZmVyKCZt
aW5fc3RhdCwgJm5hbWVfdG9rZW4pOwotCQlpZiAod2l0aG91dCkKKwkgICAgCSAgICBHU1NfVU5M
T0NLX01VVEVYKHBhcmFtcy0+dXRpbHMpOworCQl9CisJCWlmICh3aXRob3V0KSB7CisJICAgIAkg
ICAgR1NTX0xPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CiAJCSAgICBnc3NfcmVsZWFzZV9uYW1l
KCZtaW5fc3RhdCwgJndpdGhvdXQpOworCSAgICAJICAgIEdTU19VTkxPQ0tfTVVURVgocGFyYW1z
LT51dGlscyk7CisJCX0KIAkJU0VURVJST1IodGV4dC0+dXRpbHMsICJHU1NBUEkgRmFpbHVyZSIp
OwogCQlzYXNsX2dzc19mcmVlX2NvbnRleHRfY29udGVudHModGV4dCk7CiAJCXJldHVybiBTQVNM
X0JBREFVVEg7CiAJICAgIH0KIAkgICAgCisJICAgIEdTU19MT0NLX01VVEVYKHBhcmFtcy0+dXRp
bHMpOwogCSAgICBnc3NfcmVsZWFzZV9uYW1lKCZtaW5fc3RhdCwmd2l0aG91dCk7CisJICAgIEdT
U19VTkxPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CisKIAl9IGVsc2UgewogCSAgICBlcXVhbCA9
IDA7CiAJfQpAQCAtODE0LDExICs5MTUsMTQgQEAKIAkgICAgfQogCX0KIAkKLQlpZiAobmFtZV90
b2tlbi52YWx1ZSkKKwlpZiAobmFtZV90b2tlbi52YWx1ZSkgeworCSAgICBHU1NfTE9DS19NVVRF
WChwYXJhbXMtPnV0aWxzKTsKIAkgICAgZ3NzX3JlbGVhc2VfYnVmZmVyKCZtaW5fc3RhdCwgJm5h
bWVfdG9rZW4pOwotCWlmIChuYW1lX3dpdGhvdXRfcmVhbG0udmFsdWUpCisJICAgIEdTU19VTkxP
Q0tfTVVURVgocGFyYW1zLT51dGlscyk7CisJfQorCWlmIChuYW1lX3dpdGhvdXRfcmVhbG0udmFs
dWUpIHsKIAkgICAgcGFyYW1zLT51dGlscy0+ZnJlZShuYW1lX3dpdGhvdXRfcmVhbG0udmFsdWUp
OwotCQorCX0JCiAJCiAJLyogd2UgaGF2ZSB0byBkZWNpZGUgd2hhdCBzb3J0IG9mIGVuY3J5cHRp
b24vaW50ZWdyaXR5L2V0Yy4sCiAJICAgd2Ugc3VwcG9ydCAqLwpAQCAtODY1LDYgKzk2OSw3IEBA
CiAJcmVhbF9pbnB1dF90b2tlbi52YWx1ZSA9ICh2b2lkICopc2FzbGRhdGE7CiAJcmVhbF9pbnB1
dF90b2tlbi5sZW5ndGggPSA0OwogCQorCUdTU19MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMpOwog
CW1hal9zdGF0ID0gZ3NzX3dyYXAoJm1pbl9zdGF0LAogCQkJICAgIHRleHQtPmdzc19jdHgsCiAJ
CQkgICAgMCwgLyogSnVzdCBpbnRlZ3JpdHkgY2hlY2tpbmcgaGVyZSAqLwpAQCAtODcyLDExICs5
NzcsMTUgQEAKIAkJCSAgICBpbnB1dF90b2tlbiwKIAkJCSAgICBOVUxMLAogCQkJICAgIG91dHB1
dF90b2tlbik7CisJR1NTX1VOTE9DS19NVVRFWChwYXJhbXMtPnV0aWxzKTsKIAkKIAlpZiAoR1NT
X0VSUk9SKG1hal9zdGF0KSkgewogCSAgICBzYXNsX2dzc19zZXRlcnJvcih0ZXh0LT51dGlscywg
bWFqX3N0YXQsIG1pbl9zdGF0KTsKLQkgICAgaWYgKG91dHB1dF90b2tlbi0+dmFsdWUpCisJICAg
IGlmIChvdXRwdXRfdG9rZW4tPnZhbHVlKSB7CisJCUdTU19MT0NLX01VVEVYKHBhcmFtcy0+dXRp
bHMpOwogCQlnc3NfcmVsZWFzZV9idWZmZXIoJm1pbl9zdGF0LCBvdXRwdXRfdG9rZW4pOworCQlH
U1NfVU5MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMpOworCSAgICB9CiAJICAgIHNhc2xfZ3NzX2Zy
ZWVfY29udGV4dF9jb250ZW50cyh0ZXh0KTsKIAkgICAgcmV0dXJuIFNBU0xfRkFJTDsKIAl9CkBA
IC04ODksMTQgKzk5OCwxOCBAQAogCQlyZXQgPSBfcGx1Z19idWZfYWxsb2ModGV4dC0+dXRpbHMs
ICYodGV4dC0+b3V0X2J1ZiksCiAJCQkJICAgICAgJih0ZXh0LT5vdXRfYnVmX2xlbiksICpzZXJ2
ZXJvdXRsZW4pOwogCQlpZihyZXQgIT0gU0FTTF9PSykgeworCQkgICAgR1NTX0xPQ0tfTVVURVgo
cGFyYW1zLT51dGlscyk7CiAJCSAgICBnc3NfcmVsZWFzZV9idWZmZXIoJm1pbl9zdGF0LCBvdXRw
dXRfdG9rZW4pOworCQkgICAgR1NTX1VOTE9DS19NVVRFWChwYXJhbXMtPnV0aWxzKTsKIAkJICAg
IHJldHVybiByZXQ7CiAJCX0KIAkJbWVtY3B5KHRleHQtPm91dF9idWYsIG91dHB1dF90b2tlbi0+
dmFsdWUsICpzZXJ2ZXJvdXRsZW4pOwogCQkqc2VydmVyb3V0ID0gdGV4dC0+b3V0X2J1ZjsKIAkg
ICAgfQogCSAgICAKKwkgICAgR1NTX0xPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CiAJICAgIGdz
c19yZWxlYXNlX2J1ZmZlcigmbWluX3N0YXQsIG91dHB1dF90b2tlbik7CisJICAgIEdTU19VTkxP
Q0tfTVVURVgocGFyYW1zLT51dGlscyk7CiAJfQogCQogCS8qIFdhaXQgZm9yIHNzZiByZXF1ZXN0
IGFuZCBhdXRoaWQgKi8KQEAgLTkxMSwxMiArMTAyNCwxNCBAQAogCXJlYWxfaW5wdXRfdG9rZW4u
dmFsdWUgPSAodm9pZCAqKWNsaWVudGluOwogCXJlYWxfaW5wdXRfdG9rZW4ubGVuZ3RoID0gY2xp
ZW50aW5sZW47CiAJCisJR1NTX0xPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CiAJbWFqX3N0YXQg
PSBnc3NfdW53cmFwKCZtaW5fc3RhdCwKIAkJCSAgICAgIHRleHQtPmdzc19jdHgsCiAJCQkgICAg
ICBpbnB1dF90b2tlbiwKIAkJCSAgICAgIG91dHB1dF90b2tlbiwKIAkJCSAgICAgIE5VTEwsCiAJ
CQkgICAgICBOVUxMKTsKKwlHU1NfVU5MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMpOwogCQogCWlm
IChHU1NfRVJST1IobWFqX3N0YXQpKSB7CiAJICAgIHNhc2xfZ3NzX3NldGVycm9yKHRleHQtPnV0
aWxzLCBtYWpfc3RhdCwgbWluX3N0YXQpOwpAQCAtOTQ2LDggKzEwNjEsMTEgQEAKIAkJICAgICAi
cHJvdG9jb2wgdmlvbGF0aW9uOiBjbGllbnQgcmVxdWVzdGVkIGludmFsaWQgbGF5ZXIiKTsKIAkg
ICAgLyogTWFyayB0aGF0IHdlIGF0dGVtcHRlZCBuZWdvdGlhdGlvbiAqLwogCSAgICBvcGFyYW1z
LT5tZWNoX3NzZiA9IDI7Ci0JICAgIGlmIChvdXRwdXRfdG9rZW4tPnZhbHVlKQorCSAgICBpZiAo
b3V0cHV0X3Rva2VuLT52YWx1ZSkgeworCQlHU1NfTE9DS19NVVRFWChwYXJhbXMtPnV0aWxzKTsK
IAkJZ3NzX3JlbGVhc2VfYnVmZmVyKCZtaW5fc3RhdCwgb3V0cHV0X3Rva2VuKTsKKwkJR1NTX1VO
TE9DS19NVVRFWChwYXJhbXMtPnV0aWxzKTsKKwkgICAgfQogCSAgICBzYXNsX2dzc19mcmVlX2Nv
bnRleHRfY29udGVudHModGV4dCk7CiAJICAgIHJldHVybiBTQVNMX0ZBSUw7CiAJfQpAQCAtOTkw
LDcgKzExMDgsOSBAQAogCX0gZWxzZSB7CiAJICAgIFNFVEVSUk9SKHRleHQtPnV0aWxzLAogCQkg
ICAgICJ0b2tlbiB0b28gc2hvcnQiKTsKKwkgICAgR1NTX0xPQ0tfTVVURVgocGFyYW1zLT51dGls
cyk7CiAJICAgIGdzc19yZWxlYXNlX2J1ZmZlcigmbWluX3N0YXQsIG91dHB1dF90b2tlbik7CisJ
ICAgIEdTU19VTkxPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CiAJICAgIHNhc2xfZ3NzX2ZyZWVf
Y29udGV4dF9jb250ZW50cyh0ZXh0KTsKIAkgICAgcmV0dXJuIFNBU0xfRkFJTDsKIAl9CQpAQCAt
MTAyNiw3ICsxMTQ2LDkgQEAKIAkgICAgfSAgICAKIAl9CiAJCisJR1NTX0xPQ0tfTVVURVgocGFy
YW1zLT51dGlscyk7CiAJZ3NzX3JlbGVhc2VfYnVmZmVyKCZtaW5fc3RhdCwgb3V0cHV0X3Rva2Vu
KTsKKwlHU1NfVU5MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMpOwogCQogCXRleHQtPnN0YXRlID0g
U0FTTF9HU1NBUElfU1RBVEVfQVVUSEVOVElDQVRFRDsKIAkKQEAgLTExMjUsNiArMTI0NywxNSBA
QAogICAgICpvdXRfdmVyc2lvbiA9IFNBU0xfU0VSVkVSX1BMVUdfVkVSU0lPTjsKICAgICAqcGx1
Z2xpc3QgPSBnc3NhcGlfc2VydmVyX3BsdWdpbnM7CiAgICAgKnBsdWdjb3VudCA9IDE7ICAKKwor
I2lmZGVmIEdTU19VU0VfTVVURVhFUworICAgIGlmICghZ3NzX211dGV4KSB7CisgICAgICAgZ3Nz
X211dGV4ID0gdXRpbHMtPm11dGV4X2FsbG9jKCk7CisgICAgICAgaWYgKCFnc3NfbXV0ZXgpIHsK
KyAgICAgICAgICAgcmV0dXJuIFNBU0xfRkFJTDsKKyAgICAgICB9CisgICAgfQorI2VuZGlmCiAg
ICAgCiAgICAgcmV0dXJuIFNBU0xfT0s7CiB9CkBAIC0xMTM4LDcgKzEyNjksNyBAQAogICAgIGNv
bnRleHRfdCAqdGV4dDsKICAgICAKICAgICAvKiBob2xkcyBzdGF0ZSBhcmUgaW4gKi8KLSAgICB0
ZXh0ID0gZ3NzX25ld19jb250ZXh0KHBhcmFtcy0+dXRpbHMpOworICAgIHRleHQgPSBzYXNsX2dz
c19uZXdfY29udGV4dChwYXJhbXMtPnV0aWxzKTsKICAgICBpZiAodGV4dCA9PSBOVUxMKSB7CiAJ
TUVNRVJST1IocGFyYW1zLT51dGlscyk7CiAJcmV0dXJuIFNBU0xfTk9NRU07CkBAIC0xMjM0LDEw
ICsxMzY1LDEyIEBACiAJICAgIAogCSAgICBzcHJpbnRmKG5hbWVfdG9rZW4udmFsdWUsIiVzQCVz
IiwgcGFyYW1zLT5zZXJ2aWNlLCBwYXJhbXMtPnNlcnZlckZRRE4pOwogCSAgICAKKwkgICAgR1NT
X0xPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CiAJICAgIG1hal9zdGF0ID0gZ3NzX2ltcG9ydF9u
YW1lICgmbWluX3N0YXQsCiAJCQkJCSZuYW1lX3Rva2VuLAogCQkJCQlHU1NfQ19OVF9IT1NUQkFT
RURfU0VSVklDRSwKIAkJCQkJJnRleHQtPnNlcnZlcl9uYW1lKTsKKwkgICAgR1NTX1VOTE9DS19N
VVRFWChwYXJhbXMtPnV0aWxzKTsKIAkgICAgCiAJICAgIHBhcmFtcy0+dXRpbHMtPmZyZWUobmFt
ZV90b2tlbi52YWx1ZSk7CiAJICAgIG5hbWVfdG9rZW4udmFsdWUgPSBOVUxMOwpAQCAtMTI2MSw3
ICsxMzk0LDkgQEAKIAkgICAgICogYW5kIG5vIGlucHV0IGZyb20gdGhlIHNlcnZlci4gIEhvd2V2
ZXIsIHRoYW5rcyB0byBJbWFwLAogCSAgICAgKiB3aGljaCBkaXNjYXJkcyBvdXIgZmlyc3Qgb3V0
cHV0LCB0aGlzIGhhcHBlbnMgYWxsIHRoZSB0aW1lLgogCSAgICAgKiBUaHJvdyBhd2F5IHRoZSBj
b250ZXh0IGFuZCB0cnkgYWdhaW4uICovCisJICAgIEdTU19MT0NLX01VVEVYKHBhcmFtcy0+dXRp
bHMpOwogCSAgICBtYWpfc3RhdCA9IGdzc19kZWxldGVfc2VjX2NvbnRleHQgKCZtaW5fc3RhdCwm
dGV4dC0+Z3NzX2N0eCxHU1NfQ19OT19CVUZGRVIpOworCSAgICBHU1NfVU5MT0NLX01VVEVYKHBh
cmFtcy0+dXRpbHMpOwogCSAgICB0ZXh0LT5nc3NfY3R4ID0gR1NTX0NfTk9fQ09OVEVYVDsKIAl9
CiAJICAgIApAQCAtMTI4Miw2ICsxNDE3LDcgQEAKIAlpZiAocGFyYW1zLT5wcm9wcy5zZWN1cml0
eV9mbGFncyAmIFNBU0xfU0VDX1BBU1NfQ1JFREVOVElBTFMpCiAJICAgIHJlcV9mbGFncyA9IHJl
cV9mbGFncyB8ICBHU1NfQ19ERUxFR19GTEFHOwogCisJR1NTX0xPQ0tfTVVURVgocGFyYW1zLT51
dGlscyk7CiAJbWFqX3N0YXQgPSBnc3NfaW5pdF9zZWNfY29udGV4dCgmbWluX3N0YXQsCiAJCQkJ
CUdTU19DX05PX0NSRURFTlRJQUwsCiAJCQkJCSZ0ZXh0LT5nc3NfY3R4LApAQCAtMTI5NSwxMSAr
MTQzMSwxNSBAQAogCQkJCQlvdXRwdXRfdG9rZW4sCiAJCQkJCSZvdXRfcmVxX2ZsYWdzLAogCQkJ
CQlOVUxMKTsKKwlHU1NfVU5MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMpOwogCQogCWlmIChHU1Nf
RVJST1IobWFqX3N0YXQpKSB7CiAJICAgIHNhc2xfZ3NzX3NldGVycm9yKHRleHQtPnV0aWxzLCBt
YWpfc3RhdCwgbWluX3N0YXQpOwotCSAgICBpZiAob3V0cHV0X3Rva2VuLT52YWx1ZSkKKwkgICAg
aWYgKG91dHB1dF90b2tlbi0+dmFsdWUpIHsKKwkJR1NTX0xPQ0tfTVVURVgocGFyYW1zLT51dGls
cyk7CiAJCWdzc19yZWxlYXNlX2J1ZmZlcigmbWluX3N0YXQsIG91dHB1dF90b2tlbik7CisJCUdT
U19VTkxPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CisJICAgIH0KIAkgICAgc2FzbF9nc3NfZnJl
ZV9jb250ZXh0X2NvbnRlbnRzKHRleHQpOwogCSAgICByZXR1cm4gU0FTTF9GQUlMOwogCX0KQEAg
LTEzMTYsMTcgKzE0NTYsMjIgQEAKIAkJcmV0ID0gX3BsdWdfYnVmX2FsbG9jKHRleHQtPnV0aWxz
LCAmKHRleHQtPm91dF9idWYpLAogCQkJCSAgICAgICYodGV4dC0+b3V0X2J1Zl9sZW4pLCAqY2xp
ZW50b3V0bGVuKTsKIAkJaWYocmV0ICE9IFNBU0xfT0spIHsKKwkJICAgIEdTU19MT0NLX01VVEVY
KHBhcmFtcy0+dXRpbHMpOwogCQkgICAgZ3NzX3JlbGVhc2VfYnVmZmVyKCZtaW5fc3RhdCwgb3V0
cHV0X3Rva2VuKTsKKwkJICAgIEdTU19VTkxPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CiAJCSAg
ICByZXR1cm4gcmV0OwogCQl9CiAJCW1lbWNweSh0ZXh0LT5vdXRfYnVmLCBvdXRwdXRfdG9rZW4t
PnZhbHVlLCAqY2xpZW50b3V0bGVuKTsKIAkJKmNsaWVudG91dCA9IHRleHQtPm91dF9idWY7CiAJ
ICAgIH0KIAkgICAgCisJICAgIEdTU19MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMpOwogCSAgICBn
c3NfcmVsZWFzZV9idWZmZXIoJm1pbl9zdGF0LCBvdXRwdXRfdG9rZW4pOworCSAgICBHU1NfVU5M
T0NLX01VVEVYKHBhcmFtcy0+dXRpbHMpOwogCX0KIAkKIAlpZiAobWFqX3N0YXQgPT0gR1NTX1Nf
Q09NUExFVEUpIHsKKwkgICAgR1NTX0xPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CiAJICAgIG1h
al9zdGF0ID0gZ3NzX2lucXVpcmVfY29udGV4dCgmbWluX3N0YXQsCiAJCQkJCSAgIHRleHQtPmdz
c19jdHgsCiAJCQkJCSAgICZ0ZXh0LT5jbGllbnRfbmFtZSwKQEAgLTEzMzcsNiArMTQ4Miw3IEBA
CiAJCQkJCSAgIE5VTEwsICAgICAgIC8qIGZsYWdzICovCiAJCQkJCSAgIE5VTEwsICAgICAgIC8q
IGxvY2FsIGluaXQgKi8KIAkJCQkJICAgTlVMTCk7ICAgICAgLyogb3BlbiAqLworCSAgICBHU1Nf
VU5MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMpOwogCSAgICAKIAkgICAgaWYgKEdTU19FUlJPUiht
YWpfc3RhdCkpIHsKIAkJc2FzbF9nc3Nfc2V0ZXJyb3IodGV4dC0+dXRpbHMsIG1hal9zdGF0LCBt
aW5fc3RhdCk7CkBAIC0xMzQ1LDE0ICsxNDkxLDE5IEBACiAJICAgIH0KIAkgICAgCiAJICAgIG5h
bWVfdG9rZW4ubGVuZ3RoID0gMDsKKwkgICAgR1NTX0xPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7
CiAJICAgIG1hal9zdGF0ID0gZ3NzX2Rpc3BsYXlfbmFtZSgmbWluX3N0YXQsCiAJCQkJCXRleHQt
PmNsaWVudF9uYW1lLAogCQkJCQkmbmFtZV90b2tlbiwKIAkJCQkJTlVMTCk7CisJICAgIEdTU19V
TkxPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CiAJICAgIAogCSAgICBpZiAoR1NTX0VSUk9SKG1h
al9zdGF0KSkgewotCQlpZiAobmFtZV90b2tlbi52YWx1ZSkKKwkJaWYgKG5hbWVfdG9rZW4udmFs
dWUpIHsKKwkJICAgIEdTU19MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMpOwogCQkgICAgZ3NzX3Jl
bGVhc2VfYnVmZmVyKCZtaW5fc3RhdCwgJm5hbWVfdG9rZW4pOworCQkgICAgR1NTX1VOTE9DS19N
VVRFWChwYXJhbXMtPnV0aWxzKTsKKwkJfQogCQlTRVRFUlJPUih0ZXh0LT51dGlscywgIkdTU0FQ
SSBGYWlsdXJlIik7CiAJCXNhc2xfZ3NzX2ZyZWVfY29udGV4dF9jb250ZW50cyh0ZXh0KTsKIAkJ
cmV0dXJuIFNBU0xfRkFJTDsKQEAgLTEzNzIsNyArMTUyMyw5IEBACiAJCQkJCSBTQVNMX0NVX0FV
VEhJRCB8IFNBU0xfQ1VfQVVUSFpJRCwKIAkJCQkJIG9wYXJhbXMpOwogCSAgICB9CisJICAgIEdT
U19MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMpOwogCSAgICBnc3NfcmVsZWFzZV9idWZmZXIoJm1p
bl9zdGF0LCAmbmFtZV90b2tlbik7CisJICAgIEdTU19VTkxPQ0tfTVVURVgocGFyYW1zLT51dGls
cyk7CiAJICAgIAogCSAgICBpZiAocmV0ICE9IFNBU0xfT0spIHJldHVybiByZXQ7CiAJICAgIApA
QCAtMTM5MSwxOCArMTU0NCwyMyBAQAogCXJlYWxfaW5wdXRfdG9rZW4udmFsdWUgPSAodm9pZCAq
KSBzZXJ2ZXJpbjsKIAlyZWFsX2lucHV0X3Rva2VuLmxlbmd0aCA9IHNlcnZlcmlubGVuOwogCQor
CUdTU19MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMpOwogCW1hal9zdGF0ID0gZ3NzX3Vud3JhcCgm
bWluX3N0YXQsCiAJCQkgICAgICB0ZXh0LT5nc3NfY3R4LAogCQkJICAgICAgaW5wdXRfdG9rZW4s
CiAJCQkgICAgICBvdXRwdXRfdG9rZW4sCiAJCQkgICAgICBOVUxMLAogCQkJICAgICAgTlVMTCk7
CisJR1NTX1VOTE9DS19NVVRFWChwYXJhbXMtPnV0aWxzKTsKIAkKIAlpZiAoR1NTX0VSUk9SKG1h
al9zdGF0KSkgewogCSAgICBzYXNsX2dzc19zZXRlcnJvcih0ZXh0LT51dGlscywgbWFqX3N0YXQs
IG1pbl9zdGF0KTsKIAkgICAgc2FzbF9nc3NfZnJlZV9jb250ZXh0X2NvbnRlbnRzKHRleHQpOwot
CSAgICBpZiAob3V0cHV0X3Rva2VuLT52YWx1ZSkKKwkgICAgaWYgKG91dHB1dF90b2tlbi0+dmFs
dWUpIHsKKwkJR1NTX0xPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CiAJCWdzc19yZWxlYXNlX2J1
ZmZlcigmbWluX3N0YXQsIG91dHB1dF90b2tlbik7CisJCUdTU19VTkxPQ0tfTVVURVgocGFyYW1z
LT51dGlscyk7CisJICAgIH0KIAkgICAgcmV0dXJuIFNBU0xfRkFJTDsKIAl9CiAJCkBAIC0xNDc3
LDcgKzE2MzUsOSBAQAogCSAgICB9CiAJfQogCQorCUdTU19MT0NLX01VVEVYKHBhcmFtcy0+dXRp
bHMpOwogCWdzc19yZWxlYXNlX2J1ZmZlcigmbWluX3N0YXQsIG91dHB1dF90b2tlbik7CisJR1NT
X1VOTE9DS19NVVRFWChwYXJhbXMtPnV0aWxzKTsKIAkKIAkvKiBvcGFyYW1zLT51c2VyIGlzIGFs
d2F5cyBzZXQsIGR1ZSB0byBjYW5vbl91c2VyIHJlcXVpcmVtZW50cy4KIAkgKiBNYWtlIHN1cmUg
dGhlIGNsaWVudCBhY3R1YWxseSByZXF1ZXN0ZWQgaXQgdGhvdWdoLCBieSBjaGVja2luZwpAQCAt
MTUxNiw2ICsxNjc2LDcgQEAKICAgICAgICAgfQogCSgodW5zaWduZWQgY2hhciAqKWlucHV0X3Rv
a2VuLT52YWx1ZSlbMF0gPSBteWNob2ljZTsKIAkKKwlHU1NfTE9DS19NVVRFWChwYXJhbXMtPnV0
aWxzKTsKIAltYWpfc3RhdCA9IGdzc193cmFwICgmbWluX3N0YXQsCiAJCQkgICAgIHRleHQtPmdz
c19jdHgsCiAJCQkgICAgIDAsIC8qIEp1c3QgaW50ZWdyaXR5IGNoZWNraW5nIGhlcmUgKi8KQEAg
LTE1MjMsMTQgKzE2ODQsMTggQEAKIAkJCSAgICAgaW5wdXRfdG9rZW4sCiAJCQkgICAgIE5VTEws
CiAJCQkgICAgIG91dHB1dF90b2tlbik7CisJR1NTX1VOTE9DS19NVVRFWChwYXJhbXMtPnV0aWxz
KTsKIAkKIAlwYXJhbXMtPnV0aWxzLT5mcmVlKGlucHV0X3Rva2VuLT52YWx1ZSk7CiAJaW5wdXRf
dG9rZW4tPnZhbHVlID0gTlVMTDsKIAkKIAlpZiAoR1NTX0VSUk9SKG1hal9zdGF0KSkgewogCSAg
ICBzYXNsX2dzc19zZXRlcnJvcih0ZXh0LT51dGlscywgbWFqX3N0YXQsIG1pbl9zdGF0KTsKLQkg
ICAgaWYgKG91dHB1dF90b2tlbi0+dmFsdWUpCisJICAgIGlmIChvdXRwdXRfdG9rZW4tPnZhbHVl
KSB7CisJCUdTU19MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMpOwogCQlnc3NfcmVsZWFzZV9idWZm
ZXIoJm1pbl9zdGF0LCBvdXRwdXRfdG9rZW4pOworCQlHU1NfVU5MT0NLX01VVEVYKHBhcmFtcy0+
dXRpbHMpOworCSAgICB9CiAJICAgIHNhc2xfZ3NzX2ZyZWVfY29udGV4dF9jb250ZW50cyh0ZXh0
KTsKIAkgICAgcmV0dXJuIFNBU0xfRkFJTDsKIAl9CkBAIC0xNTQyLDE0ICsxNzA3LDE5IEBACiAJ
CXJldCA9IF9wbHVnX2J1Zl9hbGxvYyh0ZXh0LT51dGlscywgJih0ZXh0LT5vdXRfYnVmKSwKIAkJ
CQkgICAgICAmKHRleHQtPm91dF9idWZfbGVuKSwgKmNsaWVudG91dGxlbik7CiAJCWlmIChyZXQg
IT0gU0FTTF9PSykgeworCQkgICAgR1NTX0xPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CiAJCSAg
ICBnc3NfcmVsZWFzZV9idWZmZXIoJm1pbl9zdGF0LCBvdXRwdXRfdG9rZW4pOworCQkgICAgR1NT
X1VOTE9DS19NVVRFWChwYXJhbXMtPnV0aWxzKTsKIAkJICAgIHJldHVybiByZXQ7CiAJCX0KIAkJ
bWVtY3B5KHRleHQtPm91dF9idWYsIG91dHB1dF90b2tlbi0+dmFsdWUsICpjbGllbnRvdXRsZW4p
OwogCQkqY2xpZW50b3V0ID0gdGV4dC0+b3V0X2J1ZjsKIAkgICAgfQogCSAgICAKKwkgICAgR1NT
X0xPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CiAJICAgIGdzc19yZWxlYXNlX2J1ZmZlcigmbWlu
X3N0YXQsIG91dHB1dF90b2tlbik7CisJICAgIEdTU19VTkxPQ0tfTVVURVgocGFyYW1zLT51dGls
cyk7CisKIAl9CiAJCiAJdGV4dC0+c3RhdGUgPSBTQVNMX0dTU0FQSV9TVEFURV9BVVRIRU5USUNB
VEVEOwpAQCAtMTYxNiw2ICsxNzg2LDE1IEBACiAgICAgKm91dF92ZXJzaW9uID0gU0FTTF9DTElF
TlRfUExVR19WRVJTSU9OOwogICAgICpwbHVnbGlzdCA9IGdzc2FwaV9jbGllbnRfcGx1Z2luczsK
ICAgICAqcGx1Z2NvdW50ID0gMTsKKworI2lmZGVmIEdTU19VU0VfTVVURVhFUworICAgIGlmKCFn
c3NfbXV0ZXgpIHsKKyAgICAgIGdzc19tdXRleCA9IHV0aWxzLT5tdXRleF9hbGxvYygpOworICAg
ICAgaWYoIWdzc19tdXRleCkgeworICAgICAgICByZXR1cm4gU0FTTF9GQUlMOworICAgICAgfQor
ICAgIH0KKyNlbmRpZgogICAgIAogICAgIHJldHVybiBTQVNMX09LOwogfQo=
</data>        

          </attachment>
          <attachment
              isobsolete="0"
              ispatch="1"
              isprivate="0"
          >
            <attachid>296</attachid>
            <date>2004-07-15 13:32 EDT</date>
            <desc>corrected cleaned up patch, with configure.in changes</desc>
            <filename>mutex.patch</filename>
            <type>text/plain</type>
            <size>24559</size>
            <attacher>rjs3@andrew.cmu.edu</attacher>
            
              <data encoding="base64">SW5kZXg6IGNvbmZpZ3VyZS5pbgo9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09
PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09ClJDUyBmaWxlOiAvYWZzL2FuZHJldy5jbXUu
ZWR1L3N5c3RlbS9jdnMvc3JjL3Nhc2wvY29uZmlndXJlLmluLHYKcmV0cmlldmluZyByZXZpc2lv
biAxLjE5NQpkaWZmIC11IC1yMS4xOTUgY29uZmlndXJlLmluCi0tLSBjb25maWd1cmUuaW4JMiBK
dWwgMjAwNCAxOTozOTozNCAtMDAwMAkxLjE5NQorKysgY29uZmlndXJlLmluCTE1IEp1bCAyMDA0
IDE3OjI3OjU4IC0wMDAwCkBAIC00ODEsMTMgKzQ4MSwyOCBAQAogICBBQ19NU0dfUkVTVUxUKGRp
c2FibGVkKQogZmkKIAorZG5sIEtlcmJlcm9zIGJhc2VkIE1lY2hhbmlzbXMKIFNBU0xfS0VSQkVS
T1NfVjRfQ0hLCiBTQVNMX0dTU0FQSV9DSEsKLVNBU0xfUExBSU5fQ0hLCiAKIGlmIHRlc3QgIiRn
c3NhcGkiICE9ICJubyI7IHRoZW4KICAgQUNfREVGSU5FKFNUQVRJQ19HU1NBUElWMixbXSxbTGlu
ayBHU1NBUEkgU3RhdGljbHldKQorICBtdXRleF9kZWZhdWx0PSJubyIKKyAgaWYgdGVzdCAiJGdz
c19pbXBsIiA9ICJtaXQiOyB0aGVuCisgICAgIG11dGV4X2RlZmF1bHQ9InllcyIKKyAgZmkKKyAg
QUNfTVNHX0NIRUNLSU5HKHRvIHVzZSBtdXRleGVzIGFyb3VuZyBHU1MgY2FsbHMpCisgIEFDX0FS
R19FTkFCTEUoZ3NzX211dGV4ZXMsIFsgIC0tZW5hYmxlLWdzc19tdXRleGVzICAgICB1c2UgbXV0
ZXhlcyBhcm91bmQgY2FsbHMgdG8gdGhlIEdTUyBsaWJyYXJ5XSwKKyAgICAgICAgICAgICAgICB1
c2VfZ3NzX211dGV4ZXM9JGVuYWJsZXZhbCwKKyAgICAgICAgICAgICAgICB1c2VfZ3NzX211dGV4
ZXM9JG11dGV4X2RlZmF1bHQpCisgIGlmIHRlc3QgJHVzZV9nc3NfbXV0ZXhlcyA9ICJ5ZXMiOyB0
aGVuCisgICAgIEFDX0RFRklORShHU1NfVVNFX01VVEVYRVMsIFtdLCBbc2hvdWxkIHdlIG11dGV4
LXdyYXAgY2FsbHMgaW50byB0aGUgR1NTIGxpYnJhcnk/XSkKKyAgZmkKKyAgQUNfTVNHX1JFU1VM
VCgkdXNlX2dzc19tdXRleGVzKQogZmkKKworZG5sIFBMQUlOCitTQVNMX1BMQUlOX0NISwogCiBk
bmwgQU5PTllNT1VTCiBBQ19BUkdfRU5BQkxFKGFub24sIFsgIC0tZW5hYmxlLWFub24gICAgICAg
ICAgIGVuYWJsZSBBTk9OWU1PVVMgYXV0aGVudGljYXRpb24gW3llc10gXSwKSW5kZXg6IHBsdWdp
bnMvZ3NzYXBpLmMKPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09
PT09PT09PT09PT09PT09PT09PT09PQpSQ1MgZmlsZTogL2Fmcy9hbmRyZXcuY211LmVkdS9zeXN0
ZW0vY3ZzL3NyYy9zYXNsL3BsdWdpbnMvZ3NzYXBpLmMsdgpyZXRyaWV2aW5nIHJldmlzaW9uIDEu
OTAKZGlmZiAtdSAtcjEuOTAgZ3NzYXBpLmMKLS0tIHBsdWdpbnMvZ3NzYXBpLmMJNiBKdWwgMjAw
NCAyMTo1NTo0NyAtMDAwMAkxLjkwCisrKyBwbHVnaW5zL2dzc2FwaS5jCTE1IEp1bCAyMDA0IDE3
OjMwOjE5IC0wMDAwCkBAIC0xMjIsNiArMTIyLDIzIEBACiAgKiBDeWJlclNhZmUgKGh0dHA6Ly93
d3cuY3liZXJzYWZlLmNvbS8pIGFuZCBTRUFNLgogICovCiAKKyNpZmRlZiBHU1NfVVNFX01VVEVY
RVMKKyNkZWZpbmUgR1NTX0xPQ0tfTVVURVgodXRpbHMpICBcCisgICAgaWYoKChzYXNsX3V0aWxz
X3QgKikodXRpbHMpKS0+bXV0ZXhfbG9jayhnc3NfbXV0ZXgpICE9IDApIHsgXAorICAgICAgIHJl
dHVybiBTQVNMX0ZBSUw7IFwKKyAgICB9CisKKyNkZWZpbmUgR1NTX1VOTE9DS19NVVRFWCh1dGls
cykgXAorICAgIGlmKCgoc2FzbF91dGlsc190ICopKHV0aWxzKSktPm11dGV4X3VubG9jayhnc3Nf
bXV0ZXgpICE9IDApIHsgXAorICAgICAgICByZXR1cm4gU0FTTF9GQUlMOyBcCisgICAgfQorCitz
dGF0aWMgdm9pZCAqZ3NzX211dGV4ID0gTlVMTDsKKyNlbHNlCisjZGVmaW5lIEdTU19MT0NLX01V
VEVYKHV0aWxzKQorI2RlZmluZSBHU1NfVU5MT0NLX01VVEVYKHV0aWxzKQorI2VuZGlmCisKIHR5
cGVkZWYgc3RydWN0IGNvbnRleHQgewogICAgIGludCBzdGF0ZTsKICAgICAKQEAgLTE2NCw5ICsx
ODEsOSBAQAogI2RlZmluZSBzYXNsX2dzc19sb2coeCx5LHopIHNhc2xfZ3NzX3NldGVycm9yXyh4
LHkseiwxKQogI2RlZmluZSBzYXNsX2dzc19zZXRlcnJvcih4LHkseikgc2FzbF9nc3Nfc2V0ZXJy
b3JfKHgseSx6LDApCiAKLXN0YXRpYyB2b2lkCitzdGF0aWMgaW50CiBzYXNsX2dzc19zZXRlcnJv
cl8oY29uc3Qgc2FzbF91dGlsc190ICp1dGlscywgT01fdWludDMyIG1haiwgT01fdWludDMyIG1p
biwKLQlpbnQgbG9nb25seSkKKwkJICAgaW50IGxvZ29ubHkpCiB7CiAgICAgT01fdWludDMyIG1h
al9zdGF0LCBtaW5fc3RhdDsKICAgICBnc3NfYnVmZmVyX2Rlc2MgbXNnOwpAQCAtMTc2LDE5ICsx
OTMsMjAgQEAKICAgICBzaXplX3QgbGVuLCBjdXJsZW4gPSAwOwogICAgIGNvbnN0IGNoYXIgcHJl
Zml4W10gPSAiR1NTQVBJIEVycm9yOiAiOwogICAgIAotICAgIGlmKCF1dGlscykgcmV0dXJuOwot
ICAgIAogICAgIGxlbiA9IHNpemVvZihwcmVmaXgpOwogICAgIHJldCA9IF9wbHVnX2J1Zl9hbGxv
Yyh1dGlscywgJm91dCwgJmN1cmxlbiwgMjU2KTsKLSAgICBpZihyZXQgIT0gU0FTTF9PSykgcmV0
dXJuOworICAgIGlmKHJldCAhPSBTQVNMX09LKSByZXR1cm4gU0FTTF9PSzsKICAgICAKICAgICBz
dHJjcHkob3V0LCBwcmVmaXgpOwogICAgIAogICAgIG1zZ19jdHggPSAwOwogICAgIHdoaWxlICgx
KSB7CisJR1NTX0xPQ0tfTVVURVgodXRpbHMpOwogCW1hal9zdGF0ID0gZ3NzX2Rpc3BsYXlfc3Rh
dHVzKCZtaW5fc3RhdCwgbWFqLAogCQkJCSAgICAgIEdTU19DX0dTU19DT0RFLCBHU1NfQ19OVUxM
X09JRCwKIAkJCQkgICAgICAmbXNnX2N0eCwgJm1zZyk7CisJR1NTX1VOTE9DS19NVVRFWCh1dGls
cyk7CisJCiAJaWYoR1NTX0VSUk9SKG1hal9zdGF0KSkgewogCSAgICBpZiAobG9nb25seSkgewog
CQl1dGlscy0+bG9nKHV0aWxzLT5jb25uLCBTQVNMX0xPR19GQUlMLApAQCAtMTk5LDcgKzIxNyw3
IEBACiAJCQkJIihjb3VsZCBub3QgZ2V0IG1ham9yIGVycm9yIG1lc3NhZ2UpIik7CiAJICAgIH0K
IAkgICAgdXRpbHMtPmZyZWUob3V0KTsKLQkgICAgcmV0dXJuOworCSAgICByZXR1cm4gU0FTTF9P
SzsKIAl9CiAJCiAJbGVuICs9IGxlbiArIG1zZy5sZW5ndGg7CkBAIC0yMDcsMTIgKzIyNSwxNCBA
QAogCQogCWlmKHJldCAhPSBTQVNMX09LKSB7CiAJICAgIHV0aWxzLT5mcmVlKG91dCk7Ci0JICAg
IHJldHVybjsKKwkgICAgcmV0dXJuIFNBU0xfT0s7CiAJfQogCQogCXN0cmNhdChvdXQsIG1zZy52
YWx1ZSk7CiAJCisJR1NTX0xPQ0tfTVVURVgodXRpbHMpOwogCWdzc19yZWxlYXNlX2J1ZmZlcigm
bWluX3N0YXQsICZtc2cpOworCUdTU19VTkxPQ0tfTVVURVgodXRpbHMpOwogCQogCWlmICghbXNn
X2N0eCkKIAkgICAgYnJlYWs7CkBAIC0yMjQsMTYgKzI0NCwxOSBAQAogICAgIHJldCA9IF9wbHVn
X2J1Zl9hbGxvYyh1dGlscywgJm91dCwgJmN1cmxlbiwgbGVuKTsKICAgICBpZihyZXQgIT0gU0FT
TF9PSykgewogCXV0aWxzLT5mcmVlKG91dCk7Ci0JcmV0dXJuOworCXJldHVybiBTQVNMX05PTUVN
OwogICAgIH0KICAgICAKICAgICBzdHJjYXQob3V0LCAiICgiKTsKICAgICAKICAgICBtc2dfY3R4
ID0gMDsKICAgICB3aGlsZSAoMSkgeworCUdTU19MT0NLX01VVEVYKHV0aWxzKTsKIAltYWpfc3Rh
dCA9IGdzc19kaXNwbGF5X3N0YXR1cygmbWluX3N0YXQsIG1pbiwKIAkJCQkgICAgICBHU1NfQ19N
RUNIX0NPREUsIEdTU19DX05VTExfT0lELAogCQkJCSAgICAgICZtc2dfY3R4LCAmbXNnKTsKKwlH
U1NfVU5MT0NLX01VVEVYKHV0aWxzKTsKKwkKIAlpZihHU1NfRVJST1IobWFqX3N0YXQpKSB7CiAJ
ICAgIGlmIChsb2dvbmx5KSB7CiAJCXV0aWxzLT5sb2codXRpbHMtPmNvbm4sIFNBU0xfTE9HX0ZB
SUwsCkBAIC0yNDQsMjAgKzI2NywyMiBAQAogCQkJCSIoY291bGQgbm90IGdldCBtaW5vciBlcnJv
ciBtZXNzYWdlKSIpOwogCSAgICB9CiAJICAgIHV0aWxzLT5mcmVlKG91dCk7Ci0JICAgIHJldHVy
bjsKKwkgICAgcmV0dXJuIFNBU0xfT0s7CiAJfQogCQogCWxlbiArPSBsZW4gKyBtc2cubGVuZ3Ro
OworCiAJcmV0ID0gX3BsdWdfYnVmX2FsbG9jKHV0aWxzLCAmb3V0LCAmY3VybGVuLCBsZW4pOwot
CQogCWlmKHJldCAhPSBTQVNMX09LKSB7CiAJICAgIHV0aWxzLT5mcmVlKG91dCk7Ci0JICAgIHJl
dHVybjsKKwkgICAgcmV0dXJuIFNBU0xfTk9NRU07CiAJfQogCQogCXN0cmNhdChvdXQsIG1zZy52
YWx1ZSk7CiAJCisJR1NTX0xPQ0tfTVVURVgodXRpbHMpOwogCWdzc19yZWxlYXNlX2J1ZmZlcigm
bWluX3N0YXQsICZtc2cpOworCUdTU19VTkxPQ0tfTVVURVgodXRpbHMpOwogCQogCWlmICghbXNn
X2N0eCkKIAkgICAgYnJlYWs7CkBAIC0yNjcsNyArMjkyLDcgQEAKICAgICByZXQgPSBfcGx1Z19i
dWZfYWxsb2ModXRpbHMsICZvdXQsICZjdXJsZW4sIGxlbik7CiAgICAgaWYocmV0ICE9IFNBU0xf
T0spIHsKIAl1dGlscy0+ZnJlZShvdXQpOwotCXJldHVybjsKKwlyZXR1cm4gU0FTTF9OT01FTTsK
ICAgICB9CiAgICAgCiAgICAgc3RyY2F0KG91dCwgIikiKTsKQEAgLTI3OCw2ICszMDMsOCBAQAog
CXV0aWxzLT5zZXRlcnJvcih1dGlscy0+Y29ubiwgMCwgb3V0KTsKICAgICB9CiAgICAgdXRpbHMt
PmZyZWUob3V0KTsKKworICAgIHJldHVybiBTQVNMX09LOwogfQogCiBzdGF0aWMgaW50IApAQCAt
MzE0LDYgKzM0MSw3IEBACiAgICAgb3V0cHV0X3Rva2VuLT52YWx1ZSA9IE5VTEw7CiAgICAgb3V0
cHV0X3Rva2VuLT5sZW5ndGggPSAwOwogICAgIAorICAgIEdTU19MT0NLX01VVEVYKHRleHQtPnV0
aWxzKTsKICAgICBtYWpfc3RhdCA9IGdzc193cmFwICgmbWluX3N0YXQsCiAJCQkgdGV4dC0+Z3Nz
X2N0eCwKIAkJCSBwcml2YWN5LApAQCAtMzIxLDEyICszNDksMTYgQEAKIAkJCSBpbnB1dF90b2tl
biwKIAkJCSBOVUxMLAogCQkJIG91dHB1dF90b2tlbik7CisgICAgR1NTX1VOTE9DS19NVVRFWCh0
ZXh0LT51dGlscyk7CiAgICAgCiAgICAgaWYgKEdTU19FUlJPUihtYWpfc3RhdCkpCiAJewogCSAg
ICBzYXNsX2dzc19zZXRlcnJvcih0ZXh0LT51dGlscywgbWFqX3N0YXQsIG1pbl9zdGF0KTsKLQkg
ICAgaWYgKG91dHB1dF90b2tlbi0+dmFsdWUpCisJICAgIGlmIChvdXRwdXRfdG9rZW4tPnZhbHVl
KSB7CisJCUdTU19MT0NLX01VVEVYKHRleHQtPnV0aWxzKTsKIAkJZ3NzX3JlbGVhc2VfYnVmZmVy
KCZtaW5fc3RhdCwgb3V0cHV0X3Rva2VuKTsKKwkJR1NTX1VOTE9DS19NVVRFWCh0ZXh0LT51dGls
cyk7CisJICAgIH0KIAkgICAgcmV0dXJuIFNBU0xfRkFJTDsKIAl9CiAgICAgCkBAIC0zMzcsNyAr
MzY5LDkgQEAKIAkJCSAgICAgICYodGV4dC0+ZW5jb2RlX2J1Zl9sZW4pLCBvdXRwdXRfdG9rZW4t
Pmxlbmd0aCArIDQpOwogCQogCWlmIChyZXQgIT0gU0FTTF9PSykgeworCSAgICBHU1NfTE9DS19N
VVRFWCh0ZXh0LT51dGlscyk7CiAJICAgIGdzc19yZWxlYXNlX2J1ZmZlcigmbWluX3N0YXQsIG91
dHB1dF90b2tlbik7CisJICAgIEdTU19VTkxPQ0tfTVVURVgodGV4dC0+dXRpbHMpOwogCSAgICBy
ZXR1cm4gcmV0OwogCX0KIAkKQEAgLTM1Miw5ICszODYsMTEgQEAKICAgICAKICAgICAqb3V0cHV0
ID0gdGV4dC0+ZW5jb2RlX2J1ZjsKICAgICAKLSAgICBpZiAob3V0cHV0X3Rva2VuLT52YWx1ZSkK
KyAgICBpZiAob3V0cHV0X3Rva2VuLT52YWx1ZSkgeworCUdTU19MT0NLX01VVEVYKHRleHQtPnV0
aWxzKTsKIAlnc3NfcmVsZWFzZV9idWZmZXIoJm1pbl9zdGF0LCBvdXRwdXRfdG9rZW4pOwotICAg
IAorCUdTU19VTkxPQ0tfTVVURVgodGV4dC0+dXRpbHMpOworICAgIH0gCiAgICAgcmV0dXJuIFNB
U0xfT0s7CiB9CiAKQEAgLTM5NSwxOCArNDMxLDIzIEBACiAgICAgb3V0cHV0X3Rva2VuLT52YWx1
ZSA9IE5VTEw7CiAgICAgb3V0cHV0X3Rva2VuLT5sZW5ndGggPSAwOwogICAgIAorICAgIEdTU19M
T0NLX01VVEVYKHRleHQtPnV0aWxzKTsKICAgICBtYWpfc3RhdCA9IGdzc191bndyYXAgKCZtaW5f
c3RhdCwKIAkJCSAgIHRleHQtPmdzc19jdHgsCiAJCQkgICBpbnB1dF90b2tlbiwKIAkJCSAgIG91
dHB1dF90b2tlbiwKIAkJCSAgIE5VTEwsCiAJCQkgICBOVUxMKTsKKyAgICBHU1NfVU5MT0NLX01V
VEVYKHRleHQtPnV0aWxzKTsKICAgICAKICAgICBpZiAoR1NTX0VSUk9SKG1hal9zdGF0KSkKIAl7
CiAJICAgIHNhc2xfZ3NzX3NldGVycm9yKHRleHQtPnV0aWxzLG1hal9zdGF0LG1pbl9zdGF0KTsK
LQkgICAgaWYgKG91dHB1dF90b2tlbi0+dmFsdWUpCisJICAgIGlmIChvdXRwdXRfdG9rZW4tPnZh
bHVlKSB7CisJCUdTU19MT0NLX01VVEVYKHRleHQtPnV0aWxzKTsKIAkJZ3NzX3JlbGVhc2VfYnVm
ZmVyKCZtaW5fc3RhdCwgb3V0cHV0X3Rva2VuKTsKKwkJR1NTX1VOTE9DS19NVVRFWCh0ZXh0LT51
dGlscyk7CisJICAgIH0KIAkgICAgcmV0dXJuIFNBU0xfRkFJTDsKIAl9CiAgICAgCkBAIC00MTks
MTMgKzQ2MCwxNyBAQAogCQkJCSAgICAgJnRleHQtPmRlY29kZV9vbmNlX2J1Zl9sZW4sCiAJCQkJ
ICAgICAqb3V0cHV0bGVuKTsKIAkgICAgaWYocmVzdWx0ICE9IFNBU0xfT0spIHsKKwkJR1NTX0xP
Q0tfTVVURVgodGV4dC0+dXRpbHMpOwogCQlnc3NfcmVsZWFzZV9idWZmZXIoJm1pbl9zdGF0LCBv
dXRwdXRfdG9rZW4pOworCQlHU1NfVU5MT0NLX01VVEVYKHRleHQtPnV0aWxzKTsKIAkJcmV0dXJu
IHJlc3VsdDsKIAkgICAgfQogCSAgICAqb3V0cHV0ID0gdGV4dC0+ZGVjb2RlX29uY2VfYnVmOwog
CSAgICBtZW1jcHkoKm91dHB1dCwgb3V0cHV0X3Rva2VuLT52YWx1ZSwgKm91dHB1dGxlbik7CiAJ
fQorCUdTU19MT0NLX01VVEVYKHRleHQtPnV0aWxzKTsKIAlnc3NfcmVsZWFzZV9idWZmZXIoJm1p
bl9zdGF0LCBvdXRwdXRfdG9rZW4pOworCUdTU19VTkxPQ0tfTVVURVgodGV4dC0+dXRpbHMpOwog
ICAgIH0KICAgICAKICAgICByZXR1cm4gU0FTTF9PSzsKQEAgLTQ0Nyw3ICs0OTIsNyBAQAogICAg
IHJldHVybiByZXQ7CiB9CiAKLXN0YXRpYyBjb250ZXh0X3QgKmdzc19uZXdfY29udGV4dChjb25z
dCBzYXNsX3V0aWxzX3QgKnV0aWxzKQorc3RhdGljIGNvbnRleHRfdCAqc2FzbF9nc3NfbmV3X2Nv
bnRleHQoY29uc3Qgc2FzbF91dGlsc190ICp1dGlscykKIHsKICAgICBjb250ZXh0X3QgKnJldDsK
ICAgICAKQEAgLTQ2MCwxNCArNTA1LDE3IEBACiAgICAgcmV0dXJuIHJldDsKIH0KIAotc3RhdGlj
IHZvaWQgc2FzbF9nc3NfZnJlZV9jb250ZXh0X2NvbnRlbnRzKGNvbnRleHRfdCAqdGV4dCkKK3N0
YXRpYyBpbnQgc2FzbF9nc3NfZnJlZV9jb250ZXh0X2NvbnRlbnRzKGNvbnRleHRfdCAqdGV4dCkK
IHsKICAgICBPTV91aW50MzIgbWFqX3N0YXQsIG1pbl9zdGF0OwogICAgIAotICAgIGlmICghdGV4
dCkgcmV0dXJuOworICAgIGlmICghdGV4dCkgcmV0dXJuIFNBU0xfT0s7CiAgICAgCisgICAgR1NT
X0xPQ0tfTVVURVgodGV4dC0+dXRpbHMpOworCiAgICAgaWYgKHRleHQtPmdzc19jdHggIT0gR1NT
X0NfTk9fQ09OVEVYVCkgewotCW1hal9zdGF0ID0gZ3NzX2RlbGV0ZV9zZWNfY29udGV4dCAoJm1p
bl9zdGF0LCZ0ZXh0LT5nc3NfY3R4LEdTU19DX05PX0JVRkZFUik7CisJbWFqX3N0YXQgPSBnc3Nf
ZGVsZXRlX3NlY19jb250ZXh0KCZtaW5fc3RhdCwmdGV4dC0+Z3NzX2N0eCwKKwkJCQkJICBHU1Nf
Q19OT19CVUZGRVIpOwogCXRleHQtPmdzc19jdHggPSBHU1NfQ19OT19DT05URVhUOwogICAgIH0K
ICAgICAKQEAgLTQ5MCw2ICs1MzgsOCBAQAogCW1hal9zdGF0ID0gZ3NzX3JlbGVhc2VfY3JlZCgm
bWluX3N0YXQsICZ0ZXh0LT5jbGllbnRfY3JlZHMpOwogCXRleHQtPmNsaWVudF9jcmVkcyA9IEdT
U19DX05PX0NSRURFTlRJQUw7CiAgICAgfQorCisgICAgR1NTX1VOTE9DS19NVVRFWCh0ZXh0LT51
dGlscyk7CiAgICAgCiAgICAgaWYgKHRleHQtPm91dF9idWYpIHsKIAl0ZXh0LT51dGlscy0+ZnJl
ZSh0ZXh0LT5vdXRfYnVmKTsKQEAgLTUyMyw2ICs1NzMsOSBAQAogCXRleHQtPnV0aWxzLT5mcmVl
KHRleHQtPmF1dGhpZCk7CiAJdGV4dC0+YXV0aGlkID0gTlVMTDsKICAgICB9CisKKyAgICByZXR1
cm4gU0FTTF9PSzsKKwogfQogCiBzdGF0aWMgdm9pZCBnc3NhcGlfY29tbW9uX21lY2hfZGlzcG9z
ZSh2b2lkICpjb25uX2NvbnRleHQsCkBAIC01MzIsNiArNTg1LDE3IEBACiAgICAgdXRpbHMtPmZy
ZWUoY29ubl9jb250ZXh0KTsKIH0KIAorc3RhdGljIHZvaWQgZ3NzYXBpX2NvbW1vbl9tZWNoX2Zy
ZWUodm9pZCAqZ2xvYmFsX2NvbnRleHQgX19hdHRyaWJ1dGVfXygodW51c2VkKSksCisJCQkJICAg
IGNvbnN0IHNhc2xfdXRpbHNfdCAqdXRpbHMpCit7CisjaWZkZWYgR1NTX1VTRV9NVVRFWEVTCisg
ICAgaWYgKGdzc19tdXRleCkgeworICAgICAgdXRpbHMtPm11dGV4X2ZyZWUoZ3NzX211dGV4KTsK
KyAgICAgIGdzc19tdXRleD1OVUxMOworICAgIH0KKyNlbmRpZgorfQorCiAvKioqKioqKioqKioq
KioqKioqKioqKioqKioqKiogIFNlcnZlciBTZWN0aW9uICAqKioqKioqKioqKioqKioqKioqKioq
KioqKioqKi8KIAogc3RhdGljIGludCAKQEAgLTU0Myw3ICs2MDcsNyBAQAogewogICAgIGNvbnRl
eHRfdCAqdGV4dDsKICAgICAKLSAgICB0ZXh0ID0gZ3NzX25ld19jb250ZXh0KHBhcmFtcy0+dXRp
bHMpOworICAgIHRleHQgPSBzYXNsX2dzc19uZXdfY29udGV4dChwYXJhbXMtPnV0aWxzKTsKICAg
ICBpZiAodGV4dCA9PSBOVUxMKSB7CiAJTUVNRVJST1IocGFyYW1zLT51dGlscyk7CiAJcmV0dXJu
IFNBU0xfTk9NRU07CkBAIC02MDQsMTAgKzY2OCwxMiBAQAogCSAgICB9CiAJICAgIHNwcmludGYo
bmFtZV90b2tlbi52YWx1ZSwiJXNAJXMiLCBwYXJhbXMtPnNlcnZpY2UsIHBhcmFtcy0+c2VydmVy
RlFETik7CiAJICAgIAorCSAgICBHU1NfTE9DS19NVVRFWChwYXJhbXMtPnV0aWxzKTsKIAkgICAg
bWFqX3N0YXQgPSBnc3NfaW1wb3J0X25hbWUgKCZtaW5fc3RhdCwKIAkJCQkJJm5hbWVfdG9rZW4s
CiAJCQkJCUdTU19DX05UX0hPU1RCQVNFRF9TRVJWSUNFLAogCQkJCQkmdGV4dC0+c2VydmVyX25h
bWUpOworCSAgICBHU1NfVU5MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMpOwogCSAgICAKIAkgICAg
cGFyYW1zLT51dGlscy0+ZnJlZShuYW1lX3Rva2VuLnZhbHVlKTsKIAkgICAgbmFtZV90b2tlbi52
YWx1ZSA9IE5VTEw7CkBAIC02MTksMTAgKzY4NSwxMyBAQAogCSAgICB9CiAJICAgIAogCSAgICBp
ZiAoIHRleHQtPnNlcnZlcl9jcmVkcyAhPSBHU1NfQ19OT19DUkVERU5USUFMKSB7CisJICAgIAlH
U1NfTE9DS19NVVRFWChwYXJhbXMtPnV0aWxzKTsKIAkJbWFqX3N0YXQgPSBnc3NfcmVsZWFzZV9j
cmVkKCZtaW5fc3RhdCwgJnRleHQtPnNlcnZlcl9jcmVkcyk7CisJICAgIAlHU1NfVU5MT0NLX01V
VEVYKHBhcmFtcy0+dXRpbHMpOwogCQl0ZXh0LT5zZXJ2ZXJfY3JlZHMgPSBHU1NfQ19OT19DUkVE
RU5USUFMOwogCSAgICB9CiAJICAgIAorCSAgICBHU1NfTE9DS19NVVRFWChwYXJhbXMtPnV0aWxz
KTsKIAkgICAgbWFqX3N0YXQgPSBnc3NfYWNxdWlyZV9jcmVkKCZtaW5fc3RhdCwgCiAJCQkJCXRl
eHQtPnNlcnZlcl9uYW1lLAogCQkJCQlHU1NfQ19JTkRFRklOSVRFLCAKQEAgLTYzMSw2ICs3MDAs
NyBAQAogCQkJCQkmdGV4dC0+c2VydmVyX2NyZWRzLCAKIAkJCQkJTlVMTCwgCiAJCQkJCU5VTEwp
OworCSAgICBHU1NfVU5MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMpOwogCSAgICAKIAkgICAgaWYg
KEdTU19FUlJPUihtYWpfc3RhdCkpIHsKIAkJc2FzbF9nc3Nfc2V0ZXJyb3IodGV4dC0+dXRpbHMs
IG1hal9zdGF0LCBtaW5fc3RhdCk7CkBAIC02NDUsNiArNzE1LDcgQEAKIAl9CiAJCiAJCisJR1NT
X0xPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CiAJbWFqX3N0YXQgPQogCSAgICBnc3NfYWNjZXB0
X3NlY19jb250ZXh0KCZtaW5fc3RhdCwKIAkJCQkgICAmKHRleHQtPmdzc19jdHgpLApAQCAtNjU3
LDEyICs3MjgsMTUgQEAKIAkJCQkgICAmb3V0X2ZsYWdzLAogCQkJCSAgIE5VTEwsCiAJCQkJICAg
Jih0ZXh0LT5jbGllbnRfY3JlZHMpKTsKKwlHU1NfVU5MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMp
OwogCQogCWlmIChHU1NfRVJST1IobWFqX3N0YXQpKSB7CiAJICAgIHNhc2xfZ3NzX2xvZyh0ZXh0
LT51dGlscywgbWFqX3N0YXQsIG1pbl9zdGF0KTsKIAkgICAgdGV4dC0+dXRpbHMtPnNldGVycm9y
KHRleHQtPnV0aWxzLT5jb25uLCBTQVNMX05PTE9HLCAiR1NTQVBJIEZhaWx1cmU6IGdzc19hY2Nl
cHRfc2VjX2NvbnRleHQiKTsKIAkgICAgaWYgKG91dHB1dF90b2tlbi0+dmFsdWUpIHsKKwkJR1NT
X0xPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CiAJCWdzc19yZWxlYXNlX2J1ZmZlcigmbWluX3N0
YXQsIG91dHB1dF90b2tlbik7CisJCUdTU19VTkxPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CiAJ
ICAgIH0KIAkgICAgc2FzbF9nc3NfZnJlZV9jb250ZXh0X2NvbnRlbnRzKHRleHQpOwogCSAgICBy
ZXR1cm4gU0FTTF9CQURBVVRIOwpAQCAtNjczLDcgKzc0Nyw4IEBACiAJICAgICghKG91dF9mbGFn
cyAmIEdTU19DX0RFTEVHX0ZMQUcpIHx8CiAJICAgICB0ZXh0LT5jbGllbnRfY3JlZHMgPT0gR1NT
X0NfTk9fQ1JFREVOVElBTCkgKSAKIAl7Ci0JICAgIHRleHQtPnV0aWxzLT5zZXRlcnJvcih0ZXh0
LT51dGlscy0+Y29ubiwgU0FTTF9MT0dfV0FSTiwgIkdTU0FQSSB3YXJuaW5nOiBubyBjcmVkZW50
aWFscyB3ZXJlIHBhc3NlZCIpOworCSAgICB0ZXh0LT51dGlscy0+c2V0ZXJyb3IodGV4dC0+dXRp
bHMtPmNvbm4sIFNBU0xfTE9HX1dBUk4sCisJCQkJICAiR1NTQVBJIHdhcm5pbmc6IG5vIGNyZWRl
bnRpYWxzIHdlcmUgcGFzc2VkIik7CiAJICAgIC8qIGNvbnRpbnVlIHdpdGggYXV0aGVudGljYXRp
b24gKi8KIAl9CiAJICAgIApAQCAtNjg0LDE0ICs3NTksMTggQEAKIAkJcmV0ID0gX3BsdWdfYnVm
X2FsbG9jKHRleHQtPnV0aWxzLCAmKHRleHQtPm91dF9idWYpLAogCQkJCSAgICAgICYodGV4dC0+
b3V0X2J1Zl9sZW4pLCAqc2VydmVyb3V0bGVuKTsKIAkJaWYocmV0ICE9IFNBU0xfT0spIHsKKwkJ
ICAgIEdTU19MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMpOwogCQkgICAgZ3NzX3JlbGVhc2VfYnVm
ZmVyKCZtaW5fc3RhdCwgb3V0cHV0X3Rva2VuKTsKKwkJICAgIEdTU19VTkxPQ0tfTVVURVgocGFy
YW1zLT51dGlscyk7CiAJCSAgICByZXR1cm4gcmV0OwogCQl9CiAJCW1lbWNweSh0ZXh0LT5vdXRf
YnVmLCBvdXRwdXRfdG9rZW4tPnZhbHVlLCAqc2VydmVyb3V0bGVuKTsKIAkJKnNlcnZlcm91dCA9
IHRleHQtPm91dF9idWY7CiAJICAgIH0KIAkgICAgCisJICAgIEdTU19MT0NLX01VVEVYKHBhcmFt
cy0+dXRpbHMpOwogCSAgICBnc3NfcmVsZWFzZV9idWZmZXIoJm1pbl9zdGF0LCBvdXRwdXRfdG9r
ZW4pOworCSAgICBHU1NfVU5MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMpOwogCX0gZWxzZSB7CiAJ
ICAgIC8qIE5vIG91dHB1dCB0b2tlbiwgc2VuZCBhbiBlbXB0eSBzdHJpbmcgKi8KIAkgICAgKnNl
cnZlcm91dCA9IEdTU0FQSV9CTEFOS19TVFJJTkc7CkBAIC03MTcsMTkgKzc5NiwyNyBAQAogCQog
CS8qIFdlIGlnbm9yZSB3aGF0ZXZlciB0aGUgY2xpZW50IHNlbnQgdXMgYXQgdGhpcyBzdGFnZSAq
LwogCQorCUdTU19MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMpOwogCW1hal9zdGF0ID0gZ3NzX2Rp
c3BsYXlfbmFtZSAoJm1pbl9zdGF0LAogCQkJCSAgICAgdGV4dC0+Y2xpZW50X25hbWUsCiAJCQkJ
ICAgICAmbmFtZV90b2tlbiwKIAkJCQkgICAgIE5VTEwpOworCUdTU19VTkxPQ0tfTVVURVgocGFy
YW1zLT51dGlscyk7CiAJCiAJaWYgKEdTU19FUlJPUihtYWpfc3RhdCkpIHsKIAkgICAgaWYgKG5h
bWVfd2l0aG91dF9yZWFsbS52YWx1ZSkKIAkJcGFyYW1zLT51dGlscy0+ZnJlZShuYW1lX3dpdGhv
dXRfcmVhbG0udmFsdWUpOwogCSAgICAKLQkgICAgaWYgKG5hbWVfdG9rZW4udmFsdWUpCisJICAg
IGlmIChuYW1lX3Rva2VuLnZhbHVlKSB7CisJCUdTU19MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMp
OwogCQlnc3NfcmVsZWFzZV9idWZmZXIoJm1pbl9zdGF0LCAmbmFtZV90b2tlbik7Ci0JICAgIGlm
ICh3aXRob3V0KQorCQlHU1NfVU5MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMpOworCSAgICB9CisJ
ICAgIGlmICh3aXRob3V0KSB7CisJCUdTU19MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMpOwogCQln
c3NfcmVsZWFzZV9uYW1lKCZtaW5fc3RhdCwgJndpdGhvdXQpOworCQlHU1NfVU5MT0NLX01VVEVY
KHBhcmFtcy0+dXRpbHMpOworCSAgICB9CiAJICAgIFNFVEVSUk9SKHRleHQtPnV0aWxzLCAiR1NT
QVBJIEZhaWx1cmUiKTsKIAkgICAgc2FzbF9nc3NfZnJlZV9jb250ZXh0X2NvbnRlbnRzKHRleHQp
OwogCSAgICByZXR1cm4gU0FTTF9CQURBVVRIOwpAQCAtNzU1LDYgKzg0Miw3IEBACiAJICAgIAog
CSAgICBuYW1lX3dpdGhvdXRfcmVhbG0ubGVuZ3RoID0gc3RybGVuKCAoY2hhciAqKSBuYW1lX3dp
dGhvdXRfcmVhbG0udmFsdWUgKTsKIAkgICAgCisJICAgIEdTU19MT0NLX01VVEVYKHBhcmFtcy0+
dXRpbHMpOwogCSAgICBtYWpfc3RhdCA9IGdzc19pbXBvcnRfbmFtZSAoJm1pbl9zdGF0LAogCQkJ
CQkmbmFtZV93aXRob3V0X3JlYWxtLAogCSAgICAvKiBTb2xhcmlzIDgvOSBnc3NfaW1wb3J0X25h
bWUgZG9lc24ndCBhY2NlcHQgR1NTX0NfTlVMTF9PSUQgaGVyZSwKQEAgLTc2NSwzNSArODUzLDUz
IEBACiAJCQkJCUdTU19DX05VTExfT0lELAogI2VuZGlmCiAJCQkJCSZ3aXRob3V0KTsKKwkgICAg
R1NTX1VOTE9DS19NVVRFWChwYXJhbXMtPnV0aWxzKTsKIAkgICAgCiAJICAgIGlmIChHU1NfRVJS
T1IobWFqX3N0YXQpKSB7CiAJCXBhcmFtcy0+dXRpbHMtPmZyZWUobmFtZV93aXRob3V0X3JlYWxt
LnZhbHVlKTsKLQkJaWYgKG5hbWVfdG9rZW4udmFsdWUpCisJCWlmIChuYW1lX3Rva2VuLnZhbHVl
KSB7CisJICAgIAkgICAgR1NTX0xPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CiAJCSAgICBnc3Nf
cmVsZWFzZV9idWZmZXIoJm1pbl9zdGF0LCAmbmFtZV90b2tlbik7Ci0JCWlmICh3aXRob3V0KQor
CSAgICAJICAgIEdTU19VTkxPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CisJCX0KKwkJaWYgKHdp
dGhvdXQpIHsKKwkgICAgCSAgICBHU1NfTE9DS19NVVRFWChwYXJhbXMtPnV0aWxzKTsKIAkJICAg
IGdzc19yZWxlYXNlX25hbWUoJm1pbl9zdGF0LCAmd2l0aG91dCk7CisJICAgIAkgICAgR1NTX1VO
TE9DS19NVVRFWChwYXJhbXMtPnV0aWxzKTsKKwkJfQogCQlTRVRFUlJPUih0ZXh0LT51dGlscywg
IkdTU0FQSSBGYWlsdXJlIik7CiAJCXNhc2xfZ3NzX2ZyZWVfY29udGV4dF9jb250ZW50cyh0ZXh0
KTsKIAkJcmV0dXJuIFNBU0xfQkFEQVVUSDsKIAkgICAgfQogCSAgICAKKwkgICAgR1NTX0xPQ0tf
TVVURVgocGFyYW1zLT51dGlscyk7CiAJICAgIG1hal9zdGF0ID0gZ3NzX2NvbXBhcmVfbmFtZSgm
bWluX3N0YXQsCiAJCQkJCXRleHQtPmNsaWVudF9uYW1lLAogCQkJCQl3aXRob3V0LAogCQkJCQkm
ZXF1YWwpOworCSAgICBHU1NfVU5MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMpOwogCSAgICAKIAkg
ICAgaWYgKEdTU19FUlJPUihtYWpfc3RhdCkpIHsKIAkJcGFyYW1zLT51dGlscy0+ZnJlZShuYW1l
X3dpdGhvdXRfcmVhbG0udmFsdWUpOwotCQlpZiAobmFtZV90b2tlbi52YWx1ZSkKKwkJaWYgKG5h
bWVfdG9rZW4udmFsdWUpIHsKKwkgICAgCSAgICBHU1NfTE9DS19NVVRFWChwYXJhbXMtPnV0aWxz
KTsKIAkJICAgIGdzc19yZWxlYXNlX2J1ZmZlcigmbWluX3N0YXQsICZuYW1lX3Rva2VuKTsKLQkJ
aWYgKHdpdGhvdXQpCisJICAgIAkgICAgR1NTX1VOTE9DS19NVVRFWChwYXJhbXMtPnV0aWxzKTsK
KwkJfQorCQlpZiAod2l0aG91dCkgeworCSAgICAJICAgIEdTU19MT0NLX01VVEVYKHBhcmFtcy0+
dXRpbHMpOwogCQkgICAgZ3NzX3JlbGVhc2VfbmFtZSgmbWluX3N0YXQsICZ3aXRob3V0KTsKKwkg
ICAgCSAgICBHU1NfVU5MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMpOworCQl9CiAJCVNFVEVSUk9S
KHRleHQtPnV0aWxzLCAiR1NTQVBJIEZhaWx1cmUiKTsKIAkJc2FzbF9nc3NfZnJlZV9jb250ZXh0
X2NvbnRlbnRzKHRleHQpOwogCQlyZXR1cm4gU0FTTF9CQURBVVRIOwogCSAgICB9CiAJICAgIAor
CSAgICBHU1NfTE9DS19NVVRFWChwYXJhbXMtPnV0aWxzKTsKIAkgICAgZ3NzX3JlbGVhc2VfbmFt
ZSgmbWluX3N0YXQsJndpdGhvdXQpOworCSAgICBHU1NfVU5MT0NLX01VVEVYKHBhcmFtcy0+dXRp
bHMpOworCiAJfSBlbHNlIHsKIAkgICAgZXF1YWwgPSAwOwogCX0KQEAgLTgxNCwxMSArOTIwLDE0
IEBACiAJICAgIH0KIAl9CiAJCi0JaWYgKG5hbWVfdG9rZW4udmFsdWUpCisJaWYgKG5hbWVfdG9r
ZW4udmFsdWUpIHsKKwkgICAgR1NTX0xPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CiAJICAgIGdz
c19yZWxlYXNlX2J1ZmZlcigmbWluX3N0YXQsICZuYW1lX3Rva2VuKTsKLQlpZiAobmFtZV93aXRo
b3V0X3JlYWxtLnZhbHVlKQorCSAgICBHU1NfVU5MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMpOwor
CX0KKwlpZiAobmFtZV93aXRob3V0X3JlYWxtLnZhbHVlKSB7CiAJICAgIHBhcmFtcy0+dXRpbHMt
PmZyZWUobmFtZV93aXRob3V0X3JlYWxtLnZhbHVlKTsKLQkKKwl9CQogCQogCS8qIHdlIGhhdmUg
dG8gZGVjaWRlIHdoYXQgc29ydCBvZiBlbmNyeXB0aW9uL2ludGVncml0eS9ldGMuLAogCSAgIHdl
IHN1cHBvcnQgKi8KQEAgLTg2NSw2ICs5NzQsNyBAQAogCXJlYWxfaW5wdXRfdG9rZW4udmFsdWUg
PSAodm9pZCAqKXNhc2xkYXRhOwogCXJlYWxfaW5wdXRfdG9rZW4ubGVuZ3RoID0gNDsKIAkKKwlH
U1NfTE9DS19NVVRFWChwYXJhbXMtPnV0aWxzKTsKIAltYWpfc3RhdCA9IGdzc193cmFwKCZtaW5f
c3RhdCwKIAkJCSAgICB0ZXh0LT5nc3NfY3R4LAogCQkJICAgIDAsIC8qIEp1c3QgaW50ZWdyaXR5
IGNoZWNraW5nIGhlcmUgKi8KQEAgLTg3MiwxMSArOTgyLDE1IEBACiAJCQkgICAgaW5wdXRfdG9r
ZW4sCiAJCQkgICAgTlVMTCwKIAkJCSAgICBvdXRwdXRfdG9rZW4pOworCUdTU19VTkxPQ0tfTVVU
RVgocGFyYW1zLT51dGlscyk7CiAJCiAJaWYgKEdTU19FUlJPUihtYWpfc3RhdCkpIHsKIAkgICAg
c2FzbF9nc3Nfc2V0ZXJyb3IodGV4dC0+dXRpbHMsIG1hal9zdGF0LCBtaW5fc3RhdCk7Ci0JICAg
IGlmIChvdXRwdXRfdG9rZW4tPnZhbHVlKQorCSAgICBpZiAob3V0cHV0X3Rva2VuLT52YWx1ZSkg
eworCQlHU1NfTE9DS19NVVRFWChwYXJhbXMtPnV0aWxzKTsKIAkJZ3NzX3JlbGVhc2VfYnVmZmVy
KCZtaW5fc3RhdCwgb3V0cHV0X3Rva2VuKTsKKwkJR1NTX1VOTE9DS19NVVRFWChwYXJhbXMtPnV0
aWxzKTsKKwkgICAgfQogCSAgICBzYXNsX2dzc19mcmVlX2NvbnRleHRfY29udGVudHModGV4dCk7
CiAJICAgIHJldHVybiBTQVNMX0ZBSUw7CiAJfQpAQCAtODg5LDE0ICsxMDAzLDE4IEBACiAJCXJl
dCA9IF9wbHVnX2J1Zl9hbGxvYyh0ZXh0LT51dGlscywgJih0ZXh0LT5vdXRfYnVmKSwKIAkJCQkg
ICAgICAmKHRleHQtPm91dF9idWZfbGVuKSwgKnNlcnZlcm91dGxlbik7CiAJCWlmKHJldCAhPSBT
QVNMX09LKSB7CisJCSAgICBHU1NfTE9DS19NVVRFWChwYXJhbXMtPnV0aWxzKTsKIAkJICAgIGdz
c19yZWxlYXNlX2J1ZmZlcigmbWluX3N0YXQsIG91dHB1dF90b2tlbik7CisJCSAgICBHU1NfVU5M
T0NLX01VVEVYKHBhcmFtcy0+dXRpbHMpOwogCQkgICAgcmV0dXJuIHJldDsKIAkJfQogCQltZW1j
cHkodGV4dC0+b3V0X2J1Ziwgb3V0cHV0X3Rva2VuLT52YWx1ZSwgKnNlcnZlcm91dGxlbik7CiAJ
CSpzZXJ2ZXJvdXQgPSB0ZXh0LT5vdXRfYnVmOwogCSAgICB9CiAJICAgIAorCSAgICBHU1NfTE9D
S19NVVRFWChwYXJhbXMtPnV0aWxzKTsKIAkgICAgZ3NzX3JlbGVhc2VfYnVmZmVyKCZtaW5fc3Rh
dCwgb3V0cHV0X3Rva2VuKTsKKwkgICAgR1NTX1VOTE9DS19NVVRFWChwYXJhbXMtPnV0aWxzKTsK
IAl9CiAJCiAJLyogV2FpdCBmb3Igc3NmIHJlcXVlc3QgYW5kIGF1dGhpZCAqLwpAQCAtOTExLDEy
ICsxMDI5LDE0IEBACiAJcmVhbF9pbnB1dF90b2tlbi52YWx1ZSA9ICh2b2lkICopY2xpZW50aW47
CiAJcmVhbF9pbnB1dF90b2tlbi5sZW5ndGggPSBjbGllbnRpbmxlbjsKIAkKKwlHU1NfTE9DS19N
VVRFWChwYXJhbXMtPnV0aWxzKTsKIAltYWpfc3RhdCA9IGdzc191bndyYXAoJm1pbl9zdGF0LAog
CQkJICAgICAgdGV4dC0+Z3NzX2N0eCwKIAkJCSAgICAgIGlucHV0X3Rva2VuLAogCQkJICAgICAg
b3V0cHV0X3Rva2VuLAogCQkJICAgICAgTlVMTCwKIAkJCSAgICAgIE5VTEwpOworCUdTU19VTkxP
Q0tfTVVURVgocGFyYW1zLT51dGlscyk7CiAJCiAJaWYgKEdTU19FUlJPUihtYWpfc3RhdCkpIHsK
IAkgICAgc2FzbF9nc3Nfc2V0ZXJyb3IodGV4dC0+dXRpbHMsIG1hal9zdGF0LCBtaW5fc3RhdCk7
CkBAIC05NDYsOCArMTA2NiwxMSBAQAogCQkgICAgICJwcm90b2NvbCB2aW9sYXRpb246IGNsaWVu
dCByZXF1ZXN0ZWQgaW52YWxpZCBsYXllciIpOwogCSAgICAvKiBNYXJrIHRoYXQgd2UgYXR0ZW1w
dGVkIG5lZ290aWF0aW9uICovCiAJICAgIG9wYXJhbXMtPm1lY2hfc3NmID0gMjsKLQkgICAgaWYg
KG91dHB1dF90b2tlbi0+dmFsdWUpCisJICAgIGlmIChvdXRwdXRfdG9rZW4tPnZhbHVlKSB7CisJ
CUdTU19MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMpOwogCQlnc3NfcmVsZWFzZV9idWZmZXIoJm1p
bl9zdGF0LCBvdXRwdXRfdG9rZW4pOworCQlHU1NfVU5MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMp
OworCSAgICB9CiAJICAgIHNhc2xfZ3NzX2ZyZWVfY29udGV4dF9jb250ZW50cyh0ZXh0KTsKIAkg
ICAgcmV0dXJuIFNBU0xfRkFJTDsKIAl9CkBAIC05OTAsNyArMTExMyw5IEBACiAJfSBlbHNlIHsK
IAkgICAgU0VURVJST1IodGV4dC0+dXRpbHMsCiAJCSAgICAgInRva2VuIHRvbyBzaG9ydCIpOwor
CSAgICBHU1NfTE9DS19NVVRFWChwYXJhbXMtPnV0aWxzKTsKIAkgICAgZ3NzX3JlbGVhc2VfYnVm
ZmVyKCZtaW5fc3RhdCwgb3V0cHV0X3Rva2VuKTsKKwkgICAgR1NTX1VOTE9DS19NVVRFWChwYXJh
bXMtPnV0aWxzKTsKIAkgICAgc2FzbF9nc3NfZnJlZV9jb250ZXh0X2NvbnRlbnRzKHRleHQpOwog
CSAgICByZXR1cm4gU0FTTF9GQUlMOwogCX0JCkBAIC0xMDI2LDcgKzExNTEsOSBAQAogCSAgICB9
ICAgIAogCX0KIAkKKwlHU1NfTE9DS19NVVRFWChwYXJhbXMtPnV0aWxzKTsKIAlnc3NfcmVsZWFz
ZV9idWZmZXIoJm1pbl9zdGF0LCBvdXRwdXRfdG9rZW4pOworCUdTU19VTkxPQ0tfTVVURVgocGFy
YW1zLT51dGlscyk7CiAJCiAJdGV4dC0+c3RhdGUgPSBTQVNMX0dTU0FQSV9TVEFURV9BVVRIRU5U
SUNBVEVEOwogCQpAQCAtMTA2NSw3ICsxMTkyLDcgQEAKIAkmZ3NzYXBpX3NlcnZlcl9tZWNoX25l
dywJLyogbWVjaF9uZXcgKi8KIAkmZ3NzYXBpX3NlcnZlcl9tZWNoX3N0ZXAsCS8qIG1lY2hfc3Rl
cCAqLwogCSZnc3NhcGlfY29tbW9uX21lY2hfZGlzcG9zZSwJLyogbWVjaF9kaXNwb3NlICovCi0J
TlVMTCwJCQkJLyogbWVjaF9mcmVlICovCisJJmdzc2FwaV9jb21tb25fbWVjaF9mcmVlLAkvKiBt
ZWNoX2ZyZWUgKi8KIAlOVUxMLAkJCQkvKiBzZXRwYXNzICovCiAJTlVMTCwJCQkJLyogdXNlcl9x
dWVyeSAqLwogCU5VTEwsCQkJCS8qIGlkbGUgKi8KQEAgLTExMjUsNiArMTI1MiwxNSBAQAogICAg
ICpvdXRfdmVyc2lvbiA9IFNBU0xfU0VSVkVSX1BMVUdfVkVSU0lPTjsKICAgICAqcGx1Z2xpc3Qg
PSBnc3NhcGlfc2VydmVyX3BsdWdpbnM7CiAgICAgKnBsdWdjb3VudCA9IDE7ICAKKworI2lmZGVm
IEdTU19VU0VfTVVURVhFUworICAgIGlmICghZ3NzX211dGV4KSB7CisgICAgICAgZ3NzX211dGV4
ID0gdXRpbHMtPm11dGV4X2FsbG9jKCk7CisgICAgICAgaWYgKCFnc3NfbXV0ZXgpIHsKKyAgICAg
ICAgICAgcmV0dXJuIFNBU0xfRkFJTDsKKyAgICAgICB9CisgICAgfQorI2VuZGlmCiAgICAgCiAg
ICAgcmV0dXJuIFNBU0xfT0s7CiB9CkBAIC0xMTM4LDcgKzEyNzQsNyBAQAogICAgIGNvbnRleHRf
dCAqdGV4dDsKICAgICAKICAgICAvKiBob2xkcyBzdGF0ZSBhcmUgaW4gKi8KLSAgICB0ZXh0ID0g
Z3NzX25ld19jb250ZXh0KHBhcmFtcy0+dXRpbHMpOworICAgIHRleHQgPSBzYXNsX2dzc19uZXdf
Y29udGV4dChwYXJhbXMtPnV0aWxzKTsKICAgICBpZiAodGV4dCA9PSBOVUxMKSB7CiAJTUVNRVJS
T1IocGFyYW1zLT51dGlscyk7CiAJcmV0dXJuIFNBU0xfTk9NRU07CkBAIC0xMjM0LDEwICsxMzcw
LDEyIEBACiAJICAgIAogCSAgICBzcHJpbnRmKG5hbWVfdG9rZW4udmFsdWUsIiVzQCVzIiwgcGFy
YW1zLT5zZXJ2aWNlLCBwYXJhbXMtPnNlcnZlckZRRE4pOwogCSAgICAKKwkgICAgR1NTX0xPQ0tf
TVVURVgocGFyYW1zLT51dGlscyk7CiAJICAgIG1hal9zdGF0ID0gZ3NzX2ltcG9ydF9uYW1lICgm
bWluX3N0YXQsCiAJCQkJCSZuYW1lX3Rva2VuLAogCQkJCQlHU1NfQ19OVF9IT1NUQkFTRURfU0VS
VklDRSwKIAkJCQkJJnRleHQtPnNlcnZlcl9uYW1lKTsKKwkgICAgR1NTX1VOTE9DS19NVVRFWChw
YXJhbXMtPnV0aWxzKTsKIAkgICAgCiAJICAgIHBhcmFtcy0+dXRpbHMtPmZyZWUobmFtZV90b2tl
bi52YWx1ZSk7CiAJICAgIG5hbWVfdG9rZW4udmFsdWUgPSBOVUxMOwpAQCAtMTI2MSw3ICsxMzk5
LDkgQEAKIAkgICAgICogYW5kIG5vIGlucHV0IGZyb20gdGhlIHNlcnZlci4gIEhvd2V2ZXIsIHRo
YW5rcyB0byBJbWFwLAogCSAgICAgKiB3aGljaCBkaXNjYXJkcyBvdXIgZmlyc3Qgb3V0cHV0LCB0
aGlzIGhhcHBlbnMgYWxsIHRoZSB0aW1lLgogCSAgICAgKiBUaHJvdyBhd2F5IHRoZSBjb250ZXh0
IGFuZCB0cnkgYWdhaW4uICovCisJICAgIEdTU19MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMpOwog
CSAgICBtYWpfc3RhdCA9IGdzc19kZWxldGVfc2VjX2NvbnRleHQgKCZtaW5fc3RhdCwmdGV4dC0+
Z3NzX2N0eCxHU1NfQ19OT19CVUZGRVIpOworCSAgICBHU1NfVU5MT0NLX01VVEVYKHBhcmFtcy0+
dXRpbHMpOwogCSAgICB0ZXh0LT5nc3NfY3R4ID0gR1NTX0NfTk9fQ09OVEVYVDsKIAl9CiAJICAg
IApAQCAtMTI4Miw2ICsxNDIyLDcgQEAKIAlpZiAocGFyYW1zLT5wcm9wcy5zZWN1cml0eV9mbGFn
cyAmIFNBU0xfU0VDX1BBU1NfQ1JFREVOVElBTFMpCiAJICAgIHJlcV9mbGFncyA9IHJlcV9mbGFn
cyB8ICBHU1NfQ19ERUxFR19GTEFHOwogCisJR1NTX0xPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7
CiAJbWFqX3N0YXQgPSBnc3NfaW5pdF9zZWNfY29udGV4dCgmbWluX3N0YXQsCiAJCQkJCUdTU19D
X05PX0NSRURFTlRJQUwsCiAJCQkJCSZ0ZXh0LT5nc3NfY3R4LApAQCAtMTI5NSwxMSArMTQzNiwx
NSBAQAogCQkJCQlvdXRwdXRfdG9rZW4sCiAJCQkJCSZvdXRfcmVxX2ZsYWdzLAogCQkJCQlOVUxM
KTsKKwlHU1NfVU5MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMpOwogCQogCWlmIChHU1NfRVJST1Io
bWFqX3N0YXQpKSB7CiAJICAgIHNhc2xfZ3NzX3NldGVycm9yKHRleHQtPnV0aWxzLCBtYWpfc3Rh
dCwgbWluX3N0YXQpOwotCSAgICBpZiAob3V0cHV0X3Rva2VuLT52YWx1ZSkKKwkgICAgaWYgKG91
dHB1dF90b2tlbi0+dmFsdWUpIHsKKwkJR1NTX0xPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CiAJ
CWdzc19yZWxlYXNlX2J1ZmZlcigmbWluX3N0YXQsIG91dHB1dF90b2tlbik7CisJCUdTU19VTkxP
Q0tfTVVURVgocGFyYW1zLT51dGlscyk7CisJICAgIH0KIAkgICAgc2FzbF9nc3NfZnJlZV9jb250
ZXh0X2NvbnRlbnRzKHRleHQpOwogCSAgICByZXR1cm4gU0FTTF9GQUlMOwogCX0KQEAgLTEzMTYs
MTcgKzE0NjEsMjIgQEAKIAkJcmV0ID0gX3BsdWdfYnVmX2FsbG9jKHRleHQtPnV0aWxzLCAmKHRl
eHQtPm91dF9idWYpLAogCQkJCSAgICAgICYodGV4dC0+b3V0X2J1Zl9sZW4pLCAqY2xpZW50b3V0
bGVuKTsKIAkJaWYocmV0ICE9IFNBU0xfT0spIHsKKwkJICAgIEdTU19MT0NLX01VVEVYKHBhcmFt
cy0+dXRpbHMpOwogCQkgICAgZ3NzX3JlbGVhc2VfYnVmZmVyKCZtaW5fc3RhdCwgb3V0cHV0X3Rv
a2VuKTsKKwkJICAgIEdTU19VTkxPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CiAJCSAgICByZXR1
cm4gcmV0OwogCQl9CiAJCW1lbWNweSh0ZXh0LT5vdXRfYnVmLCBvdXRwdXRfdG9rZW4tPnZhbHVl
LCAqY2xpZW50b3V0bGVuKTsKIAkJKmNsaWVudG91dCA9IHRleHQtPm91dF9idWY7CiAJICAgIH0K
IAkgICAgCisJICAgIEdTU19MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMpOwogCSAgICBnc3NfcmVs
ZWFzZV9idWZmZXIoJm1pbl9zdGF0LCBvdXRwdXRfdG9rZW4pOworCSAgICBHU1NfVU5MT0NLX01V
VEVYKHBhcmFtcy0+dXRpbHMpOwogCX0KIAkKIAlpZiAobWFqX3N0YXQgPT0gR1NTX1NfQ09NUExF
VEUpIHsKKwkgICAgR1NTX0xPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CiAJICAgIG1hal9zdGF0
ID0gZ3NzX2lucXVpcmVfY29udGV4dCgmbWluX3N0YXQsCiAJCQkJCSAgIHRleHQtPmdzc19jdHgs
CiAJCQkJCSAgICZ0ZXh0LT5jbGllbnRfbmFtZSwKQEAgLTEzMzcsNiArMTQ4Nyw3IEBACiAJCQkJ
CSAgIE5VTEwsICAgICAgIC8qIGZsYWdzICovCiAJCQkJCSAgIE5VTEwsICAgICAgIC8qIGxvY2Fs
IGluaXQgKi8KIAkJCQkJICAgTlVMTCk7ICAgICAgLyogb3BlbiAqLworCSAgICBHU1NfVU5MT0NL
X01VVEVYKHBhcmFtcy0+dXRpbHMpOwogCSAgICAKIAkgICAgaWYgKEdTU19FUlJPUihtYWpfc3Rh
dCkpIHsKIAkJc2FzbF9nc3Nfc2V0ZXJyb3IodGV4dC0+dXRpbHMsIG1hal9zdGF0LCBtaW5fc3Rh
dCk7CkBAIC0xMzQ1LDE0ICsxNDk2LDE5IEBACiAJICAgIH0KIAkgICAgCiAJICAgIG5hbWVfdG9r
ZW4ubGVuZ3RoID0gMDsKKwkgICAgR1NTX0xPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CiAJICAg
IG1hal9zdGF0ID0gZ3NzX2Rpc3BsYXlfbmFtZSgmbWluX3N0YXQsCiAJCQkJCXRleHQtPmNsaWVu
dF9uYW1lLAogCQkJCQkmbmFtZV90b2tlbiwKIAkJCQkJTlVMTCk7CisJICAgIEdTU19VTkxPQ0tf
TVVURVgocGFyYW1zLT51dGlscyk7CiAJICAgIAogCSAgICBpZiAoR1NTX0VSUk9SKG1hal9zdGF0
KSkgewotCQlpZiAobmFtZV90b2tlbi52YWx1ZSkKKwkJaWYgKG5hbWVfdG9rZW4udmFsdWUpIHsK
KwkJICAgIEdTU19MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMpOwogCQkgICAgZ3NzX3JlbGVhc2Vf
YnVmZmVyKCZtaW5fc3RhdCwgJm5hbWVfdG9rZW4pOworCQkgICAgR1NTX1VOTE9DS19NVVRFWChw
YXJhbXMtPnV0aWxzKTsKKwkJfQogCQlTRVRFUlJPUih0ZXh0LT51dGlscywgIkdTU0FQSSBGYWls
dXJlIik7CiAJCXNhc2xfZ3NzX2ZyZWVfY29udGV4dF9jb250ZW50cyh0ZXh0KTsKIAkJcmV0dXJu
IFNBU0xfRkFJTDsKQEAgLTEzNzIsNyArMTUyOCw5IEBACiAJCQkJCSBTQVNMX0NVX0FVVEhJRCB8
IFNBU0xfQ1VfQVVUSFpJRCwKIAkJCQkJIG9wYXJhbXMpOwogCSAgICB9CisJICAgIEdTU19MT0NL
X01VVEVYKHBhcmFtcy0+dXRpbHMpOwogCSAgICBnc3NfcmVsZWFzZV9idWZmZXIoJm1pbl9zdGF0
LCAmbmFtZV90b2tlbik7CisJICAgIEdTU19VTkxPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CiAJ
ICAgIAogCSAgICBpZiAocmV0ICE9IFNBU0xfT0spIHJldHVybiByZXQ7CiAJICAgIApAQCAtMTM5
MSwxOCArMTU0OSwyMyBAQAogCXJlYWxfaW5wdXRfdG9rZW4udmFsdWUgPSAodm9pZCAqKSBzZXJ2
ZXJpbjsKIAlyZWFsX2lucHV0X3Rva2VuLmxlbmd0aCA9IHNlcnZlcmlubGVuOwogCQorCUdTU19M
T0NLX01VVEVYKHBhcmFtcy0+dXRpbHMpOwogCW1hal9zdGF0ID0gZ3NzX3Vud3JhcCgmbWluX3N0
YXQsCiAJCQkgICAgICB0ZXh0LT5nc3NfY3R4LAogCQkJICAgICAgaW5wdXRfdG9rZW4sCiAJCQkg
ICAgICBvdXRwdXRfdG9rZW4sCiAJCQkgICAgICBOVUxMLAogCQkJICAgICAgTlVMTCk7CisJR1NT
X1VOTE9DS19NVVRFWChwYXJhbXMtPnV0aWxzKTsKIAkKIAlpZiAoR1NTX0VSUk9SKG1hal9zdGF0
KSkgewogCSAgICBzYXNsX2dzc19zZXRlcnJvcih0ZXh0LT51dGlscywgbWFqX3N0YXQsIG1pbl9z
dGF0KTsKIAkgICAgc2FzbF9nc3NfZnJlZV9jb250ZXh0X2NvbnRlbnRzKHRleHQpOwotCSAgICBp
ZiAob3V0cHV0X3Rva2VuLT52YWx1ZSkKKwkgICAgaWYgKG91dHB1dF90b2tlbi0+dmFsdWUpIHsK
KwkJR1NTX0xPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CiAJCWdzc19yZWxlYXNlX2J1ZmZlcigm
bWluX3N0YXQsIG91dHB1dF90b2tlbik7CisJCUdTU19VTkxPQ0tfTVVURVgocGFyYW1zLT51dGls
cyk7CisJICAgIH0KIAkgICAgcmV0dXJuIFNBU0xfRkFJTDsKIAl9CiAJCkBAIC0xNDc3LDcgKzE2
NDAsOSBAQAogCSAgICB9CiAJfQogCQorCUdTU19MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMpOwog
CWdzc19yZWxlYXNlX2J1ZmZlcigmbWluX3N0YXQsIG91dHB1dF90b2tlbik7CisJR1NTX1VOTE9D
S19NVVRFWChwYXJhbXMtPnV0aWxzKTsKIAkKIAkvKiBvcGFyYW1zLT51c2VyIGlzIGFsd2F5cyBz
ZXQsIGR1ZSB0byBjYW5vbl91c2VyIHJlcXVpcmVtZW50cy4KIAkgKiBNYWtlIHN1cmUgdGhlIGNs
aWVudCBhY3R1YWxseSByZXF1ZXN0ZWQgaXQgdGhvdWdoLCBieSBjaGVja2luZwpAQCAtMTUxNiw2
ICsxNjgxLDcgQEAKICAgICAgICAgfQogCSgodW5zaWduZWQgY2hhciAqKWlucHV0X3Rva2VuLT52
YWx1ZSlbMF0gPSBteWNob2ljZTsKIAkKKwlHU1NfTE9DS19NVVRFWChwYXJhbXMtPnV0aWxzKTsK
IAltYWpfc3RhdCA9IGdzc193cmFwICgmbWluX3N0YXQsCiAJCQkgICAgIHRleHQtPmdzc19jdHgs
CiAJCQkgICAgIDAsIC8qIEp1c3QgaW50ZWdyaXR5IGNoZWNraW5nIGhlcmUgKi8KQEAgLTE1MjMs
MTQgKzE2ODksMTggQEAKIAkJCSAgICAgaW5wdXRfdG9rZW4sCiAJCQkgICAgIE5VTEwsCiAJCQkg
ICAgIG91dHB1dF90b2tlbik7CisJR1NTX1VOTE9DS19NVVRFWChwYXJhbXMtPnV0aWxzKTsKIAkK
IAlwYXJhbXMtPnV0aWxzLT5mcmVlKGlucHV0X3Rva2VuLT52YWx1ZSk7CiAJaW5wdXRfdG9rZW4t
PnZhbHVlID0gTlVMTDsKIAkKIAlpZiAoR1NTX0VSUk9SKG1hal9zdGF0KSkgewogCSAgICBzYXNs
X2dzc19zZXRlcnJvcih0ZXh0LT51dGlscywgbWFqX3N0YXQsIG1pbl9zdGF0KTsKLQkgICAgaWYg
KG91dHB1dF90b2tlbi0+dmFsdWUpCisJICAgIGlmIChvdXRwdXRfdG9rZW4tPnZhbHVlKSB7CisJ
CUdTU19MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMpOwogCQlnc3NfcmVsZWFzZV9idWZmZXIoJm1p
bl9zdGF0LCBvdXRwdXRfdG9rZW4pOworCQlHU1NfVU5MT0NLX01VVEVYKHBhcmFtcy0+dXRpbHMp
OworCSAgICB9CiAJICAgIHNhc2xfZ3NzX2ZyZWVfY29udGV4dF9jb250ZW50cyh0ZXh0KTsKIAkg
ICAgcmV0dXJuIFNBU0xfRkFJTDsKIAl9CkBAIC0xNTQyLDE0ICsxNzEyLDE5IEBACiAJCXJldCA9
IF9wbHVnX2J1Zl9hbGxvYyh0ZXh0LT51dGlscywgJih0ZXh0LT5vdXRfYnVmKSwKIAkJCQkgICAg
ICAmKHRleHQtPm91dF9idWZfbGVuKSwgKmNsaWVudG91dGxlbik7CiAJCWlmIChyZXQgIT0gU0FT
TF9PSykgeworCQkgICAgR1NTX0xPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CiAJCSAgICBnc3Nf
cmVsZWFzZV9idWZmZXIoJm1pbl9zdGF0LCBvdXRwdXRfdG9rZW4pOworCQkgICAgR1NTX1VOTE9D
S19NVVRFWChwYXJhbXMtPnV0aWxzKTsKIAkJICAgIHJldHVybiByZXQ7CiAJCX0KIAkJbWVtY3B5
KHRleHQtPm91dF9idWYsIG91dHB1dF90b2tlbi0+dmFsdWUsICpjbGllbnRvdXRsZW4pOwogCQkq
Y2xpZW50b3V0ID0gdGV4dC0+b3V0X2J1ZjsKIAkgICAgfQogCSAgICAKKwkgICAgR1NTX0xPQ0tf
TVVURVgocGFyYW1zLT51dGlscyk7CiAJICAgIGdzc19yZWxlYXNlX2J1ZmZlcigmbWluX3N0YXQs
IG91dHB1dF90b2tlbik7CisJICAgIEdTU19VTkxPQ0tfTVVURVgocGFyYW1zLT51dGlscyk7CisK
IAl9CiAJCiAJdGV4dC0+c3RhdGUgPSBTQVNMX0dTU0FQSV9TVEFURV9BVVRIRU5USUNBVEVEOwpA
QCAtMTU5NSw3ICsxNzcwLDcgQEAKIAkmZ3NzYXBpX2NsaWVudF9tZWNoX25ldywJLyogbWVjaF9u
ZXcgKi8KIAkmZ3NzYXBpX2NsaWVudF9tZWNoX3N0ZXAsCS8qIG1lY2hfc3RlcCAqLwogCSZnc3Nh
cGlfY29tbW9uX21lY2hfZGlzcG9zZSwJLyogbWVjaF9kaXNwb3NlICovCi0JTlVMTCwJCQkJLyog
bWVjaF9mcmVlICovCisJJmdzc2FwaV9jb21tb25fbWVjaF9mcmVlLAkvKiBtZWNoX2ZyZWUgKi8K
IAlOVUxMLAkJCQkvKiBpZGxlICovCiAJTlVMTCwJCQkJLyogc3BhcmUgKi8KIAlOVUxMCQkJCS8q
IHNwYXJlICovCkBAIC0xNjE2LDYgKzE3OTEsMTUgQEAKICAgICAqb3V0X3ZlcnNpb24gPSBTQVNM
X0NMSUVOVF9QTFVHX1ZFUlNJT047CiAgICAgKnBsdWdsaXN0ID0gZ3NzYXBpX2NsaWVudF9wbHVn
aW5zOwogICAgICpwbHVnY291bnQgPSAxOworCisjaWZkZWYgR1NTX1VTRV9NVVRFWEVTCisgICAg
aWYoIWdzc19tdXRleCkgeworICAgICAgZ3NzX211dGV4ID0gdXRpbHMtPm11dGV4X2FsbG9jKCk7
CisgICAgICBpZighZ3NzX211dGV4KSB7CisgICAgICAgIHJldHVybiBTQVNMX0ZBSUw7CisgICAg
ICB9CisgICAgfQorI2VuZGlmCiAgICAgCiAgICAgcmV0dXJuIFNBU0xfT0s7CiB9Cg==
</data>        

          </attachment>
      

    </bug>

</bugzilla>