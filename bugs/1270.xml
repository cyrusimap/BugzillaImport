<?xml version="1.0" standalone="yes" ?>
<!DOCTYPE bugzilla SYSTEM "https://bugzilla.cyrusimap.org/bugzilla.dtd">

<bugzilla version="3.2.5.1-2"
          urlbase="https://bugzilla.cyrusimap.org/"
          maintainer="Dave McMurtrie &lt;dave64@andrew.cmu.edu&gt;"
>

    <bug>
          <bug_id>1270</bug_id>
          
          <creation_ts>2002-06-05 19:44 EDT</creation_ts>
          <short_desc>don&apos;t read from network with locked mailbox during append</short_desc>
          <delta_ts>2010-10-18 12:42:57 EDT</delta_ts>
          <reporter_accessible>1</reporter_accessible>
          <cclist_accessible>1</cclist_accessible>
          <classification_id>1</classification_id>
          <classification>Unclassified</classification>
          <product>Cyrus IMAP</product>
          <component>IMAP</component>
          <version>2.1.x</version>
          <rep_platform>All</rep_platform>
          <op_sys>All</op_sys>
          <bug_status>CLOSED</bug_status>
          <resolution>FIXED</resolution>
          
          
          
          
          <priority>P5</priority>
          <bug_severity>bug</bug_severity>
          <target_milestone>Future</target_milestone>
          
          <blocked>63</blocked>
          
          <everconfirmed>1</everconfirmed>
          <reporter name="Rob Siemborski">rjs3@andrew.cmu.edu</reporter>
          <assigned_to name="Rob Siemborski">rjs3@andrew.cmu.edu</assigned_to>
          
          

      

      

      
          <long_desc isprivate="0">
            <who name="Rob Siemborski">rjs3@andrew.cmu.edu</who>
            <bug_when>2002-06-05 19:44:57 EDT</bug_when>
            <thetext>append_fromstream can do a network read, but it requires that append_setup be
called before it.  this results in potentially having the mailbox locked during
a network read.

this is sub-optimal, though it does not appear to be an easy fix.</thetext>
          </long_desc>
          <long_desc isprivate="0">
            <who name="Rob Siemborski">rjs3@andrew.cmu.edu</who>
            <bug_when>2003-09-23 19:30:29 EDT</bug_when>
            <thetext>This tends to manifest as a bunch of lmtpd&apos;s failing to deliver because the
quota file for the mailbox in question is locked.

Possible solution: check the quota during append_check, then unlock the mailbox,
but check again all of the append_check constraints during final delivery.</thetext>
          </long_desc>
          <long_desc isprivate="0">
            <who name="Ken Murchison">ken@oceana.com</who>
            <bug_when>2003-12-19 10:52:53 EDT</bug_when>
            <thetext>The cyrusdb_quotalegacy patch, doesn&apos;t lock the quota entry until
append_commit().  The quota is checked in append_check(), append_setup() and
append_commit().  Addressing mailbox locking is significantly more difficult.</thetext>
          </long_desc>
          <long_desc isprivate="0">
            <who name="Ken Murchison">ken@oceana.com</who>
            <bug_when>2004-01-22 16:17:42 EDT</bug_when>
            <thetext>commited fix which stages all messages before locking the mailbox</thetext>
          </long_desc>
          <long_desc isprivate="0">
            <who name="Larry Greenfield">leg+cyrus@andrew.cmu.edu</who>
            <bug_when>2004-01-22 17:04:45 EDT</bug_when>
            <thetext>do you have a diff for this change? just curious...</thetext>
          </long_desc>
          <long_desc isprivate="0">
            <who name="Rob Siemborski">rjs3@andrew.cmu.edu</who>
            <bug_when>2004-01-23 11:24:36 EDT</bug_when>
            <thetext>http://bugzilla.andrew.cmu.edu/cvsweb/src/cyrus/imap/append.c.diff?r1=1.103&amp;r2=1
.104
http://bugzilla.andrew.cmu.edu/cvsweb/src/cyrus/imap/append.h.diff?r1=1.25&amp;r2=1.
26
http://bugzilla.andrew.cmu.edu/cvsweb/src/cyrus/imap/imapd.c.diff?r1=1.450&amp;r2=1.
451
http://bugzilla.andrew.cmu.edu/cvsweb/src/cyrus/imap/lmtpd.c.diff?r1=1.126&amp;r2=1.
127
http://bugzilla.andrew.cmu.edu/cvsweb/src/cyrus/imap/mailbox.c.diff?r1=1.152&amp;r2=
1.153
http://bugzilla.andrew.cmu.edu/cvsweb/src/cyrus/imap/mailbox.h.diff?r1=1.80&amp;r2=1
.81
http://bugzilla.andrew.cmu.edu/cvsweb/src/cyrus/imap/nntpd.c.diff?r1=1.11&amp;r2=1.1
2
http://bugzilla.andrew.cmu.edu/cvsweb/src/cyrus/imap/seen_local.c.diff?r1=1.41&amp;r
2=1.42
</thetext>
          </long_desc>
          <long_desc isprivate="0">
            <who name="Ken Murchison">ken@oceana.com</who>
            <bug_when>2004-01-23 12:39:24 EDT</bug_when>
            <thetext>Created an attachment (id=248)
Unified diff of the fix
</thetext>
          </long_desc>
      
          <attachment
              isobsolete="0"
              ispatch="1"
              isprivate="0"
          >
            <attachid>248</attachid>
            <date>2004-01-23 12:39 EDT</date>
            <desc>Unified diff of the fix</desc>
            <filename>bug1270.patch</filename>
            <type>text/plain</type>
            <size>20801</size>
            <attacher>ken@oceana.com</attacher>
            
              <data encoding="base64">LS0tLS0tLS0tLS0tLS0tLS0tLS0tClBhdGNoU2V0IDU2MjYKRGF0ZTogMjAwNC8wMS8yMiAyMTox
NzowNwpBdXRob3I6IGtlbjMKTG9nOgpmaXhlZCBidWcgIzEyNzAuICBkb24ndCBsb2NrIHRoZSBt
YWlsYm94IHVudGlsIHdlIGhhdmUgdGhlIG1lc3NhZ2Ugc3RhZ2VkCgpNZW1iZXJzOiAKCWltYXAv
YXBwZW5kLmM6MS4xMDMtPjEuMTA0IAoJaW1hcC9hcHBlbmQuaDoxLjI1LT4xLjI2IAoJaW1hcC9p
bWFwZC5jOjEuNDUwLT4xLjQ1MSAKCWltYXAvbG10cGQuYzoxLjEyNi0+MS4xMjcgCglpbWFwL21h
aWxib3guYzoxLjE1Mi0+MS4xNTMgCglpbWFwL21haWxib3guaDoxLjgwLT4xLjgxIAoJaW1hcC9u
bnRwZC5jOjEuMTEtPjEuMTIgCglpbWFwL3NlZW5fbG9jYWwuYzoxLjQxLT4xLjQyIAoKSW5kZXg6
IGltYXAvYXBwZW5kLmMKPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09
PT09PT09PT09PT09PT09PT09PT09PT09PQpSQ1MgZmlsZTogL2Fmcy9hbmRyZXcvc3lzdGVtL2N2
cy9zcmMvY3lydXMvaW1hcC9hcHBlbmQuYyx2CnJldHJpZXZpbmcgcmV2aXNpb24gMS4xMDMKcmV0
cmlldmluZyByZXZpc2lvbiAxLjEwNApkaWZmIC11IC11IC1yMS4xMDMgLXIxLjEwNAotLS0gaW1h
cC9hcHBlbmQuYwkyMCBKYW4gMjAwNCAwMToxMDo1NSAtMDAwMAkxLjEwMworKysgaW1hcC9hcHBl
bmQuYwkyMiBKYW4gMjAwNCAyMToxNzowNyAtMDAwMAkxLjEwNApAQCAtMSw1ICsxLDUgQEAKIC8q
IGFwcGVuZC5jIC0tIFJvdXRpbmVzIGZvciBhcHBlbmRpbmcgbWVzc2FnZXMgdG8gYSBtYWlsYm94
Ci0gKiAkSWQ6IGFwcGVuZC5jLHYgMS4xMDMgMjAwNC8wMS8yMCAwMToxMDo1NSBrZW4zIEV4cCAk
CisgKiAkSWQ6IGFwcGVuZC5jLHYgMS4xMDQgMjAwNC8wMS8yMiAyMToxNzowNyBrZW4zIEV4cCAk
CiAgKgogICogQ29weXJpZ2h0IChjKTE5OTgsIDIwMDAgQ2FybmVnaWUgTWVsbG9uIFVuaXZlcnNp
dHkuICBBbGwgcmlnaHRzIHJlc2VydmVkLgogICoKQEAgLTIwNCwxMSArMjA0LDEzIEBACiAJcmV0
dXJuIHI7CiAgICAgfQogCi0gICAgciA9IHF1b3RhX3JlYWQoJmFzLT5tLnF1b3RhLCBOVUxMLCAw
KTsKKyAgICBhcy0+dGlkID0gTlVMTDsKKyAgICByID0gcXVvdGFfcmVhZCgmYXMtPm0ucXVvdGEs
ICZhcy0+dGlkLCAxKTsKICAgICBpZiAoIXIpIHsKIAlpZiAoYXMtPm0ucXVvdGEubGltaXQgPj0g
MCAmJiBxdW90YWNoZWNrID49IDAgJiYKIAkgICAgYXMtPm0ucXVvdGEudXNlZCArIHF1b3RhY2hl
Y2sgPiAKIAkgICAgKCh1bnNpZ25lZCkgYXMtPm0ucXVvdGEubGltaXQgKiBRVU9UQV9VTklUUykp
IHsKKwkgICAgcXVvdGFfYWJvcnQoJmFzLT50aWQpOwogCSAgICBtYWlsYm94X2Nsb3NlKCZhcy0+
bSk7CiAJICAgIHIgPSBJTUFQX1FVT1RBX0VYQ0VFREVEOwogCX0KQEAgLTI0OSw3ICsyNTEsNiBA
QAogCQkgIHVuc2lnbmVkIGxvbmcgKm51bSkKIHsKICAgICBpbnQgciA9IDA7Ci0gICAgc3RydWN0
IHR4biAqdGlkID0gTlVMTDsKICAgICAKICAgICBpZiAoYXMtPnMgPT0gQVBQRU5EX0RPTkUpIHJl
dHVybiAwOwogCkBAIC0zMDQsMjMgKzMwNSwxMiBAQAogCXJldHVybiByOwogICAgIH0KIAotICAg
IC8qIFdyaXRlIG91dCBxdW90YSBmaWxlICovCi0gICAgciA9IHF1b3RhX3JlYWQoJmFzLT5tLnF1
b3RhLCAmdGlkLCAxKTsKLSAgICBpZiAoIXIpIHsKLQlpZiAoYXMtPm0ucXVvdGEubGltaXQgPj0g
MCAmJiBxdW90YWNoZWNrID49IDAgJiYKLQkgICAgYXMtPm0ucXVvdGEudXNlZCArIHF1b3RhY2hl
Y2sgPiAKLQkgICAgKCh1bnNpZ25lZCkgYXMtPm0ucXVvdGEubGltaXQgKiBRVU9UQV9VTklUUykp
IHsKLQkgICAgcXVvdGFfYWJvcnQoJnRpZCk7Ci0JICAgIGFwcGVuZF9hYm9ydChhcyk7Ci0JICAg
IHJldHVybiBJTUFQX1FVT1RBX0VYQ0VFREVEOwotCX0KLQotCWFzLT5tLnF1b3RhLnVzZWQgKz0g
YXMtPnF1b3RhX3VzZWQ7Ci0JciA9IHF1b3RhX3dyaXRlKCZhcy0+bS5xdW90YSwgJnRpZCk7Ci0J
aWYgKCFyKSBxdW90YV9jb21taXQoJnRpZCk7Ci0gICAgfQotICAgIGVsc2UgaWYgKHIgPT0gSU1B
UF9RVU9UQVJPT1RfTk9ORVhJU1RFTlQpIHIgPSAwOwotICAgIGlmIChyKSB7CisgICAgLyogV3Jp
dGUgb3V0IHVwZGF0ZWQgcXVvdGEgdXNhZ2UgKi8KKyAgICBhcy0+bS5xdW90YS51c2VkICs9IGFz
LT5xdW90YV91c2VkOworICAgIHIgPSBxdW90YV93cml0ZSgmYXMtPm0ucXVvdGEsICZhcy0+dGlk
KTsKKyAgICBpZiAoIXIpIHF1b3RhX2NvbW1pdCgmYXMtPnRpZCk7CisgICAgZWxzZSB7CisJcXVv
dGFfYWJvcnQoJmFzLT50aWQpOwogCXN5c2xvZyhMT0dfRVJSLAogCSAgICAgICAiTE9TVFFVT1RB
OiB1bmFibGUgdG8gcmVjb3JkIHVzZSBvZiAldSBieXRlcyBpbiBxdW90YSBmaWxlICVzIiwKIAkg
ICAgICAgYXMtPnF1b3RhX3VzZWQsIGFzLT5tLnF1b3RhLnJvb3QpOwpAQCAtMzc1LDYgKzM2NSw5
IEBACiAgICAgbWFpbGJveF91bmxvY2tfaGVhZGVyKCZhcy0+bSk7CiAgICAgbWFpbGJveF9jbG9z
ZSgmYXMtPm0pOwogCisgICAgLyogdW5sb2NrIHF1b3RhICovCisgICAgcXVvdGFfYWJvcnQoJmFz
LT50aWQpOworCiAgICAgaWYgKGFzLT5zZWVuX21zZ3JhbmdlKSB7CiAJZnJlZShhcy0+c2Vlbl9t
c2dyYW5nZSk7CiAgICAgfQpAQCAtNDAwLDcgKzM5Myw3IEBACiAgKiBzbyBpdCBjYW4gZG91Ymxl
IGFzIHRoZSBzcG9vbCBmaWxlCiAgKi8KIEZJTEUgKmFwcGVuZF9uZXdzdGFnZShjb25zdCBjaGFy
ICptYWlsYm94bmFtZSwgdGltZV90IGludGVybmFsZGF0ZSwKLQkJICAgICAgc3RydWN0IHN0YWdl
bXNnICoqc3RhZ2VwKQorCQkgICAgICBpbnQgbXNnbnVtLCBzdHJ1Y3Qgc3RhZ2Vtc2cgKipzdGFn
ZXApCiB7CiAgICAgc3RydWN0IHN0YWdlbXNnICpzdGFnZTsKICAgICBjaGFyIHN0YWdlZGlyW01B
WF9NQUlMQk9YX1BBVEgrMV0sIHN0YWdlZmlsZVtNQVhfTUFJTEJPWF9QQVRIKzFdOwpAQCAtNDE0
LDggKzQwNyw4IEBACiAgICAgc3RhZ2UtPnBhcnRzID0geHptYWxsb2MoNSAqIChNQVhfTUFJTEJP
WF9QQVRIKzEpICogc2l6ZW9mKGNoYXIpKTsKICAgICBzdGFnZS0+cGFydGVuZCA9IHN0YWdlLT5w
YXJ0cyArIDUgKiAoTUFYX01BSUxCT1hfUEFUSCsxKSAqIHNpemVvZihjaGFyKTsKIAotICAgIHNu
cHJpbnRmKHN0YWdlLT5mbmFtZSwgc2l6ZW9mKHN0YWdlLT5mbmFtZSksICIlZC0lZCIsCi0JICAg
ICAoaW50KSBnZXRwaWQoKSwgKGludCkgaW50ZXJuYWxkYXRlKTsKKyAgICBzbnByaW50ZihzdGFn
ZS0+Zm5hbWUsIHNpemVvZihzdGFnZS0+Zm5hbWUpLCAiJWQtJWQtJWQiLAorCSAgICAgKGludCkg
Z2V0cGlkKCksIChpbnQpIGludGVybmFsZGF0ZSwgbXNnbnVtKTsKIAogICAgIHIgPSBtYm94bGlz
dF9maW5kc3RhZ2UobWFpbGJveG5hbWUsIHN0YWdlZGlyLCBzaXplb2Yoc3RhZ2VkaXIpKTsKICAg
ICBpZiAocikgewpAQCAtNDU4LDEwICs0NTEsOCBAQAogICogaXMgbXVsdGlwbGUgcGFydGl0aW9u
cy4KICAqLwogaW50IGFwcGVuZF9mcm9tc3RhZ2Uoc3RydWN0IGFwcGVuZHN0YXRlICphcywKLQkJ
ICAgICBzdHJ1Y3QgcHJvdHN0cmVhbSAqbWVzc2FnZWZpbGUsCi0JCSAgICAgdW5zaWduZWQgbG9u
ZyBzaXplLCB0aW1lX3QgaW50ZXJuYWxkYXRlLAotCQkgICAgIGNvbnN0IGNoYXIgKipmbGFnLCBp
bnQgbmZsYWdzLAotCQkgICAgIHN0cnVjdCBzdGFnZW1zZyAqc3RhZ2UpCisJCSAgICAgc3RydWN0
IHN0YWdlbXNnICpzdGFnZSwgdGltZV90IGludGVybmFsZGF0ZSwKKwkJICAgICBjb25zdCBjaGFy
ICoqZmxhZywgaW50IG5mbGFncywgaW50IG5vbGluaykKIHsKICAgICBzdHJ1Y3QgbWFpbGJveCAq
bWFpbGJveCA9ICZhcy0+bTsKICAgICBzdHJ1Y3QgaW5kZXhfcmVjb3JkIG1lc3NhZ2VfaW5kZXg7
CkBAIC00NzcsNyArNDY4LDYgQEAKIAogICAgIGFzc2VydChzdGFnZSAhPSBOVUxMICYmIHN0YWdl
LT5wYXJ0c1swXSAhPSAnXDAnKTsKICAgICBhc3NlcnQobWFpbGJveC0+Zm9ybWF0ID09IE1BSUxC
T1hfRk9STUFUX05PUk1BTCk7Ci0gICAgYXNzZXJ0KHNpemUgIT0gMCk7CiAKICAgICB6ZXJvX2lu
ZGV4KG1lc3NhZ2VfaW5kZXgpOwogCkBAIC01MDcsNyArNDk3LDcgQEAKIAkgICBtYWtlIHN1cmUg
bm90IHRvIG92ZXJ3cml0ZSBzdGFnZS0+cGFydGVuZCAqLwogCiAJLyogY3JlYXRlIHRoZSBuZXcg
c3RhZ2luZyBmaWxlIGZyb20gdGhlIGZpcnN0IHN0YWdlIHBhcnQgKi8KLQlyID0gbWFpbGJveF9j
b3B5ZmlsZShzdGFnZS0+cGFydHMsIHN0YWdlZmlsZSk7CisJciA9IG1haWxib3hfY29weWZpbGUo
c3RhZ2UtPnBhcnRzLCBzdGFnZWZpbGUsIDApOwogCWlmIChyKSB7CiAJICAgIC8qIG1heWJlIHRo
ZSBkaXJlY3RvcnkgZG9lc24ndCBleGlzdD8gKi8KIAkgICAgY2hhciBzdGFnZWRpcltNQVhfTUFJ
TEJPWF9QQVRIKzFdOwpAQCAtNTIwLDcgKzUxMCw3IEBACiAJICAgIH0gZWxzZSB7CiAJCXN5c2xv
ZyhMT0dfTk9USUNFLCAiY3JlYXRlZCBzdGFnZSBkaXJlY3RvcnkgJXMiLAogCQkgICAgICAgc3Rh
Z2VkaXIpOwotCQlyID0gbWFpbGJveF9jb3B5ZmlsZShzdGFnZS0+cGFydHMsIHN0YWdlZmlsZSk7
CisJCXIgPSBtYWlsYm94X2NvcHlmaWxlKHN0YWdlLT5wYXJ0cywgc3RhZ2VmaWxlLCAwKTsKIAkg
ICAgfQogCX0KIAlpZiAocikgewpAQCAtNTYzLDcgKzU1Myw3IEBACiAJCQkgICAgICBmbmFtZSAr
IHN0cmxlbihmbmFtZSksCiAJCQkgICAgICBzaXplb2YoZm5hbWUpIC0gc3RybGVuKGZuYW1lKSk7
CiAKLSAgICByID0gbWFpbGJveF9jb3B5ZmlsZShwLCBmbmFtZSk7CisgICAgciA9IG1haWxib3hf
Y29weWZpbGUocCwgZm5hbWUsIG5vbGluayk7CiAgICAgZGVzdGZpbGUgPSBmb3BlbihmbmFtZSwg
InIiKTsKICAgICBpZiAoIXIgJiYgZGVzdGZpbGUpIHsKIAkvKiBvaywgd2UndmUgc3VjY2Vzc2Z1
bGx5IGNyZWF0ZWQgdGhlIGZpbGUgKi8KQEAgLTg1Miw3ICs4NDIsNyBAQAogCSAgICBtYWlsYm94
X21lc3NhZ2VfZ2V0X2ZuYW1lKG1haWxib3gsIGNvcHltc2dbbXNnXS51aWQsIGZuYW1lYnVmLAog
CQkJCSAgICAgIHNpemVvZihmbmFtZWJ1ZikpOwogCSAgICAvKiBMaW5rL2NvcHkgbWVzc2FnZSBm
aWxlICovCi0JICAgIHIgPSBtYWlsYm94X2NvcHlmaWxlKGZuYW1lYnVmLCBmbmFtZSk7CisJICAg
IHIgPSBtYWlsYm94X2NvcHlmaWxlKGZuYW1lYnVmLCBmbmFtZSwgMCk7CiAJICAgIGlmIChyKSBn
b3RvIGZhaWw7CiAKIAkgICAgLyogV3JpdGUgb3V0IGNhY2hlIGluZm8sIGNvcHkgb3RoZXIgaW5m
byAqLwpJbmRleDogaW1hcC9hcHBlbmQuaAo9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09
PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09ClJDUyBmaWxlOiAvYWZzL2FuZHJl
dy9zeXN0ZW0vY3ZzL3NyYy9jeXJ1cy9pbWFwL2FwcGVuZC5oLHYKcmV0cmlldmluZyByZXZpc2lv
biAxLjI1CnJldHJpZXZpbmcgcmV2aXNpb24gMS4yNgpkaWZmIC11IC11IC1yMS4yNSAtcjEuMjYK
LS0tIGltYXAvYXBwZW5kLmgJMjAgSmFuIDIwMDQgMDE6MTA6NTUgLTAwMDAJMS4yNQorKysgaW1h
cC9hcHBlbmQuaAkyMiBKYW4gMjAwNCAyMToxNzowNyAtMDAwMAkxLjI2CkBAIC0xLDUgKzEsNSBA
QAogLyogYXBwZW5kLmggLS0gRGVzY3JpcHRpb24gb2YgbWVzc2FnZXMgdG8gYmUgY29waWVkIAot
ICogJElkOiBhcHBlbmQuaCx2IDEuMjUgMjAwNC8wMS8yMCAwMToxMDo1NSBrZW4zIEV4cCAkIAor
ICogJElkOiBhcHBlbmQuaCx2IDEuMjYgMjAwNC8wMS8yMiAyMToxNzowNyBrZW4zIEV4cCAkIAog
ICoKICAqIENvcHlyaWdodCAoYykgMTk5OCwgMjAwMCBDYXJuZWdpZSBNZWxsb24gVW5pdmVyc2l0
eS4gIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAgKgpAQCAtOTAsNiArOTAsOSBAQAogCiAgICAgLyog
dGhlIGFtb3VudCBvZiBxdW90YSB3ZSd2ZSB1c2VkIHNvIGZhciBpbiB0aGlzIGFwcGVuZCAqLwog
ICAgIGludCBxdW90YV91c2VkOworCisgICAgLyogdHhuIGZvciB1cGRhdGluZyBxdW90YSAqLwor
ICAgIHN0cnVjdCB0eG4gKnRpZDsKIH07CiAKIC8qIGFkZCBoZWxwZXIgZnVuY3Rpb24gdG8gZGV0
ZXJtaW5lIHVpZCByYW5nZSBhcHBlbmRlZD8gKi8KQEAgLTExNywxNCArMTIwLDEyIEBACiAKIC8q
IGNyZWF0ZXMgYSBuZXcgc3RhZ2UgYW5kIHJldHVybnMgc3RhZ2UgZmlsZSBjb3JyZXNwb25kaW5n
IHRvIG1haWxib3huYW1lICovCiBleHRlcm4gRklMRSAqYXBwZW5kX25ld3N0YWdlKGNvbnN0IGNo
YXIgKm1haWxib3huYW1lLCB0aW1lX3QgaW50ZXJuYWxkYXRlLAotCQkJICAgICBzdHJ1Y3Qgc3Rh
Z2Vtc2cgKipzdGFnZXApOworCQkJICAgICBpbnQgbXNnbnVtLCBzdHJ1Y3Qgc3RhZ2Vtc2cgKipz
dGFnZXApOwogCiAvKiBhZGRzIGEgbmV3IG1haWxib3ggdG8gdGhlIHN0YWdlIGluaXRpYWxseSBj
cmVhdGVkIGJ5IGFwcGVuZF9uZXdzdGFnZSgpICovCiBleHRlcm4gaW50IGFwcGVuZF9mcm9tc3Rh
Z2Uoc3RydWN0IGFwcGVuZHN0YXRlICptYWlsYm94LAotCQkJICAgIHN0cnVjdCBwcm90c3RyZWFt
ICptZXNzYWdlZmlsZSwKLQkJCSAgICB1bnNpZ25lZCBsb25nIHNpemUsIHRpbWVfdCBpbnRlcm5h
bGRhdGUsCi0JCQkgICAgY29uc3QgY2hhciAqKmZsYWcsIGludCBuZmxhZ3MsCi0JCQkgICAgc3Ry
dWN0IHN0YWdlbXNnICpzdGFnZSk7CisJCQkgICAgc3RydWN0IHN0YWdlbXNnICpzdGFnZSwgdGlt
ZV90IGludGVybmFsZGF0ZSwKKwkJCSAgICBjb25zdCBjaGFyICoqZmxhZywgaW50IG5mbGFncywg
aW50IG5vbGluayk7CiAKIC8qIHJlbW92ZXMgdGhlIHN0YWdlIChmcmVlcyBtZW1vcnksIGRlbGV0
ZXMgdGhlIHN0YWdpbmcgZmlsZXMpICovCiBleHRlcm4gaW50IGFwcGVuZF9yZW1vdmVzdGFnZShz
dHJ1Y3Qgc3RhZ2Vtc2cgKnN0YWdlKTsKSW5kZXg6IGltYXAvaW1hcGQuYwo9PT09PT09PT09PT09
PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09ClJD
UyBmaWxlOiAvYWZzL2FuZHJldy9zeXN0ZW0vY3ZzL3NyYy9jeXJ1cy9pbWFwL2ltYXBkLmMsdgpy
ZXRyaWV2aW5nIHJldmlzaW9uIDEuNDUwCnJldHJpZXZpbmcgcmV2aXNpb24gMS40NTEKZGlmZiAt
dSAtdSAtcjEuNDUwIC1yMS40NTEKLS0tIGltYXAvaW1hcGQuYwkyMCBKYW4gMjAwNCAwMToxMDo1
NiAtMDAwMAkxLjQ1MAorKysgaW1hcC9pbWFwZC5jCTIyIEphbiAyMDA0IDIxOjE3OjA3IC0wMDAw
CTEuNDUxCkBAIC0zOCw3ICszOCw3IEBACiAgKiBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRI
IFRIRSBVU0UgT1IgUEVSRk9STUFOQ0UgT0YgVEhJUyBTT0ZUV0FSRS4KICAqLwogCi0vKiAkSWQ6
IGltYXBkLmMsdiAxLjQ1MCAyMDA0LzAxLzIwIDAxOjEwOjU2IGtlbjMgRXhwICQgKi8KKy8qICRJ
ZDogaW1hcGQuYyx2IDEuNDUxIDIwMDQvMDEvMjIgMjE6MTc6MDcga2VuMyBFeHAgJCAqLwogCiAj
aW5jbHVkZSA8Y29uZmlnLmg+CiAKQEAgLTIxNTAsMjMgKzIxNTAsMjYgQEAKICAgICBpbnQgbmZs
YWdzID0gMCwgZmxhZ2FsbG9jID0gMDsKICAgICBzdGF0aWMgc3RydWN0IGJ1ZiBhcmc7CiAgICAg
Y2hhciAqcDsKLSAgICB0aW1lX3QgaW50ZXJuYWxkYXRlOwotICAgIHVuc2lnbmVkIHNpemUgPSAw
OworICAgIHRpbWVfdCBpbnRlcm5hbGRhdGUsIG5vdyA9IHRpbWUoTlVMTCk7CisgICAgdW5zaWdu
ZWQgc2l6ZSwgdG90YWxzaXplID0gMDsKICAgICBpbnQgc2F3ZGlnaXQgPSAwOwogICAgIGludCBp
c25vd2FpdCA9IDA7Ci0gICAgaW50IHI7CisgICAgaW50IHIsIGk7CiAgICAgY2hhciBtYWlsYm94
bmFtZVtNQVhfTUFJTEJPWF9OQU1FKzFdOwogICAgIHN0cnVjdCBhcHBlbmRzdGF0ZSBtYWlsYm94
OwogICAgIHVuc2lnbmVkIGxvbmcgdWlkdmFsaWRpdHk7Ci0gICAgdW5zaWduZWQgbG9uZyBmaXJz
dHVpZCwgbnVtOworICAgIHVuc2lnbmVkIGxvbmcgZmlyc3R1aWQsIG51bSA9IDA7CiAgICAgY29u
c3QgY2hhciAqcGFyc2VlcnIgPSBOVUxMOworICAgIEZJTEUgKmY7CisgICAgaW50IG51bWFsbG9j
ID0gNTsKKyAgICBzdHJ1Y3Qgc3RhZ2Vtc2cgKipzdGFnZSA9IHhtYWxsb2MobnVtYWxsb2MgKiBz
aXplb2Yoc3RydWN0IHN0YWdlbXNnICopKTsKIAotICAgIC8qIFNldCB1cCB0aGUgYXBwZW5kICov
CisgICAgLyogU2VlIGlmIHdlIGNhbiBhcHBlbmQgKi8KICAgICByID0gKCppbWFwZF9uYW1lc3Bh
Y2UubWJveG5hbWVfdG9pbnRlcm5hbCkoJmltYXBkX25hbWVzcGFjZSwgbmFtZSwKIAkJCQkJICAg
ICAgIGltYXBkX3VzZXJpZCwgbWFpbGJveG5hbWUpOwogICAgIGlmICghcikgewotCXIgPSBhcHBl
bmRfc2V0dXAoJm1haWxib3gsIG1haWxib3huYW1lLCBNQUlMQk9YX0ZPUk1BVF9OT1JNQUwsCi0J
CQkgaW1hcGRfdXNlcmlkLCBpbWFwZF9hdXRoc3RhdGUsIEFDTF9JTlNFUlQsIHNpemUpOworCXIg
PSBhcHBlbmRfY2hlY2sobWFpbGJveG5hbWUsIE1BSUxCT1hfRk9STUFUX05PUk1BTCwKKwkJCSBp
bWFwZF9hdXRoc3RhdGUsIEFDTF9JTlNFUlQsIHRvdGFsc2l6ZSk7CiAgICAgfQogICAgIGlmIChy
KSB7CiAJZWF0bGluZShpbWFwZF9pbiwgJyAnKTsKQEAgLTIyODcsMTAgKzIyOTAsMjIgQEAKIAkg
ICAgcHJvdF9mbHVzaChpbWFwZF9vdXQpOwogCX0KIAkKLQkvKiBQZXJmb3JtIHRoZSByZXN0IG9m
IHRoZSBhcHBlbmQgKi8KLQlpZiAoIXIpIHIgPSBhcHBlbmRfZnJvbXN0cmVhbSgmbWFpbGJveCwg
aW1hcGRfaW4sIHNpemUsIGludGVybmFsZGF0ZSwgCi0JCQkJICAgICAgKGNvbnN0IGNoYXIgKiop
IGZsYWcsIG5mbGFncyk7Ci0KKwkvKiBTdGFnZSB0aGUgbWVzc2FnZSAqLworCWlmIChudW0gPT0g
bnVtYWxsb2MpIHsKKwkgICAgbnVtYWxsb2MgKj0gMjsKKwkgICAgc3RhZ2UgPSB4cmVhbGxvYyhz
dGFnZSwgbnVtYWxsb2MgKiBzaXplb2Yoc3RydWN0IHN0YWdlbXNnICopKTsKKwl9CisJc3RhZ2Vb
bnVtXSA9IE5VTEw7CisJZiA9IGFwcGVuZF9uZXdzdGFnZShtYWlsYm94bmFtZSwgbm93LCBudW0s
ICZzdGFnZVtudW1dKTsKKwlpZiAoZikgeworCSAgICBudW0rKzsKKwkgICAgdG90YWxzaXplICs9
IHNpemU7CisJICAgIHIgPSBtZXNzYWdlX2NvcHlfc3RyaWN0KGltYXBkX2luLCBmLCBzaXplKTsK
KwkgICAgZmNsb3NlKGYpOworCX0gZWxzZSB7CisJICAgIHIgPSBJTUFQX0lPRVJST1I7CisJfQor
CQogCS8qIGlmIHdlIHNlZSBhIFNQLCB3ZSdyZSB0cnlpbmcgdG8gYXBwZW5kIG1vcmUgdGhhbiBv
bmUgbWVzc2FnZSAqLwogCiAJLyogUGFyc2UgbmV3bGluZSB0ZXJtaW5hdGluZyBjb21tYW5kICov
CkBAIC0yMzEwLDExICsyMzI1LDI3IEBACiAJfQogICAgIH0KIAorICAgIC8qIEFwcGVuZCBmcm9t
IHRoZSBzdGFnZShzKSAqLwogICAgIGlmICghcikgewotCXIgPSBhcHBlbmRfY29tbWl0KCZtYWls
Ym94LCBzaXplLCAmdWlkdmFsaWRpdHksICZmaXJzdHVpZCwgJm51bSk7Ci0gICAgfSBlbHNlIHsK
LQlhcHBlbmRfYWJvcnQoJm1haWxib3gpOworCXIgPSBhcHBlbmRfc2V0dXAoJm1haWxib3gsIG1h
aWxib3huYW1lLCBNQUlMQk9YX0ZPUk1BVF9OT1JNQUwsCisJCQkgaW1hcGRfdXNlcmlkLCBpbWFw
ZF9hdXRoc3RhdGUsIEFDTF9JTlNFUlQsIHRvdGFsc2l6ZSk7CisJZm9yIChpID0gMDsgIXIgJiYg
aSA8IG51bTsgaSsrKSB7CisJICAgIHIgPSBhcHBlbmRfZnJvbXN0YWdlKCZtYWlsYm94LCBzdGFn
ZVtpXSwgaW50ZXJuYWxkYXRlLCAKKwkJCQkgKGNvbnN0IGNoYXIgKiopIGZsYWcsIG5mbGFncywg
MCk7CisJfQorCisJaWYgKCFyKSB7CisJICAgIHIgPSBhcHBlbmRfY29tbWl0KCZtYWlsYm94LCB0
b3RhbHNpemUsICZ1aWR2YWxpZGl0eSwgJmZpcnN0dWlkLCAmbnVtKTsKKwl9IGVsc2UgeworCSAg
ICBhcHBlbmRfYWJvcnQoJm1haWxib3gpOworCX0KKyAgICB9CisKKyAgICAvKiBDbGVhbnVwIHRo
ZSBzdGFnZShzKSAqLworICAgIGZvciAoaSA9IDA7IGkgPCBudW07IGkrKykgeworCWFwcGVuZF9y
ZW1vdmVzdGFnZShzdGFnZVtpXSk7CiAgICAgfQorICAgIGZyZWUoc3RhZ2UpOwogCiAgICAgaWYg
KGltYXBkX21haWxib3gpIHsKIAlpbmRleF9jaGVjayhpbWFwZF9tYWlsYm94LCAwLCAwKTsKSW5k
ZXg6IGltYXAvbG10cGQuYwo9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09
PT09PT09PT09PT09PT09PT09PT09PT09PT09ClJDUyBmaWxlOiAvYWZzL2FuZHJldy9zeXN0ZW0v
Y3ZzL3NyYy9jeXJ1cy9pbWFwL2xtdHBkLmMsdgpyZXRyaWV2aW5nIHJldmlzaW9uIDEuMTI2CnJl
dHJpZXZpbmcgcmV2aXNpb24gMS4xMjcKZGlmZiAtdSAtdSAtcjEuMTI2IC1yMS4xMjcKLS0tIGlt
YXAvbG10cGQuYwkyMCBKYW4gMjAwNCAwMToxMDo1OCAtMDAwMAkxLjEyNgorKysgaW1hcC9sbXRw
ZC5jCTIyIEphbiAyMDA0IDIxOjE3OjA4IC0wMDAwCTEuMTI3CkBAIC0xLDYgKzEsNiBAQAogLyog
bG10cGQuYyAtLSBQcm9ncmFtIHRvIGRlbGl2ZXIgbWFpbCB0byBhIG1haWxib3gKICAqCi0gKiAk
SWQ6IGxtdHBkLmMsdiAxLjEyNiAyMDA0LzAxLzIwIDAxOjEwOjU4IGtlbjMgRXhwICQKKyAqICRJ
ZDogbG10cGQuYyx2IDEuMTI3IDIwMDQvMDEvMjIgMjE6MTc6MDgga2VuMyBFeHAgJAogICogQ29w
eXJpZ2h0IChjKSAxOTk4LTIwMDMgQ2FybmVnaWUgTWVsbG9uIFVuaXZlcnNpdHkuICBBbGwgcmln
aHRzIHJlc2VydmVkLgogICoKICAqIFJlZGlzdHJpYnV0aW9uIGFuZCB1c2UgaW4gc291cmNlIGFu
ZCBiaW5hcnkgZm9ybXMsIHdpdGggb3Igd2l0aG91dApAQCAtMTA3MywxMyArMTA3Myw4IEBACiAK
ICAgICBpZiAoIXIpIHsKIAlwcm90X3Jld2luZChtc2cpOwotCWlmIChzdGFnZSkgewotCSAgICBy
ID0gYXBwZW5kX2Zyb21zdGFnZSgmYXMsIG1zZywgc2l6ZSwgbm93LCAKLQkJCQkgKGNvbnN0IGNo
YXIgKiopIGZsYWcsIG5mbGFncywgc3RhZ2UpOwotCX0gZWxzZSB7Ci0JICAgIHIgPSBhcHBlbmRf
ZnJvbXN0cmVhbSgmYXMsIG1zZywgc2l6ZSwgbm93LCAKLQkJCQkgIChjb25zdCBjaGFyICoqKSBm
bGFnLCBuZmxhZ3MpOwotCX0KKwlyID0gYXBwZW5kX2Zyb21zdGFnZSgmYXMsIHN0YWdlLCBub3cs
CisJCQkgICAgIChjb25zdCBjaGFyICoqKSBmbGFnLCBuZmxhZ3MsICFzaW5nbGVpbnN0YW5jZSk7
CiAJaWYgKCFyKSBhcHBlbmRfY29tbWl0KCZhcywgcXVvdGFvdmVycmlkZSA/IC0xIDogMCwgTlVM
TCwgJnVpZCwgTlVMTCk7CiAJZWxzZSBhcHBlbmRfYWJvcnQoJmFzKTsKICAgICB9CkBAIC0xMzk4
LDE3ICsxMzkzLDE5IEBACiAKIEZJTEUgKnNwb29sZmlsZShtZXNzYWdlX2RhdGFfdCAqbXNnZGF0
YSkKIHsKLSAgICAvKiBpZiB3ZSBoYXZlIGEgc2luZ2xlIHJlY2lwaWVudCBPUiBhcmUgdXNpbmcg
c2luZ2xlLWluc3RhbmNlIHN0b3JlLAotICAgICAqIHNwb29sIHRvIHRoZSBzdGFnZSBvZiB0aGUg
Zmlyc3QgcmVjaXBpZW50Ci0gICAgICovCi0gICAgaWYgKChtc2dfZ2V0bnVtcmNwdChtc2dkYXRh
KSA9PSAxKSB8fCBzaW5nbGVpbnN0YW5jZSkgeworICAgIGludCBpLCBuOworICAgIHRpbWVfdCBu
b3cgPSB0aW1lKE5VTEwpOworICAgIEZJTEUgKmYgPSBOVUxMOworCisgICAgLyogc3Bvb2wgdG8g
dGhlIHN0YWdlIG9mIG9uZSBvZiB0aGUgcmVjaXBpZW50cyAqLworICAgIG4gPSBtc2dfZ2V0bnVt
cmNwdChtc2dkYXRhKTsKKyAgICBmb3IgKGkgPSAwOyAhZiAmJiAoaSA8IG4pOyBpKyspIHsKIAlp
bnQgciA9IDA7CiAJY2hhciAqcmNwdCwgKnBsdXMsICp1c2VyID0gTlVMTCwgKmRvbWFpbiA9IE5V
TEw7CiAJY2hhciBuYW1lYnVmW01BWF9NQUlMQk9YX1BBVEgrMV0sIG1haWxib3huYW1lW01BWF9N
QUlMQk9YX1BBVEgrMV07Ci0JdGltZV90IG5vdyA9IHRpbWUoTlVMTCk7CiAKIAkvKiBidWlsZCB0
aGUgbWFpbGJveG5hbWUgZnJvbSB0aGUgcmVjaXBpZW50IGFkZHJlc3MgKi8KLQl1c2VyID0gcmNw
dCA9IHhzdHJkdXAobXNnX2dldHJjcHQobXNnZGF0YSwgMCkpOworCXVzZXIgPSByY3B0ID0geHN0
cmR1cChtc2dfZ2V0cmNwdChtc2dkYXRhLCBpKSk7CiAJaWYgKGNvbmZpZ192aXJ0ZG9tYWlucyAm
JiAoZG9tYWluID0gc3RyY2hyKHJjcHQsICdAJykpKSB7CiAJICAgICpkb21haW4gPSAnXDAnOwog
CX0KQEAgLTE0NjAsMTkgKzE0NTcsMTUgQEAKIAlmcmVlKHJjcHQpOwogCiAJaWYgKCFyKSB7Ci0J
ICAgIEZJTEUgKmY7CiAJICAgIHN0cnVjdCBzdGFnZW1zZyAqc3RhZ2UgPSBOVUxMOwogCiAJICAg
IC8qIHNldHVwIHN0YWdlIGZvciBsYXRlciB1c2UgYnkgZGVsaXZlcigpICovCi0JICAgIGYgPSBh
cHBlbmRfbmV3c3RhZ2UobWFpbGJveG5hbWUsIG5vdywgJnN0YWdlKTsKKwkgICAgZiA9IGFwcGVu
ZF9uZXdzdGFnZShtYWlsYm94bmFtZSwgbm93LCAwLCAmc3RhZ2UpOwogCSAgICBtc2dfc2V0cm9j
ayhtc2dkYXRhLCAodm9pZCopIHN0YWdlKTsKLQotCSAgICByZXR1cm4gZjsKIAl9CiAgICAgfQog
Ci0gICAgLyogc3Bvb2wgdG8gL3RtcCAobm8gc2luZ2xlLWluc3RhbmNlIHN0b3JlKSAqLwotICAg
IHJldHVybiB0bXBmaWxlKCk7CisgICAgcmV0dXJuIGY7CiB9CiAKIHZvaWQgcmVtb3Zlc3Bvb2wo
bWVzc2FnZV9kYXRhX3QgKm1zZ2RhdGEpCkluZGV4OiBpbWFwL21haWxib3guYwo9PT09PT09PT09
PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09
ClJDUyBmaWxlOiAvYWZzL2FuZHJldy9zeXN0ZW0vY3ZzL3NyYy9jeXJ1cy9pbWFwL21haWxib3gu
Yyx2CnJldHJpZXZpbmcgcmV2aXNpb24gMS4xNTIKcmV0cmlldmluZyByZXZpc2lvbiAxLjE1Mwpk
aWZmIC11IC11IC1yMS4xNTIgLXIxLjE1MwotLS0gaW1hcC9tYWlsYm94LmMJMjAgSmFuIDIwMDQg
MDE6MTA6NTggLTAwMDAJMS4xNTIKKysrIGltYXAvbWFpbGJveC5jCTIyIEphbiAyMDA0IDIxOjE3
OjA5IC0wMDAwCTEuMTUzCkBAIC0xLDUgKzEsNSBAQAogLyogbWFpbGJveC5jIC0tIE1haWxib3gg
bWFuaXB1bGF0aW9uIHJvdXRpbmVzCi0gKiAkSWQ6IG1haWxib3guYyx2IDEuMTUyIDIwMDQvMDEv
MjAgMDE6MTA6NTgga2VuMyBFeHAgJAorICogJElkOiBtYWlsYm94LmMsdiAxLjE1MyAyMDA0LzAx
LzIyIDIxOjE3OjA5IGtlbjMgRXhwICQKICAqIENvcHlyaWdodCAoYykgMTk5OC0yMDAzIENhcm5l
Z2llIE1lbGxvbiBVbml2ZXJzaXR5LiAgQWxsIHJpZ2h0cyByZXNlcnZlZC4KICAqCiAgKiBSZWRp
c3RyaWJ1dGlvbiBhbmQgdXNlIGluIHNvdXJjZSBhbmQgYmluYXJ5IGZvcm1zLCB3aXRoIG9yIHdp
dGhvdXQKQEAgLTIyOTcsMTMgKzIyOTcsMTMgQEAKICAgICBzdHJsY3B5KG5ld2ZuYW1ldGFpbCwg
Rk5BTUVfSU5ERVgsIHNpemVvZihuZXdmbmFtZSkgLSBuZXdmbmFtZV9sZW4pOwogICAgIHVubGlu
ayhuZXdmbmFtZSk7CQkvKiBNYWtlIGxpbmsoKSBwb3NzaWJsZSAqLwogCi0gICAgciA9IG1haWxi
b3hfY29weWZpbGUob2xkZm5hbWUsIG5ld2ZuYW1lKTsKKyAgICByID0gbWFpbGJveF9jb3B5Zmls
ZShvbGRmbmFtZSwgbmV3Zm5hbWUsIDApOwogCiAgICAgc3RybGNweShvbGRmbmFtZXRhaWwsIEZO
QU1FX0NBQ0hFLCBzaXplb2Yob2xkZm5hbWUpIC0gb2xkZm5hbWVfbGVuKTsKICAgICBzdHJsY3B5
KG5ld2ZuYW1ldGFpbCwgRk5BTUVfQ0FDSEUsIHNpemVvZihuZXdmbmFtZSkgLSBuZXdmbmFtZV9s
ZW4pOwogICAgIHVubGluayhuZXdmbmFtZSk7CiAKLSAgICBpZiAoIXIpIHIgPSBtYWlsYm94X2Nv
cHlmaWxlKG9sZGZuYW1lLCBuZXdmbmFtZSk7CisgICAgaWYgKCFyKSByID0gbWFpbGJveF9jb3B5
ZmlsZShvbGRmbmFtZSwgbmV3Zm5hbWUsIDApOwogICAgIGlmIChyKSB7CiAJbWFpbGJveF9jbG9z
ZShuZXdtYWlsYm94KTsKIAlyZXR1cm4gcjsKQEAgLTIzMzMsNyArMjMzMyw3IEBACiAKIAlzdHJj
cHkobmV3Zm5hbWV0YWlsLCBvbGRmbmFtZXRhaWwpOwogCi0JciA9IG1haWxib3hfY29weWZpbGUo
b2xkZm5hbWUsIG5ld2ZuYW1lKTsKKwlyID0gbWFpbGJveF9jb3B5ZmlsZShvbGRmbmFtZSwgbmV3
Zm5hbWUsIDApOwogCWlmIChyKSBicmVhazsKICAgICB9CiAgICAgaWYgKCFyKSByID0gc2Vlbl9j
b3B5KG9sZG1haWxib3gsIG5ld21haWxib3gpOwpAQCAtMjUyNCw3ICsyNTI0LDcgQEAKIAkJCQkg
ICAgICBvbGRmbmFtZXRhaWwsCiAJCQkJICAgICAgc2l6ZW9mKG9sZGZuYW1lKSAtIHN0cmxlbihv
bGRmbmFtZSkpOwogCSAgICBzdHJjcHkobmV3Zm5hbWV0YWlsLCBvbGRmbmFtZXRhaWwpOwotCSAg
ICByID0gbWFpbGJveF9jb3B5ZmlsZShvbGRmbmFtZSwgbmV3Zm5hbWUpOworCSAgICByID0gbWFp
bGJveF9jb3B5ZmlsZShvbGRmbmFtZSwgbmV3Zm5hbWUsIDApOwogCSAgICBpZiAocikgYnJlYWs7
CiAJfQogICAgIH0KQEAgLTI1NTUsNyArMjU1NSw3IEBACiAJICAgICAgICBzaXplb2YobmV3Zm5h
bWUpIC0gKG5ld2ZuYW1lX2xlbiAtIDEpKTsKIAogCXVubGluayhuZXdmbmFtZSk7CQkvKiBNYWtl
IGxpbmsoKSBwb3NzaWJsZSAqLwotCXIgPSBtYWlsYm94X2NvcHlmaWxlKG9sZGZuYW1lLCBuZXdm
bmFtZSk7CisJciA9IG1haWxib3hfY29weWZpbGUob2xkZm5hbWUsIG5ld2ZuYW1lLCAwKTsKIAog
CWZuX2xlbiA9IHN0cmxlbihGTkFNRV9DQUNIRSk7CiAJaWYoKG9sZGZuYW1lX2xlbiAtIDEpICsg
Zm5fbGVuID4gc2l6ZW9mKG9sZGZuYW1lKSkKQEAgLTI1NzcsNyArMjU3Nyw3IEBACiAJICAgICAg
ICBzaXplb2YobmV3Zm5hbWUpIC0gKG5ld2ZuYW1lX2xlbiAtIDEpKTsKIAogCXVubGluayhuZXdm
bmFtZSk7Ci0JaWYgKCFyKSByID0gbWFpbGJveF9jb3B5ZmlsZShvbGRmbmFtZSwgbmV3Zm5hbWUp
OworCWlmICghcikgciA9IG1haWxib3hfY29weWZpbGUob2xkZm5hbWUsIG5ld2ZuYW1lLCAwKTsK
IAogCWlmIChyKSB7CiAJICAgIG1haWxib3hfY2xvc2UoJm5ld21haWxib3gpOwpAQCAtMjY0NCw5
ICsyNjQ0LDcgQEAKIC8qCiAgKiBDb3B5IChvciBsaW5rKSB0aGUgZmlsZSAnZnJvbScgdG8gdGhl
IGZpbGUgJ3RvJwogICovCi1pbnQgbWFpbGJveF9jb3B5ZmlsZShmcm9tLCB0bykKLWNvbnN0IGNo
YXIgKmZyb207Ci1jb25zdCBjaGFyICp0bzsKK2ludCBtYWlsYm94X2NvcHlmaWxlKGNvbnN0IGNo
YXIgKmZyb20sIGNvbnN0IGNoYXIgKnRvLCBpbnQgbm9saW5rKQogewogICAgIGludCBzcmNmZCwg
ZGVzdGZkOwogICAgIHN0cnVjdCBzdGF0IHNidWY7CkBAIC0yNjU0LDEzICsyNjUyLDE1IEBACiAg
ICAgdW5zaWduZWQgbG9uZyBzcmNfc2l6ZSA9IDA7CiAgICAgaW50IG47CiAKLSAgICBpZiAobGlu
ayhmcm9tLCB0bykgPT0gMCkgcmV0dXJuIDA7Ci0gICAgaWYgKGVycm5vID09IEVFWElTVCkgewot
CWlmICh1bmxpbmsodG8pID09IC0xKSB7Ci0JICAgIHN5c2xvZyhMT0dfRVJSLCAiSU9FUlJPUjog
dW5saW5raW5nIHRvIHJlY3JlYXRlICVzOiAlbSIsIHRvKTsKLQkgICAgcmV0dXJuIElNQVBfSU9F
UlJPUjsKLQl9CisgICAgaWYgKCFub2xpbmspIHsKIAlpZiAobGluayhmcm9tLCB0bykgPT0gMCkg
cmV0dXJuIDA7CisJaWYgKGVycm5vID09IEVFWElTVCkgeworCSAgICBpZiAodW5saW5rKHRvKSA9
PSAtMSkgeworCQlzeXNsb2coTE9HX0VSUiwgIklPRVJST1I6IHVubGlua2luZyB0byByZWNyZWF0
ZSAlczogJW0iLCB0byk7CisJCXJldHVybiBJTUFQX0lPRVJST1I7CisJICAgIH0KKwkgICAgaWYg
KGxpbmsoZnJvbSwgdG8pID09IDApIHJldHVybiAwOworCX0KICAgICB9CiAgICAgCiAgICAgZGVz
dGZkID0gb3Blbih0bywgT19SRFdSfE9fVFJVTkN8T19DUkVBVCwgMDY2Nik7CkluZGV4OiBpbWFw
L21haWxib3guaAo9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09
PT09PT09PT09PT09PT09PT09PT09ClJDUyBmaWxlOiAvYWZzL2FuZHJldy9zeXN0ZW0vY3ZzL3Ny
Yy9jeXJ1cy9pbWFwL21haWxib3guaCx2CnJldHJpZXZpbmcgcmV2aXNpb24gMS44MApyZXRyaWV2
aW5nIHJldmlzaW9uIDEuODEKZGlmZiAtdSAtdSAtcjEuODAgLXIxLjgxCi0tLSBpbWFwL21haWxi
b3guaAkyMCBKYW4gMjAwNCAwMToxMTowMCAtMDAwMAkxLjgwCisrKyBpbWFwL21haWxib3guaAky
MiBKYW4gMjAwNCAyMToxNzowOSAtMDAwMAkxLjgxCkBAIC0xLDUgKzEsNSBAQAogLyogbWFpbGJv
eC5oIC0tIE1haWxib3ggZm9ybWF0IGRlZmluaXRpb25zCi0gKiAkSWQ6IG1haWxib3guaCx2IDEu
ODAgMjAwNC8wMS8yMCAwMToxMTowMCBrZW4zIEV4cCAkCisgKiAkSWQ6IG1haWxib3guaCx2IDEu
ODEgMjAwNC8wMS8yMiAyMToxNzowOSBrZW4zIEV4cCAkCiAgKgogICogQ29weXJpZ2h0IChjKSAx
OTk4LTIwMDMgQ2FybmVnaWUgTWVsbG9uIFVuaXZlcnNpdHkuICBBbGwgcmlnaHRzIHJlc2VydmVk
LgogICoKQEAgLTMxOSw3ICszMTksNyBAQAogCQkJYml0MzIgKm9sZHVpZHZhbGlkaXR5cCwgYml0
MzIgKm5ld3VpZHZhbGlkdHlwLAogCQkJc3RydWN0IG1haWxib3ggKm1haWxib3hwKTsKIAotZXh0
ZXJuIGludCBtYWlsYm94X2NvcHlmaWxlKGNvbnN0IGNoYXIgKmZyb20sIGNvbnN0IGNoYXIgKnRv
KTsKK2V4dGVybiBpbnQgbWFpbGJveF9jb3B5ZmlsZShjb25zdCBjaGFyICpmcm9tLCBjb25zdCBj
aGFyICp0bywgaW50IG5vbGluayk7CiBleHRlcm4gdm9pZCBtYWlsYm94X2hhc2hfbWJveChjaGFy
ICpidWYsIHNpemVfdCBidWZfbGVuLAogCQkJICAgICAgY29uc3QgY2hhciAqcm9vdCwgY29uc3Qg
Y2hhciAqbmFtZSk7CiAKSW5kZXg6IGltYXAvbm50cGQuYwo9PT09PT09PT09PT09PT09PT09PT09
PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09ClJDUyBmaWxlOiAv
YWZzL2FuZHJldy9zeXN0ZW0vY3ZzL3NyYy9jeXJ1cy9pbWFwL25udHBkLmMsdgpyZXRyaWV2aW5n
IHJldmlzaW9uIDEuMTEKcmV0cmlldmluZyByZXZpc2lvbiAxLjEyCmRpZmYgLXUgLXUgLXIxLjEx
IC1yMS4xMgotLS0gaW1hcC9ubnRwZC5jCTIwIEphbiAyMDA0IDAxOjExOjAxIC0wMDAwCTEuMTEK
KysrIGltYXAvbm50cGQuYwkyMiBKYW4gMjAwNCAyMToxNzowOSAtMDAwMAkxLjEyCkBAIC0zOCw3
ICszOCw3IEBACiAgKiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIE5FR0xJR0VOQ0UgT1IgT1RIRVIg
VE9SVElPVVMgQUNUSU9OLCBBUklTSU5HCiAgKiBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRI
IFRIRSBVU0UgT1IgUEVSRk9STUFOQ0UgT0YgVEhJUyBTT0ZUV0FSRS4KICAqCi0gKiAkSWQ6IG5u
dHBkLmMsdiAxLjExIDIwMDQvMDEvMjAgMDE6MTE6MDEga2VuMyBFeHAgJAorICogJElkOiBubnRw
ZC5jLHYgMS4xMiAyMDA0LzAxLzIyIDIxOjE3OjA5IGtlbjMgRXhwICQKICAqLwogCiAvKgpAQCAt
Mjg3Miw5ICsyODcyLDEwIEBACiB7CiAgICAgc3RydWN0IHN0YXQgc2J1ZjsKICAgICBjb25zdCBj
aGFyICoqYm9keTsKLSAgICBpbnQgcjsKKyAgICBpbnQgciwgaTsKICAgICB0aW1lX3Qgbm93ID0g
dGltZShOVUxMKTsKICAgICBzdGF0aWMgaW50IHBvc3RfY291bnQgPSAwOworICAgIEZJTEUgKnN0
YWdlZiA9IE5VTEw7CiAKICAgICAvKiBmaWxsIHRoZSBjYWNoZSAqLwogICAgIHIgPSBzcG9vbF9m
aWxsX2hkcmNhY2hlKG5udHBfaW4sIGYsIG0tPmhkcmNhY2hlKTsKQEAgLTI5NzUsMzggKzI5NzYs
NDMgQEAKIAl9CiAgICAgfQogCi0gICAgLyogaWYgd2UgaGF2ZSBhIHNpbmdsZSByZWNpcGllbnQg
T1IgYXJlIHVzaW5nIHNpbmdsZS1pbnN0YW5jZSBzdG9yZSwKLSAgICAgKiBzcG9vbCB0byB0aGUg
c3RhZ2Ugb2YgdGhlIGZpcnN0IHJlY2lwaWVudAotICAgICAqLwotICAgIGlmIChtLT5yY3B0X251
bSA9PSAxIHx8IHNpbmdsZWluc3RhbmNlKSB7Ci0JRklMRSAqc3RhZ2VmOworICAgIGZmbHVzaChm
KTsKKyAgICBpZiAoZmVycm9yKGYpKSB7CisJcmV0dXJuIElNQVBfSU9FUlJPUjsKKyAgICB9CisK
KyAgICBpZiAoZnN0YXQoZmlsZW5vKGYpLCAmc2J1ZikgPT0gLTEpIHsKKwlyZXR1cm4gSU1BUF9J
T0VSUk9SOworICAgIH0KKworICAgIC8qIHNwb29sIHRvIHRoZSBzdGFnZSBvZiBvbmUgb2YgdGhl
IHJlY2lwaWVudHMgKi8KKyAgICBmb3IgKGkgPSAwOyAhc3RhZ2VmICYmIChpIDwgbS0+cmNwdF9u
dW0pOyBpKyspIHsKKwlzdGFnZWYgPSBhcHBlbmRfbmV3c3RhZ2UobS0+cmNwdFtpXSwgbm93LCAw
LCAmbS0+c3RhZ2UpOworICAgIH0KKworICAgIGlmIChzdGFnZWYpIHsKIAljb25zdCBjaGFyICpi
YXNlID0gMDsKIAl1bnNpZ25lZCBsb25nIHNpemUgPSAwOwogCWludCBuOwogCi0JZmZsdXNoKGYp
OwotCS8qIG1ha2Ugc3VyZSBldmVyeXRoaW5nIGlzIGhhcHB5IGJlZm9yZSB3ZSBzdGFydCAqLwot
CWlmICghZmVycm9yKGYpICYmICFmc3RhdChmaWxlbm8oZiksICZzYnVmKSAmJgotCSAgICAoc3Rh
Z2VmID0gYXBwZW5kX25ld3N0YWdlKG0tPnJjcHRbMF0sIG5vdywgJm0tPnN0YWdlKSkpIHsKLQot
CSAgICAvKiBjb3B5IHRoZSBoZWFkZXIgZnJvbSBvdXIgdG1wZmlsZSB0byB0aGUgc3RhZ2UgKi8K
LQkgICAgbWFwX3JlZnJlc2goZmlsZW5vKGYpLCAxLCAmYmFzZSwgJnNpemUsIHNidWYuc3Rfc2l6
ZSwgInRtcCIsIDApOwotCSAgICBuID0gcmV0cnlfd3JpdGUoZmlsZW5vKHN0YWdlZiksIGJhc2Us
IHNpemUpOwotCSAgICBtYXBfZnJlZSgmYmFzZSwgJnNpemUpOwotCi0JICAgIGlmIChuID09IC0x
KSB7Ci0JCS8qIGNsb3NlIGFuZCByZW1vdmUgdGhlIHN0YWdlICovCi0JCWZjbG9zZShzdGFnZWYp
OwotCQlhcHBlbmRfcmVtb3Zlc3RhZ2UobS0+c3RhZ2UpOwotCQltLT5zdGFnZSA9IE5VTEw7Ci0J
ICAgIH0KLQkgICAgZWxzZSB7Ci0JCS8qIGNsb3NlIHRoZSB0bXBmaWxlIGFuZCB1c2UgdGhlIHN0
YWdlICovCi0JCWZjbG9zZShmKTsKLQkJZiA9IHN0YWdlZjsKLQkgICAgfQorCS8qIGNvcHkgdGhl
IGhlYWRlciBmcm9tIG91ciB0bXBmaWxlIHRvIHRoZSBzdGFnZSAqLworCW1hcF9yZWZyZXNoKGZp
bGVubyhmKSwgMSwgJmJhc2UsICZzaXplLCBzYnVmLnN0X3NpemUsICJ0bXAiLCAwKTsKKwluID0g
cmV0cnlfd3JpdGUoZmlsZW5vKHN0YWdlZiksIGJhc2UsIHNpemUpOworCW1hcF9mcmVlKCZiYXNl
LCAmc2l6ZSk7CisKKwlpZiAobiA9PSAtMSkgeworCSAgICAvKiBjbG9zZSBhbmQgcmVtb3ZlIHRo
ZSBzdGFnZSAqLworCSAgICBmY2xvc2Uoc3RhZ2VmKTsKKwkgICAgYXBwZW5kX3JlbW92ZXN0YWdl
KG0tPnN0YWdlKTsKKwkgICAgcmV0dXJuIElNQVBfSU9FUlJPUjsKKwl9CisJZWxzZSB7CisJICAg
IC8qIGNsb3NlIHRoZSB0bXBmaWxlIGFuZCB1c2UgdGhlIHN0YWdlICovCisJICAgIGZjbG9zZShm
KTsKKwkgICAgZiA9IHN0YWdlZjsKIAl9CiAgICAgfQorICAgIC8qIGVsc2UgdGhpcyBpcyBwcm9i
YWJseSBhIHJlbW90ZSBncm91cCwgc28gdXNlIHRoZSB0bXBmaWxlICovCiAKICAgICByID0gc3Bv
b2xfY29weV9tc2cobm50cF9pbiwgZik7CiAKQEAgLTMxMTEsMTIgKzMxMTcsMTQgQEAKIAogCSAg
ICBpZiAoIXIpIHsKIAkJcHJvdF9yZXdpbmQobXNnLT5kYXRhKTsKLQkJaWYgKG1zZy0+c3RhZ2Up
Ci0JCSAgICByID0gYXBwZW5kX2Zyb21zdGFnZSgmYXMsIG1zZy0+ZGF0YSwgbXNnLT5zaXplLCBu
b3csCi0JCQkJCSAgKGNvbnN0IGNoYXIgKiopIE5VTEwsIDAsIG1zZy0+c3RhZ2UpOwotCQllbHNl
CisJCWlmIChtc2ctPnN0YWdlKSB7CisJCSAgICByID0gYXBwZW5kX2Zyb21zdGFnZSgmYXMsIG1z
Zy0+c3RhZ2UsIG5vdywKKwkJCQkJIChjb25zdCBjaGFyICoqKSBOVUxMLCAwLCAhc2luZ2xlaW5z
dGFuY2UpOworCQl9IGVsc2UgeworCQkgICAgLyogWFhYIHNob3VsZCBuZXZlciBnZXQgaGVyZSAq
LwogCQkgICAgciA9IGFwcGVuZF9mcm9tc3RyZWFtKCZhcywgbXNnLT5kYXRhLCBtc2ctPnNpemUs
IG5vdywKIAkJCQkJICAoY29uc3QgY2hhciAqKikgTlVMTCwgMCk7CisJCX0KIAkJaWYgKCFyKSBh
cHBlbmRfY29tbWl0KCZhcywgMCwgTlVMTCwgJnVpZCwgTlVMTCk7CiAJCWVsc2UgYXBwZW5kX2Fi
b3J0KCZhcyk7CiAJICAgIH0KSW5kZXg6IGltYXAvc2Vlbl9sb2NhbC5jCj09PT09PT09PT09PT09
PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KUkNT
IGZpbGU6IC9hZnMvYW5kcmV3L3N5c3RlbS9jdnMvc3JjL2N5cnVzL2ltYXAvc2Vlbl9sb2NhbC5j
LHYKcmV0cmlldmluZyByZXZpc2lvbiAxLjQxCnJldHJpZXZpbmcgcmV2aXNpb24gMS40MgpkaWZm
IC11IC11IC1yMS40MSAtcjEuNDIKLS0tIGltYXAvc2Vlbl9sb2NhbC5jCTIyIE9jdCAyMDAzIDE4
OjUwOjA4IC0wMDAwCTEuNDEKKysrIGltYXAvc2Vlbl9sb2NhbC5jCTIyIEphbiAyMDA0IDIxOjE3
OjEwIC0wMDAwCTEuNDIKQEAgLTEsNSArMSw1IEBACiAvKiBzZWVuX2xvY2FsLmMgLS0gU3RvcmFn
ZSBmb3IgL1JlY2VudCBhbmQgL1NlZW4gc3RhdGUgb24gbG9jYWwgZmlsZXN5c3RlbQotICogJElk
OiBzZWVuX2xvY2FsLmMsdiAxLjQxIDIwMDMvMTAvMjIgMTg6NTA6MDggcmpzMyBFeHAgJAorICog
JElkOiBzZWVuX2xvY2FsLmMsdiAxLjQyIDIwMDQvMDEvMjIgMjE6MTc6MTAga2VuMyBFeHAgJAog
ICogQ29weXJpZ2h0IChjKSAxOTk4LTIwMDMgQ2FybmVnaWUgTWVsbG9uIFVuaXZlcnNpdHkuICBB
bGwgcmlnaHRzIHJlc2VydmVkLgogICoKICAqIFJlZGlzdHJpYnV0aW9uIGFuZCB1c2UgaW4gc291
cmNlIGFuZCBiaW5hcnkgZm9ybXMsIHdpdGggb3Igd2l0aG91dApAQCAtNDQ1LDcgKzQ0NSw3IEBA
CiAgICAgc3RyY2F0KG9sZGZuYW1lLCBGTkFNRV9TRUVOKTsKICAgICBzdHJjcHkobmV3Zm5hbWUs
IG5ld21haWxib3gtPnBhdGgpOwogICAgIHN0cmNhdChuZXdmbmFtZSwgRk5BTUVfU0VFTik7Ci0g
ICAgcmV0dXJuIG1haWxib3hfY29weWZpbGUob2xkZm5hbWUsIG5ld2ZuYW1lKTsKKyAgICByZXR1
cm4gbWFpbGJveF9jb3B5ZmlsZShvbGRmbmFtZSwgbmV3Zm5hbWUsIDApOwogfQogCiAvKgo=
</data>        

          </attachment>
      

    </bug>

</bugzilla>